# 真實促銷標籤系統使用指南

## 概述

商品卡片的促銷標籤系統已經從硬編碼模式改為使用 Medusa 真實資料。系統現在會：

1. **優先使用 Medusa 促銷模組資料**：從真實的促銷活動中獲取折扣資訊
2. **自動回退機制**：當 API 不可用時，使用基於產品資料的本地計算
3. **智能標籤生成**：基於 metadata 和 tags 生成促銷標籤
4. **台灣化顯示**：正確顯示台灣慣用的折扣表示法（如 "8折"）

## 系統架構

### 1. 促銷標籤獲取流程

```
商品卡片 → getActivePromotionLabels() → Medusa API
                    ↓ (失敗時)
               getPromotionLabels() → 本地計算
                    ↓
               基於 metadata/tags/價格差異
```

### 2. 資料來源優先級

1. **Medusa 促銷模組**：從購物車測試獲取真實促銷折扣
2. **產品價格差異**：calculated_price vs original_price
3. **產品 metadata**：自定義促銷標籤設定
4. **產品 tags**：標籤形式的促銷分類

## 使用方法

### 1. 在 Medusa Admin 中設置促銷活動

```javascript
// 創建百分比折扣促銷
{
  code: 'PRODUCT20',
  application_method: {
    type: 'percentage',
    value: 20,
    currency_code: 'TWD'
  },
  is_automatic: true
}

// 創建固定金額折扣促銷
{
  code: 'SAVE50',
  application_method: {
    type: 'fixed',
    value: 50,
    currency_code: 'TWD'
  },
  is_automatic: false
}
```

### 2. 在產品 metadata 中設置促銷標籤

```javascript
// 產品 metadata 範例
{
  "is_new": "true",           // 新品標籤
  "is_hot": true,             // 熱銷標籤
  "is_limited": "true",       // 限量標籤
  "is_featured": true,        // 精選標籤
  "is_bestseller": "true",    // 暢銷標籤
  "has_flash_sale": true,     // 限時搶購
  "special_event": "新年特惠",  // 特殊活動文字
  "promotion": "限時特價",      // 自定義促銷文字
  "discount": "30% OFF"       // 手動折扣文字
}
```

### 3. 使用產品 tags 設置分類

```javascript
// 產品 tags 範例
[
  { value: "new" },         // 新品
  { value: "熱銷" },         // 熱銷（中文）
  { value: "featured" },    // 精選
  { value: "limited" },     // 限量
  { value: "bestseller" }   // 暢銷
]
```

## 標籤類型和優先級

### 標籤優先級（數字越小優先級越高）

1. `sold-out` (1) - 售完
2. `flash-sale` (2) - 限時搶購
3. `auto-discount` (3) - 自動計算折扣
4. `manual-discount` (4) - 手動設定折扣
5. `clearance` (5) - 清倉特價
6. `campaign` (6) - 促銷活動
7. `bundle` (7) - 組合優惠
8. `exclusive` (8) - 獨家
9. `limited` (9) - 限量
10. `promotion` (10) - 一般促銷

### 標籤樣式類別

- **折扣類**：`auto-discount`, `manual-discount` - 黑底白字
- **促銷類**：`sale`, `campaign`, `special-event` - 彩色背景
- **分類類**：`new`, `hot`, `featured` - 標準樣式
- **狀態類**：`sold-out`, `preorder` - 狀態指示

## 開發環境設定

### 環境變數

```bash
# .env.local
NEXT_PUBLIC_MEDUSA_BACKEND_URL=http://localhost:9000
NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY=pk_your_key_here

# 可選：啟用真實 API 模式（預設為 false）
NEXT_PUBLIC_USE_REAL_PROMOTION_API=true

# 調試模式（顯示詳細日誌）
NEXT_PUBLIC_DEBUG_PROMOTION_LABELS=true
```

### 測試腳本

```bash
# 創建測試促銷活動
cd backend
node scripts/create-test-promotions.js

# 測試促銷標籤功能
cd ..
node test-real-promotion-labels.js
```

## 故障排除

### 常見問題

1. **標籤不顯示**
   - 檢查 Medusa 後端是否運行
   - 確認產品有 metadata 或 tags
   - 查看瀏覽器 console 是否有錯誤

2. **折扣計算錯誤**
   - 確認產品變體有正確的 calculated_price
   - 檢查促銷活動是否正確設定
   - 驗證 region_id 是否正確

3. **API 連接失敗**
   - 系統會自動回退到本地計算
   - 檢查 API 代理設定
   - 確認 CORS 設定正確

### 調試資訊

啟用 `NEXT_PUBLIC_DEBUG_PROMOTION_LABELS=true` 可以在 console 看到：

```javascript
// 促銷標籤分析
【商品名稱】促銷標籤分析: {
  productTitle: "商品名稱",
  discountInfo: { hasDiscount: true, discountPercentage: 20 },
  stockStatus: { isSoldOut: false, canPreorder: false },
  metadata: { is_hot: "true", promotion: "限時特價" },
  generatedLabels: [...]
}
```

## 最佳實踐

1. **促銷活動管理**
   - 在 Medusa Admin 中統一管理促銷活動
   - 使用有意義的促銷代碼
   - 設定適當的開始和結束時間

2. **標籤設計**
   - 限制每個商品最多顯示 3 個標籤
   - 優先顯示最重要的促銷資訊
   - 使用一致的設計語言

3. **效能優化**
   - 系統會自動快取促銷資料
   - 避免過度頻繁的 API 調用
   - 使用適當的回退機制

## 更新日誌

### v2.0.0 - 真實資料整合
- ✅ 移除硬編碼假資料模式
- ✅ 整合 Medusa 促銷模組
- ✅ 新增智能回退機制
- ✅ 改善台灣化顯示
- ✅ 新增 metadata/tags 支持
- ✅ 優化標籤優先級排序
