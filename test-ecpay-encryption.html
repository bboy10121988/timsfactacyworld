<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECPay ç‰©æµåŠ å¯†æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ECPay ç‰©æµåŠ å¯†æ¸¬è©¦å·¥å…·</h1>
    
    <div class="container">
        <h2>æ¸¬è©¦é …ç›®</h2>
        <p>æ­¤å·¥å…·ç”¨æ–¼æ¸¬è©¦ ECPay ç‰©æµé›»å­åœ°åœ–çš„åŠ å¯†é©—è­‰åŠŸèƒ½ï¼Œç¢ºä¿å¯ä»¥æ­£ç¢ºç”Ÿæˆ CheckMacValueã€‚</p>
        
        <button class="button" onclick="testLogisticsMapAPI()">ğŸ—ºï¸ æ¸¬è©¦é›»å­åœ°åœ– API</button>
        <button class="button" onclick="testAllLogisticsTypes()">ğŸ“¦ æ¸¬è©¦æ‰€æœ‰ç‰©æµé¡å‹</button>
        <button class="button" onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
    </div>

    <div id="results"></div>

    <script>
        let testResults = [];

        function addResult(message, type = 'info') {
            const timestamp = new Date().toLocaleString('zh-TW');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = `[${timestamp}] ${message}`;
            
            const resultsContainer = document.getElementById('results');
            resultsContainer.appendChild(resultDiv);
            resultsContainer.scrollTop = resultsContainer.scrollHeight;
            
            testResults.push({ timestamp, message, type });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            addResult('æ¸¬è©¦çµæœå·²æ¸…é™¤', 'info');
        }

        async function testLogisticsMapAPI() {
            addResult('é–‹å§‹æ¸¬è©¦é›»å­åœ°åœ– API...', 'info');
            
            try {
                const testData = {
                    logisticsSubType: 'FAMI',
                    device: 0,
                    extraData: JSON.stringify({ 
                        test: true,
                        timestamp: Date.now() 
                    })
                };

                addResult(`ç™¼é€è«‹æ±‚åƒæ•¸: ${JSON.stringify(testData, null, 2)}`);

                const response = await fetch('http://localhost:9000/store/ecpay/logistics-map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_6a5b6f62e29baea8089628c7713ce56a388c5944011f43fcf15b8837b00464b7'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.json();
                
                if (result.success) {
                    addResult('âœ… API å‘¼å«æˆåŠŸï¼', 'success');
                    addResult(`å›æ‡‰è³‡æ–™: ${JSON.stringify(result, null, 2)}`);
                    
                    // æª¢æŸ¥æ˜¯å¦åŒ…å« CheckMacValue
                    if (result.params && result.params.CheckMacValue) {
                        addResult(`âœ… CheckMacValue å·²ç”Ÿæˆ: ${result.params.CheckMacValue}`, 'success');
                    } else {
                        addResult('âŒ ç¼ºå°‘ CheckMacValue', 'error');
                    }
                    
                    // æª¢æŸ¥å¿…è¦åƒæ•¸
                    const requiredParams = ['MerchantID', 'MerchantTradeNo', 'LogisticsType', 'LogisticsSubType'];
                    const missingParams = requiredParams.filter(param => !result.params[param]);
                    
                    if (missingParams.length === 0) {
                        addResult('âœ… æ‰€æœ‰å¿…è¦åƒæ•¸éƒ½å­˜åœ¨', 'success');
                    } else {
                        addResult(`âŒ ç¼ºå°‘å¿…è¦åƒæ•¸: ${missingParams.join(', ')}`, 'error');
                    }
                    
                } else {
                    addResult(`âŒ API å‘¼å«å¤±æ•—: ${result.message}`, 'error');
                    if (result.error) {
                        addResult(`éŒ¯èª¤è©³æƒ…: ${result.error}`, 'error');
                    }
                }
                
            } catch (error) {
                addResult(`âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testAllLogisticsTypes() {
            addResult('é–‹å§‹æ¸¬è©¦æ‰€æœ‰ç‰©æµé¡å‹...', 'info');
            
            const logisticsTypes = [
                { type: 'FAMI', name: 'å…¨å®¶' },
                { type: 'UNIMART', name: '7-ELEVEN' },
                { type: 'HILIFE', name: 'èŠçˆ¾å¯Œ' },
                { type: 'FAMIC2C', name: 'å…¨å®¶åº—åˆ°åº—' },
                { type: 'UNIMARTC2C', name: '7-ELEVENäº¤è²¨ä¾¿' },
                { type: 'HILIFEC2C', name: 'èŠçˆ¾å¯Œåº—åˆ°åº—' }
            ];

            for (const logistics of logisticsTypes) {
                addResult(`æ¸¬è©¦ ${logistics.name} (${logistics.type})...`);
                
                try {
                    const response = await fetch('http://localhost:9000/store/ecpay/logistics-map', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-publishable-api-key': 'pk_6a5b6f62e29baea8089628c7713ce56a388c5944011f43fcf15b8837b00464b7'
                        },
                        body: JSON.stringify({
                            logisticsSubType: logistics.type,
                            device: 0
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success && result.params && result.params.CheckMacValue) {
                        addResult(`âœ… ${logistics.name}: CheckMacValue ç”ŸæˆæˆåŠŸ`, 'success');
                    } else {
                        addResult(`âŒ ${logistics.name}: ${result.message || 'æ¸¬è©¦å¤±æ•—'}`, 'error');
                    }
                    
                } catch (error) {
                    addResult(`âŒ ${logistics.name}: ${error.message}`, 'error');
                }
                
                // é¿å…è«‹æ±‚éæ–¼é »ç¹
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            addResult('æ‰€æœ‰ç‰©æµé¡å‹æ¸¬è©¦å®Œæˆ', 'info');
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæ­¡è¿è¨Šæ¯
        window.addEventListener('load', () => {
            addResult('ECPay ç‰©æµåŠ å¯†æ¸¬è©¦å·¥å…·å·²è¼‰å…¥', 'info');
            addResult('è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦', 'info');
        });
    </script>
</body>
</html>
