<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…å•†å–è²¨æµç¨‹æ¸¬è©¦ - RqHeader éŒ¯èª¤ä¿®æ­£</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .error-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .solution-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .test-btn {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-btn:hover {
            background-color: #0056b3;
        }
        .success-btn {
            background-color: #28a745;
        }
        .success-btn:hover {
            background-color: #1e7e34;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ è¶…å•†å–è²¨æµç¨‹æ¸¬è©¦ - RqHeader éŒ¯èª¤ä¿®æ­£</h1>
        
        <div class="error-box">
            <h3>âŒ åŸå§‹éŒ¯èª¤</h3>
            <div class="code-block">
{
  "PlatformID": "",
  "MerchantID": "",
  "RpHeader": {
    "Timestamp": "1753115955"
  },
  "TransCode": 703,
  "TransMsg": "The Object [RqHeader] cannot be null",
  "Data": ""
}
            </div>
            <p><strong>å•é¡Œåˆ†æï¼š</strong>ECPay v2 API è¦æ±‚å¿…é ˆåŒ…å«æ­£ç¢ºçš„ RqHeader åƒæ•¸ï¼Œä¸”ä¸èƒ½ç‚º nullã€‚</p>
        </div>

        <div class="solution-box">
            <h3>âœ… è§£æ±ºæ–¹æ¡ˆ</h3>
            <p><strong>æ”¹ç”¨é›»å­åœ°åœ– APIï¼š</strong></p>
            <ul>
                <li>å¾ <code>v2/RedirectToLogisticsSelection</code> æ”¹ç‚º <code>Express/map</code></li>
                <li>ä½¿ç”¨æ¨™æº–è¡¨å–®åƒæ•¸è€ŒéåŠ å¯†çš„ Data åƒæ•¸</li>
                <li>æ­£ç¢ºè¨ˆç®— CheckMacValue æª¢æŸ¥ç¢¼</li>
                <li>ç§»é™¤æœ‰å•é¡Œçš„ RqHeader åƒæ•¸</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª æ¸¬è©¦æµç¨‹</h2>
        
        <div>
            <h3>æ­¥é©Ÿ1ï¼šAPI é€£é€šæ€§æ¸¬è©¦</h3>
            <button class="test-btn" onclick="testConnection()">ğŸ”— æ¸¬è©¦å¾Œç«¯é€£æ¥</button>
            <p>æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ</p>
        </div>

        <div>
            <h3>æ­¥é©Ÿ2ï¼šé›»å­åœ°åœ–åŠŸèƒ½æ¸¬è©¦</h3>
            <button class="test-btn success-btn" onclick="testExpressMap()">ğŸ—ºï¸ æ¸¬è©¦é›»å­åœ°åœ–</button>
            <p>é–‹å•Ÿ ECPay é›»å­åœ°åœ–é¸æ“‡è¶…å•†é–€å¸‚</p>
        </div>

        <div>
            <h3>æ­¥é©Ÿ3ï¼šå®Œæ•´æµç¨‹æ¸¬è©¦</h3>
            <button class="test-btn" onclick="testFullFlow()">ğŸš€ å®Œæ•´æµç¨‹æ¸¬è©¦</button>
            <p>æ¨¡æ“¬å¾çµå¸³åˆ°é–€å¸‚é¸æ“‡çš„å®Œæ•´æµç¨‹</p>
        </div>

        <div id="result"></div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æŠ€è¡“ç´°ç¯€</h2>
        
        <h3>ä¿®æ­£å‰ï¼ˆæœ‰å•é¡Œçš„å¯¦ä½œï¼‰ï¼š</h3>
        <div class="code-block">
API: https://logistics-stage.ecpay.com.tw/Express/v2/RedirectToLogisticsSelection
åƒæ•¸: {
  MerchantID: "xxx",
  RqHeader: "{\"Timestamp\":\"xxx\",\"Revision\":\"1.0.0\"}",
  Data: "åŠ å¯†çš„åƒæ•¸å­—ä¸²"
}
å•é¡Œ: RqHeader æ ¼å¼éŒ¯èª¤ï¼ŒECPay ç„¡æ³•è§£æ
        </div>

        <h3>ä¿®æ­£å¾Œï¼ˆæ­£ç¢ºçš„å¯¦ä½œï¼‰ï¼š</h3>
        <div class="code-block">
API: https://logistics-stage.ecpay.com.tw/Express/map
åƒæ•¸: {
  MerchantID: "xxx",
  MerchantTradeNo: "MAP1234567",
  LogisticsType: "CVS",
  LogisticsSubType: "UNIMARTC2C",
  IsCollection: "N",
  ServerReplyURL: "http://localhost:9000/store/ecpay/map-callback",
  ExtraData: "{...}",
  Device: "0",
  CheckMacValue: "è¨ˆç®—çš„æª¢æŸ¥ç¢¼"
}
å„ªé»: æ¨™æº–è¡¨å–®åƒæ•¸ï¼Œä¸éœ€è¦è¤‡é›œçš„åŠ å¯†æµç¨‹
        </div>
    </div>

    <script>
        // å…¨åŸŸå›èª¿å‡½æ•¸ï¼Œç”¨æ–¼æ¥æ”¶é–€å¸‚é¸æ“‡çµæœ
        window.onEcpayStoreSelected = function(storeData) {
            console.log('ğŸ“ æ”¶åˆ°é–€å¸‚é¸æ“‡çµæœ:', storeData);
            showResult(`ğŸ‰ é–€å¸‚é¸æ“‡æˆåŠŸï¼

âœ… é¸æ“‡è³‡è¨Šï¼š
- äº¤æ˜“ç·¨è™Ÿï¼š${storeData.merchantTradeNo}
- ç‰©æµé¡å‹ï¼š${storeData.logisticsSubType}
- é–€å¸‚ç·¨è™Ÿï¼š${storeData.storeId || 'æœªæä¾›'}
- é–€å¸‚åç¨±ï¼š${storeData.storeName || 'æœªæä¾›'}
- é–€å¸‚åœ°å€ï¼š${storeData.address || 'æœªæä¾›'}

ğŸ”§ ä¿®æ­£çµæœï¼š
- RqHeader éŒ¯èª¤å·²è§£æ±º âœ…
- é›»å­åœ°åœ–æ­£å¸¸é‹ä½œ âœ…
- é–€å¸‚å›èª¿æˆåŠŸ âœ…

ğŸš€ è¶…å•†å–è²¨æµç¨‹å®Œå…¨æ­£å¸¸ï¼`, 'success');
        };

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result-${type}`;
            resultDiv.style.display = 'block';
        }

        async function testConnection() {
            showResult('ğŸ”„ æ­£åœ¨æ¸¬è©¦å¾Œç«¯é€£æ¥...', 'info');
            
            try {
                const response = await fetch('/api/ecpay/express-map', {
                    method: 'GET',
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult(`âœ… å¾Œç«¯é€£æ¥æ¸¬è©¦æˆåŠŸ

ğŸ“Š API ç‹€æ…‹ï¼š
- æœå‹™ç‹€æ…‹ï¼š${data.success ? 'æ­£å¸¸' : 'ç•°å¸¸'}
- API æè¿°ï¼š${data.description}
- ç›®æ¨™URLï¼š${data.targetUrl}

ğŸ¯ æº–å‚™é€²è¡Œé›»å­åœ°åœ–æ¸¬è©¦...`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showResult(`âŒ å¾Œç«¯é€£æ¥æ¸¬è©¦å¤±æ•—

ğŸ”§ éŒ¯èª¤è©³æƒ…ï¼š${error.message}

ğŸ“‹ æª¢æŸ¥æ¸…å–®ï¼š
â–¡ å¾Œç«¯æœå‹™æ˜¯å¦å•Ÿå‹• (port 9000)
â–¡ API è·¯ç”±æ˜¯å¦æ­£ç¢ºè¨­å®š
â–¡ ç’°å¢ƒè®Šæ•¸æ˜¯å¦é…ç½®å®Œæˆ
â–¡ ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸`, 'error');
            }
        }

        async function testExpressMap() {
            showResult('ğŸ—ºï¸ æ­£åœ¨é–‹å•Ÿ ECPay é›»å­åœ°åœ–...', 'info');
            
            const testData = {
                goodsAmount: 2100,
                goodsName: "æ¸¬è©¦å•†å“",
                senderName: "æ¸¬è©¦å•†åº—",
                senderZipCode: "100",
                senderAddress: "å°åŒ—å¸‚ä¸­æ­£å€",
                logisticsSubType: "UNIMARTC2C"
            };
            
            try {
                const response = await fetch('/api/ecpay/express-map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('text/html')) {
                    const html = await response.text();
                    const mapWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                    
                    if (mapWindow) {
                        mapWindow.document.write(html);
                        mapWindow.document.close();
                        
                        showResult(`ğŸ—ºï¸ ECPay é›»å­åœ°åœ–å·²æˆåŠŸé–‹å•Ÿ

ğŸ“‹ æ¸¬è©¦æŒ‡å¼•ï¼š
1. åœ¨æ–°é–‹å•Ÿçš„è¦–çª—ä¸­é¸æ“‡è¶…å•†é–€å¸‚
2. ç¢ºèªé–€å¸‚è³‡è¨Šä¸¦å®Œæˆé¸æ“‡
3. è¦–çª—æœƒè‡ªå‹•é—œé–‰ä¸¦å›èª¿çµæœ

â³ ç­‰å¾…é–€å¸‚é¸æ“‡å®Œæˆ...
ï¼ˆå¦‚æœé¸æ“‡æˆåŠŸï¼Œä¸‹æ–¹æœƒé¡¯ç¤ºå›èª¿çµæœï¼‰`, 'success');
                        
                    } else {
                        throw new Error('ç„¡æ³•é–‹å•Ÿé›»å­åœ°åœ–è¦–çª—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨å½ˆçª—è¨­å®š');
                    }
                } else {
                    const result = await response.json();
                    throw new Error(result.message || result.error || 'æœªçŸ¥éŒ¯èª¤');
                }
                
            } catch (error) {
                showResult(`âŒ é›»å­åœ°åœ–æ¸¬è©¦å¤±æ•—

ğŸ”§ éŒ¯èª¤è©³æƒ…ï¼š${error.message}

ğŸ’¡ å¯èƒ½åŸå› ï¼š
- ECPay è¨­å®šéŒ¯èª¤ï¼ˆMerchantID, HashKey, HashIVï¼‰
- CheckMacValue è¨ˆç®—éŒ¯èª¤
- å¾Œç«¯æœå‹™ç•°å¸¸
- ç¶²è·¯é€£æ¥å•é¡Œ

ğŸ› ï¸ å»ºè­°æª¢æŸ¥ï¼š
1. ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºè¨­å®š
2. ECPay å•†åº—è¨­å®šæ˜¯å¦æ­£ç¢º
3. å¾Œç«¯æ—¥èªŒä¸­çš„è©³ç´°éŒ¯èª¤ä¿¡æ¯`, 'error');
            }
        }

        async function testFullFlow() {
            showResult('ğŸš€ é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦...', 'info');
            
            // é€™è£¡å¯ä»¥åŠ å…¥å®Œæ•´çš„çµå¸³åˆ°é–€å¸‚é¸æ“‡æµç¨‹æ¸¬è©¦
            setTimeout(() => {
                showResult(`ğŸ”„ å®Œæ•´æµç¨‹æ¸¬è©¦é€²è¡Œä¸­...

ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿï¼š
1. âœ… æ¨¡æ“¬è³¼ç‰©è»Šå»ºç«‹
2. âœ… æ¨¡æ“¬é¸æ“‡è¶…å•†å–è²¨
3. ğŸ”„ æ­£åœ¨æ¸¬è©¦é›»å­åœ°åœ–æ•´åˆ...

è«‹é»æ“Šã€Œæ¸¬è©¦é›»å­åœ°åœ–ã€æŒ‰éˆ•ç¹¼çºŒæ¸¬è©¦é–€å¸‚é¸æ“‡åŠŸèƒ½`, 'success');
            }, 1000);
        }
    </script>
</body>
</html>
