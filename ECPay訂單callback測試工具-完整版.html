<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECPay Callback æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success-btn {
            background-color: #28a745;
        }
        .success-btn:hover {
            background-color: #1e7e34;
        }
        .fail-btn {
            background-color: #dc3545;
        }
        .fail-btn:hover {
            background-color: #c82333;
        }
        #response {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            display: none;
        }
        .response-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .response-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .preset-buttons {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ECPay Callback æ¸¬è©¦å·¥å…·</h1>
        
        <div class="info">
            <strong>æ¸¬è©¦èªªæ˜ï¼š</strong><br>
            1. å…ˆå»ºç«‹æ¸¬è©¦è³¼ç‰©è»Šï¼ˆä½¿ç”¨æ‰‹å‹•å»ºç«‹è³¼ç‰©è»ŠåŠŸèƒ½ï¼‰<br>
            2. è¤‡è£½è³¼ç‰©è»Šçš„ MerchantTradeNo<br>
            3. åœ¨ä¸‹æ–¹è¼¸å…¥ MerchantTradeNo ä¸¦æ¸¬è©¦æˆåŠŸ/å¤±æ•—æƒ…å¢ƒ<br>
            4. æª¢æŸ¥ Console è¼¸å‡ºå’Œè³‡æ–™åº«è¨‚å–®ç‹€æ…‹
        </div>

        <div class="preset-buttons">
            <button onclick="createTestCart()" class="success-btn">ğŸ“ å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š</button>
            <button onclick="loadSuccessPreset()">ğŸ’° è¼‰å…¥æˆåŠŸä»˜æ¬¾è³‡æ–™</button>
            <button onclick="loadFailPreset()">âŒ è¼‰å…¥å¤±æ•—ä»˜æ¬¾è³‡æ–™</button>
        </div>

        <form id="callbackForm">
            <div class="form-group">
                <label for="merchantTradeNo">MerchantTradeNo (å•†åº—äº¤æ˜“ç·¨è™Ÿ):</label>
                <input type="text" id="merchantTradeNo" name="MerchantTradeNo" 
                       placeholder="ä¾‹å¦‚: test_cart_1753102937" required>
            </div>

            <div class="form-group">
                <label for="rtnCode">RtnCode (å›å‚³ç‹€æ…‹ç¢¼):</label>
                <select id="rtnCode" name="RtnCode">
                    <option value="1">1 - ä»˜æ¬¾æˆåŠŸ</option>
                    <option value="0">0 - ä»˜æ¬¾å¤±æ•—</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tradeNo">TradeNo (ç¶ ç•Œäº¤æ˜“ç·¨è™Ÿ):</label>
                <input type="text" id="tradeNo" name="TradeNo" 
                       placeholder="ä¾‹å¦‚: 2410281234567890">
            </div>

            <div class="form-group">
                <label for="tradeAmt">TradeAmt (äº¤æ˜“é‡‘é¡):</label>
                <input type="number" id="tradeAmt" name="TradeAmt" 
                       value="2100" placeholder="2100">
            </div>

            <div class="form-group">
                <label for="paymentDate">PaymentDate (ä»˜æ¬¾æ™‚é–“):</label>
                <input type="text" id="paymentDate" name="PaymentDate" 
                       placeholder="ä¾‹å¦‚: 2024/10/28 14:30:00">
            </div>

            <div class="form-group">
                <label for="paymentType">PaymentType (ä»˜æ¬¾æ–¹å¼):</label>
                <select id="paymentType" name="PaymentType">
                    <option value="Credit_CreditCard">Credit_CreditCard - ä¿¡ç”¨å¡</option>
                    <option value="ATM_LAND">ATM_LAND - ATMè½‰å¸³</option>
                    <option value="WebATM_LAND">WebATM_LAND - ç¶²è·¯ATM</option>
                </select>
            </div>

            <div class="form-group">
                <label for="checkMacValue">CheckMacValue (æª¢æŸ¥ç¢¼):</label>
                <input type="text" id="checkMacValue" name="CheckMacValue" 
                       value="TESTVALUE123" placeholder="TESTVALUE123">
            </div>

            <button type="submit">ğŸš€ ç™¼é€ Callback æ¸¬è©¦</button>
        </form>

        <div id="response"></div>
    </div>

    <script>
        // è¨­å®šç›®å‰æ™‚é–“
        document.getElementById('paymentDate').value = new Date().toLocaleString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }).replace(/\//g, '/').replace(',', '');

        // è¨­å®šéš¨æ©Ÿäº¤æ˜“ç·¨è™Ÿ
        document.getElementById('tradeNo').value = '24' + Date.now().toString().slice(-8);

        function createTestCart() {
            showResponse('æ­£åœ¨å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š...', 'info');
            
            const testCartData = {
                region_id: 'reg_01HJ2WNQMHQM0KJZV8DMGH9NW8',
                sales_channel_id: 'sc_01HJ2WNQK8KGE9VHGVHJ4KV7MS',
                currency_code: 'TWD',
                email: 'test@ecpay.com.tw',
                metadata: {
                    ecpay_merchant_trade_no: 'test_cart_' + Date.now(),
                    created_for_testing: true,
                    test_purpose: 'ecpay_callback_testing'
                }
            };

            fetch('/api/test/create-cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testCartData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showResponse(`âœ… æ¸¬è©¦è³¼ç‰©è»Šå»ºç«‹æˆåŠŸï¼\n\nè³¼ç‰©è»ŠID: ${data.cart.id}\nMerchantTradeNo: ${data.cart.metadata.ecpay_merchant_trade_no}`, 'success');
                    document.getElementById('merchantTradeNo').value = data.cart.metadata.ecpay_merchant_trade_no;
                } else {
                    showResponse(`âŒ å»ºç«‹å¤±æ•—: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showResponse(`âŒ è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            });
        }

        function loadSuccessPreset() {
            document.getElementById('rtnCode').value = '1';
            document.getElementById('tradeAmt').value = '2100';
            document.getElementById('paymentType').value = 'Credit_CreditCard';
            document.getElementById('tradeNo').value = '24' + Date.now().toString().slice(-8);
            showResponse('âœ… å·²è¼‰å…¥æˆåŠŸä»˜æ¬¾æ¸¬è©¦è³‡æ–™', 'info');
        }

        function loadFailPreset() {
            document.getElementById('rtnCode').value = '0';
            document.getElementById('tradeAmt').value = '2100';
            document.getElementById('paymentType').value = 'Credit_CreditCard';
            document.getElementById('tradeNo').value = '24' + Date.now().toString().slice(-8);
            showResponse('âŒ å·²è¼‰å…¥å¤±æ•—ä»˜æ¬¾æ¸¬è©¦è³‡æ–™', 'info');
        }

        function showResponse(message, type) {
            const responseDiv = document.getElementById('response');
            responseDiv.textContent = message;
            responseDiv.className = `response-${type}`;
            responseDiv.style.display = 'block';
        }

        document.getElementById('callbackForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            
            showResponse('æ­£åœ¨ç™¼é€ ECPay callback è«‹æ±‚...', 'info');
            
            // ä½¿ç”¨ application/x-www-form-urlencoded æ ¼å¼ï¼ˆECPay æ¨™æº–æ ¼å¼ï¼‰
            const params = new URLSearchParams(data);
            
            fetch('/api/store/ecpay/callback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params
            })
            .then(response => {
                const status = response.status;
                return response.text().then(text => ({ status, text }));
            })
            .then(({ status, text }) => {
                const timestamp = new Date().toLocaleString('zh-TW');
                let message = `[${timestamp}] Callback æ¸¬è©¦çµæœ:\n\n`;
                message += `HTTP Status: ${status}\n`;
                message += `Response: ${text}\n\n`;
                message += `æ¸¬è©¦è³‡æ–™:\n${JSON.stringify(data, null, 2)}`;
                
                if (status === 200 && text.includes('1|OK')) {
                    showResponse(message, 'success');
                } else {
                    showResponse(message, 'error');
                }
            })
            .catch(error => {
                showResponse(`âŒ è«‹æ±‚å¤±æ•—: ${error.message}`, 'error');
            });
        });
    </script>
</body>
</html>
