<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夥伴管理測試頁面</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">夥伴管理系統測試</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🔐 管理員認證測試</h2>
            <div class="space-y-4">
                <div class="flex gap-4">
                    <input type="email" id="adminEmail" placeholder="管理員郵箱" 
                           value="admin@timsfactory.com" class="border rounded px-3 py-2 flex-1">
                    <input type="password" id="adminPassword" placeholder="密碼" 
                           value="admin123" class="border rounded px-3 py-2 flex-1">
                    <button onclick="testAdminLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        測試登入
                    </button>
                </div>
                <div id="loginResult" class="text-sm"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">👥 夥伴列表測試</h2>
            <div class="space-y-4">
                <button onclick="testPartnersList()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    載入夥伴列表
                </button>
                <div id="partnersResult" class="text-sm"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">📊 統計數據測試</h2>
            <div class="space-y-4">
                <button onclick="testStats()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    載入統計數據
                </button>
                <div id="statsResult" class="text-sm"></div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:9000';
        let adminToken = null;

        async function makeRequest(endpoint, options = {}) {
            const url = `${BACKEND_URL}${endpoint}`;
            
            const defaultHeaders = {
                'Content-Type': 'application/json',
                ...(adminToken && { 'Authorization': `Bearer ${adminToken}` })
            };

            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    }
                });

                const data = await response.json();
                return { status: response.status, data, success: response.ok };
            } catch (error) {
                return { status: 0, error: error.message, success: false };
            }
        }

        async function testAdminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const resultDiv = document.getElementById('loginResult');
            
            resultDiv.innerHTML = '⏳ 測試中...';
            
            const result = await makeRequest('/admin-auth', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            
            if (result.success && result.data.success) {
                adminToken = result.data.data.token;
                resultDiv.innerHTML = `✅ 登入成功！Token 長度: ${adminToken.length}`;
                resultDiv.className = 'text-sm text-green-600 bg-green-50 p-3 rounded';
            } else {
                resultDiv.innerHTML = `❌ 登入失敗: ${result.data?.error || result.error || '未知錯誤'}`;
                resultDiv.className = 'text-sm text-red-600 bg-red-50 p-3 rounded';
            }
        }

        async function testPartnersList() {
            const resultDiv = document.getElementById('partnersResult');
            
            resultDiv.innerHTML = '⏳ 載入中...';
            
            const result = await makeRequest('/affiliate-admin/partners');
            
            if (result.success && result.data.success) {
                const partners = result.data.data.partners || [];
                resultDiv.innerHTML = `
                    ✅ 成功載入 ${partners.length} 位夥伴
                    <br><strong>總計:</strong> ${result.data.data.total}
                    <br><strong>已批准:</strong> ${partners.filter(p => p.status === 'approved').length}
                    <br><strong>待審核:</strong> ${partners.filter(p => p.status === 'pending').length}
                    ${partners.length > 0 ? `<br><strong>範例:</strong> ${partners[0].name} (${partners[0].email}) - ${partners[0].status}` : ''}
                `;
                resultDiv.className = 'text-sm text-green-600 bg-green-50 p-3 rounded';
            } else {
                resultDiv.innerHTML = `❌ 載入失敗: ${result.data?.error || result.error || '未知錯誤'}`;
                resultDiv.className = 'text-sm text-red-600 bg-red-50 p-3 rounded';
            }
        }

        async function testStats() {
            const resultDiv = document.getElementById('statsResult');
            
            if (!adminToken) {
                resultDiv.innerHTML = '❌ 請先登入管理員帳號';
                resultDiv.className = 'text-sm text-red-600 bg-red-50 p-3 rounded';
                return;
            }
            
            resultDiv.innerHTML = '⏳ 載入中...';
            
            const result = await makeRequest('/admin/affiliate/stats');
            
            if (result.success && result.data.success) {
                const stats = result.data.data;
                resultDiv.innerHTML = `
                    ✅ 統計數據載入成功
                    <br><strong>夥伴總數:</strong> ${stats.partners?.total || 0}
                    <br><strong>轉換次數:</strong> ${stats.performance?.totalConversions || 0}
                    <br><strong>總佣金:</strong> ${stats.performance?.totalCommissions || 0}
                `;
                resultDiv.className = 'text-sm text-green-600 bg-green-50 p-3 rounded';
            } else {
                resultDiv.innerHTML = `❌ 載入失敗: ${result.data?.error || result.error || '未知錯誤'}`;
                resultDiv.className = 'text-sm text-red-600 bg-red-50 p-3 rounded';
            }
        }
    </script>
</body>
</html>
