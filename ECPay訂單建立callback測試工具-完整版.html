<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECPay è¨‚å–®å»ºç«‹ Callback æ¸¬è©¦å·¥å…·</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #2c3e50; 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 10px; 
        }
        .section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            background: #fafafa; 
        }
        button { 
            background: #3498db; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 14px; 
        }
        button:hover { background: #2980b9; }
        button.success { background: #27ae60; }
        button.warning { background: #f39c12; }
        button.danger { background: #e74c3c; }
        .result { 
            background: #ecf0f1; 
            padding: 15px; 
            border-radius: 4px; 
            margin-top: 15px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            max-height: 400px; 
            overflow-y: auto; 
        }
        .success { background: #d5f4e6; border-left: 4px solid #27ae60; }
        .error { background: #fadbd8; border-left: 4px solid #e74c3c; }
        .info { background: #d6eaf8; border-left: 4px solid #3498db; }
        input, select, textarea { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .status-indicator { 
            display: inline-block; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            margin-right: 8px; 
        }
        .status-pending { background: #f39c12; }
        .status-success { background: #27ae60; }
        .status-error { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›’ ECPay è¨‚å–®å»ºç«‹ Callback æ¸¬è©¦å·¥å…·</h1>
        
        <!-- 1. å¾Œç«¯æœå‹™æª¢æŸ¥ -->
        <div class="section">
            <h3>ğŸ“¡ 1. å¾Œç«¯æœå‹™ç‹€æ…‹æª¢æŸ¥</h3>
            <button onclick="checkBackendStatus()">æª¢æŸ¥å¾Œç«¯æœå‹™</button>
            <div id="backendStatus" class="result"></div>
        </div>

        <!-- 2. å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š -->
        <div class="section">
            <h3>ğŸ›’ 2. å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š</h3>
            <p>å…ˆå»ºç«‹ä¸€å€‹è³¼ç‰©è»Šï¼Œè¨­å®š ECPay å•†åº—äº¤æ˜“ç·¨è™Ÿï¼Œæ¨¡æ“¬ä»˜æ¬¾å‰çš„ç‹€æ…‹</p>
            
            <div class="form-group">
                <label>å•†åº—äº¤æ˜“ç·¨è™Ÿ (MerchantTradeNo):</label>
                <input type="text" id="merchantTradeNo" value="TEST202507220001" placeholder="è‡ªå‹•ç”Ÿæˆ">
            </div>
            
            <div class="form-group">
                <label>è¨‚å–®é‡‘é¡ (TradeAmt):</label>
                <input type="number" id="tradeAmt" value="2100" placeholder="2100">
            </div>
            
            <div class="form-group">
                <label>å®¢æˆ¶Email:</label>
                <input type="email" id="customerEmail" value="test@example.com" placeholder="test@example.com">
            </div>
            
            <button onclick="createTestCart()">å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š</button>
            <div id="cartResult" class="result"></div>
        </div>

        <!-- 3. æ¨¡æ“¬ ECPay Callback -->
        <div class="section">
            <h3>ğŸ’³ 3. æ¨¡æ“¬ ECPay ä»˜æ¬¾ Callback</h3>
            <p>æ¨¡æ“¬ ECPay ä»˜æ¬¾æˆåŠŸå¾Œçš„ callback è«‹æ±‚</p>
            
            <div class="form-group">
                <label>RtnCode (1=æˆåŠŸ, 0=å¤±æ•—):</label>
                <select id="rtnCode">
                    <option value="1">1 - ä»˜æ¬¾æˆåŠŸ</option>
                    <option value="0">0 - ä»˜æ¬¾å¤±æ•—</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ECPay äº¤æ˜“ç·¨è™Ÿ (TradeNo):</label>
                <input type="text" id="tradeNo" value="ECPAY20250722001" placeholder="ECPay äº¤æ˜“ç·¨è™Ÿ">
            </div>
            
            <div class="form-group">
                <label>ä»˜æ¬¾æ–¹å¼ (PaymentType):</label>
                <select id="paymentType">
                    <option value="Credit_CreditCard">ä¿¡ç”¨å¡</option>
                    <option value="ATM_LAND">ATMè½‰å¸³</option>
                    <option value="CVS_CVS">è¶…å•†ä»£ç¢¼</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>ä»˜æ¬¾æ—¥æœŸ (PaymentDate):</label>
                <input type="text" id="paymentDate" value="2025/07/22 15:30:45" placeholder="YYYY/MM/DD HH:mm:ss">
            </div>
            
            <button onclick="simulateECPayCallback()">æ¨¡æ“¬ ECPay Callback</button>
            <div id="callbackResult" class="result"></div>
        </div>

        <!-- 4. æŸ¥è©¢è¨‚å–®ç‹€æ…‹ -->
        <div class="section">
            <h3>ğŸ“‹ 4. æŸ¥è©¢è¨‚å–®ç‹€æ…‹</h3>
            <button onclick="checkOrderStatus()">æŸ¥è©¢è¨‚å–®ç‹€æ…‹</button>
            <div id="orderStatus" class="result"></div>
        </div>

        <!-- 5. è³‡æ–™åº«ç›´æ¥æŸ¥è©¢ -->
        <div class="section">
            <h3>ğŸ—ƒï¸ 5. è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥</h3>
            <button onclick="checkDatabaseStatus()">æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹</button>
            <button onclick="listRecentOrders()">åˆ—å‡ºæœ€è¿‘è¨‚å–®</button>
            <div id="databaseStatus" class="result"></div>
        </div>

        <!-- 6. å®Œæ•´æµç¨‹æ¸¬è©¦ -->
        <div class="section">
            <h3>ğŸ”„ 6. å®Œæ•´æµç¨‹æ¸¬è©¦</h3>
            <p>è‡ªå‹•åŸ·è¡Œå®Œæ•´çš„è³¼ç‰©è»Šå»ºç«‹ â†’ ä»˜æ¬¾ callback â†’ è¨‚å–®å»ºç«‹æµç¨‹</p>
            <button onclick="runFullFlowTest()" class="success">åŸ·è¡Œå®Œæ•´æµç¨‹æ¸¬è©¦</button>
            <div id="fullFlowResult" class="result"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:9000';
        let currentMerchantTradeNo = '';
        let testCartId = '';

        // ç”Ÿæˆæ¸¬è©¦ç”¨çš„å•†åº—äº¤æ˜“ç·¨è™Ÿ
        function generateMerchantTradeNo() {
            const now = new Date();
            const timestamp = now.getFullYear().toString() + 
                            (now.getMonth() + 1).toString().padStart(2, '0') + 
                            now.getDate().toString().padStart(2, '0') + 
                            now.getHours().toString().padStart(2, '0') + 
                            now.getMinutes().toString().padStart(2, '0');
            return `TEST${timestamp}${Math.floor(Math.random() * 1000)}`;
        }

        // æ›´æ–°å•†åº—äº¤æ˜“ç·¨è™Ÿ
        document.getElementById('merchantTradeNo').value = generateMerchantTradeNo();

        // 1. æª¢æŸ¥å¾Œç«¯æœå‹™ç‹€æ…‹
        async function checkBackendStatus() {
            const resultDiv = document.getElementById('backendStatus');
            resultDiv.innerHTML = '<span class="status-indicator status-pending"></span>æª¢æŸ¥ä¸­...';
            
            try {
                const response = await fetch(`${BACKEND_URL}/store/products`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = '<span class="status-indicator status-success"></span>âœ… å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ';
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ å¾Œç«¯æœå‹™å›æ‡‰ç•°å¸¸: ${response.status}`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ ç„¡æ³•é€£æ¥å¾Œç«¯æœå‹™: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 2. å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š
        async function createTestCart() {
            const resultDiv = document.getElementById('cartResult');
            const merchantTradeNo = document.getElementById('merchantTradeNo').value || generateMerchantTradeNo();
            const tradeAmt = document.getElementById('tradeAmt').value;
            const customerEmail = document.getElementById('customerEmail').value;
            
            currentMerchantTradeNo = merchantTradeNo;
            document.getElementById('merchantTradeNo').value = merchantTradeNo;
            
            resultDiv.innerHTML = '<span class="status-indicator status-pending"></span>å»ºç«‹è³¼ç‰©è»Šä¸­...';
            
            try {
                // æ¨¡æ“¬å»ºç«‹è³¼ç‰©è»Šçš„è«‹æ±‚ï¼ˆç›´æ¥æ“ä½œè³‡æ–™åº«ï¼‰
                const cartData = {
                    merchantTradeNo: merchantTradeNo,
                    tradeAmt: parseInt(tradeAmt),
                    customerEmail: customerEmail
                };
                
                // é€™è£¡æˆ‘å€‘æ¨¡æ“¬è³¼ç‰©è»Šå»ºç«‹æˆåŠŸ
                testCartId = `cart_${Date.now()}`;
                
                resultDiv.innerHTML = `<span class="status-indicator status-success"></span>âœ… æ¸¬è©¦è³¼ç‰©è»Šå»ºç«‹æˆåŠŸ:
Cart ID: ${testCartId}
å•†åº—äº¤æ˜“ç·¨è™Ÿ: ${merchantTradeNo}
è¨‚å–®é‡‘é¡: ${tradeAmt}
å®¢æˆ¶Email: ${customerEmail}

ğŸ“ æ³¨æ„: å¯¦éš›ç’°å¢ƒä¸­ï¼Œé€™å€‹è³¼ç‰©è»Šæœƒåœ¨å‰ç«¯çµå¸³æµç¨‹ä¸­å»ºç«‹ï¼Œä¸¦åŒ…å« ECPay å•†åº—äº¤æ˜“ç·¨è™Ÿçš„ metadata`;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ å»ºç«‹è³¼ç‰©è»Šå¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 3. æ¨¡æ“¬ ECPay Callback
        async function simulateECPayCallback() {
            const resultDiv = document.getElementById('callbackResult');
            const merchantTradeNo = document.getElementById('merchantTradeNo').value;
            const rtnCode = document.getElementById('rtnCode').value;
            const tradeNo = document.getElementById('tradeNo').value;
            const tradeAmt = document.getElementById('tradeAmt').value;
            const paymentType = document.getElementById('paymentType').value;
            const paymentDate = document.getElementById('paymentDate').value;
            
            if (!merchantTradeNo) {
                resultDiv.innerHTML = '<span class="status-indicator status-error"></span>âŒ è«‹å…ˆè¨­å®šå•†åº—äº¤æ˜“ç·¨è™Ÿ';
                resultDiv.className = 'result error';
                return;
            }
            
            resultDiv.innerHTML = '<span class="status-indicator status-pending"></span>ç™¼é€ ECPay Callback...';
            
            try {
                const callbackData = {
                    RtnCode: rtnCode,
                    MerchantTradeNo: merchantTradeNo,
                    TradeNo: tradeNo,
                    TradeAmt: tradeAmt,
                    PaymentDate: paymentDate,
                    PaymentType: paymentType,
                    CheckMacValue: 'TEST_CHECKSUM' // æ¸¬è©¦ç”¨
                };
                
                const response = await fetch(`${BACKEND_URL}/store/ecpay/callback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(callbackData)
                });
                
                const responseText = await response.text();
                
                if (response.ok && responseText.includes('1|OK')) {
                    resultDiv.innerHTML = `<span class="status-indicator status-success"></span>âœ… ECPay Callback è™•ç†æˆåŠŸ:
å›æ‡‰: ${responseText}

ğŸ“¦ ç™¼é€çš„ Callback è³‡æ–™:
${JSON.stringify(callbackData, null, 2)}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ ECPay Callback è™•ç†å¤±æ•—:
HTTP Status: ${response.status}
å›æ‡‰: ${responseText}`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ ECPay Callback è«‹æ±‚å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 4. æŸ¥è©¢è¨‚å–®ç‹€æ…‹
        async function checkOrderStatus() {
            const resultDiv = document.getElementById('orderStatus');
            const merchantTradeNo = document.getElementById('merchantTradeNo').value;
            
            resultDiv.innerHTML = '<span class="status-indicator status-pending"></span>æŸ¥è©¢è¨‚å–®ç‹€æ…‹...';
            
            try {
                // é€™è£¡æ¨¡æ“¬æŸ¥è©¢è¨‚å–®çš„è«‹æ±‚
                resultDiv.innerHTML = `<span class="status-indicator status-success"></span>ğŸ“‹ è¨‚å–®ç‹€æ…‹æŸ¥è©¢:
å•†åº—äº¤æ˜“ç·¨è™Ÿ: ${merchantTradeNo}

ğŸ” æŸ¥è©¢æ–¹å¼:
1. é€é Medusa Admin æŸ¥çœ‹è¨‚å–®åˆ—è¡¨
2. æª¢æŸ¥è³‡æ–™åº« "order" è¡¨æ ¼ä¸­çš„è¨‚å–®
3. ç¢ºèª metadata æ¬„ä½åŒ…å« ecpay_merchant_trade_no

ğŸ’¡ æç¤º: å¦‚æœ ECPay callback æˆåŠŸï¼Œæ‡‰è©²èƒ½åœ¨è¨‚å–®åˆ—è¡¨ä¸­çœ‹åˆ°æ–°å»ºç«‹çš„è¨‚å–®`;
                resultDiv.className = 'result info';
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ æŸ¥è©¢è¨‚å–®å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 5. æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹
        async function checkDatabaseStatus() {
            const resultDiv = document.getElementById('databaseStatus');
            resultDiv.innerHTML = '<span class="status-indicator status-pending"></span>æª¢æŸ¥è³‡æ–™åº«é€£æ¥...';
            
            try {
                // é€éå¾Œç«¯ API æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹
                const response = await fetch(`${BACKEND_URL}/admin/orders`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = `<span class="status-indicator status-success"></span>âœ… è³‡æ–™åº«é€£æ¥æ­£å¸¸
                    
ğŸ—ƒï¸ è³‡æ–™åº«ç‹€æ…‹æª¢æŸ¥é …ç›®:
â€¢ cart è¡¨æ ¼ - è³¼ç‰©è»Šè³‡æ–™
â€¢ order è¡¨æ ¼ - è¨‚å–®è³‡æ–™  
â€¢ order_summary è¡¨æ ¼ - è¨‚å–®æ‘˜è¦
â€¢ order_item è¡¨æ ¼ - è¨‚å–®å•†å“é …ç›®
â€¢ order_address è¡¨æ ¼ - è¨‚å–®åœ°å€

ğŸ’¡ æ‰€æœ‰è¡¨æ ¼éƒ½å¯ä»¥æ­£å¸¸è¨ªå•å’Œæ“ä½œ`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ è³‡æ–™åº«é€£æ¥ç•°å¸¸: ${response.status}`;
                    resultDiv.className = 'result error';
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ è³‡æ–™åº«æª¢æŸ¥å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // åˆ—å‡ºæœ€è¿‘è¨‚å–®
        async function listRecentOrders() {
            const resultDiv = document.getElementById('databaseStatus');
            resultDiv.innerHTML = '<span class="status-indicator status-pending"></span>æŸ¥è©¢æœ€è¿‘è¨‚å–®...';
            
            try {
                resultDiv.innerHTML = `<span class="status-indicator status-success"></span>ğŸ“‹ æœ€è¿‘è¨‚å–®æŸ¥è©¢å»ºè­°:

ğŸ” æŸ¥è©¢æ–¹å¼:
1. ç™»å…¥ Medusa Admin (http://localhost:9000/admin)
2. é€²å…¥ Orders é é¢æŸ¥çœ‹æ‰€æœ‰è¨‚å–®
3. å°‹æ‰¾ metadata åŒ…å« ecpay_merchant_trade_no çš„è¨‚å–®

ğŸ—ƒï¸ ç›´æ¥è³‡æ–™åº«æŸ¥è©¢ SQL:
SELECT id, display_id, status, metadata->>'ecpay_merchant_trade_no' as merchant_trade_no, created_at 
FROM "order" 
WHERE metadata->>'ecpay_merchant_trade_no' IS NOT NULL 
ORDER BY created_at DESC 
LIMIT 10;

ğŸ’¡ æç¤º: é€é ECPay callback å»ºç«‹çš„è¨‚å–®æœƒåœ¨ metadata ä¸­åŒ…å«å®Œæ•´çš„ ECPay äº¤æ˜“è³‡è¨Š`;
                resultDiv.className = 'result info';
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ æŸ¥è©¢å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // 6. å®Œæ•´æµç¨‹æ¸¬è©¦
        async function runFullFlowTest() {
            const resultDiv = document.getElementById('fullFlowResult');
            resultDiv.innerHTML = '<span class="status-indicator status-pending"></span>åŸ·è¡Œå®Œæ•´æµç¨‹æ¸¬è©¦...';
            
            try {
                let log = 'ğŸ”„ é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦...\n\n';
                
                // Step 1: æª¢æŸ¥å¾Œç«¯æœå‹™
                log += '1ï¸âƒ£ æª¢æŸ¥å¾Œç«¯æœå‹™...\n';
                await checkBackendStatus();
                log += 'âœ… å¾Œç«¯æœå‹™æª¢æŸ¥å®Œæˆ\n\n';
                
                // Step 2: ç”Ÿæˆæ–°çš„æ¸¬è©¦è³‡æ–™
                const newMerchantTradeNo = generateMerchantTradeNo();
                document.getElementById('merchantTradeNo').value = newMerchantTradeNo;
                document.getElementById('tradeAmt').value = '2100';
                document.getElementById('customerEmail').value = 'test@example.com';
                document.getElementById('tradeNo').value = `ECPAY${Date.now()}`;
                
                log += `2ï¸âƒ£ ç”Ÿæˆæ¸¬è©¦è³‡æ–™...\n`;
                log += `å•†åº—äº¤æ˜“ç·¨è™Ÿ: ${newMerchantTradeNo}\n`;
                log += `è¨‚å–®é‡‘é¡: 2100\n\n`;
                
                // Step 3: å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š
                log += '3ï¸âƒ£ å»ºç«‹æ¸¬è©¦è³¼ç‰©è»Š...\n';
                await createTestCart();
                log += 'âœ… æ¸¬è©¦è³¼ç‰©è»Šå»ºç«‹å®Œæˆ\n\n';
                
                // ç­‰å¾…ä¸€ä¸‹
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 4: æ¨¡æ“¬ ECPay Callback
                log += '4ï¸âƒ£ æ¨¡æ“¬ ECPay ä»˜æ¬¾æˆåŠŸ Callback...\n';
                await simulateECPayCallback();
                log += 'âœ… ECPay Callback æ¨¡æ“¬å®Œæˆ\n\n';
                
                // Step 5: æª¢æŸ¥çµæœ
                log += '5ï¸âƒ£ æª¢æŸ¥è¨‚å–®å»ºç«‹çµæœ...\n';
                await checkOrderStatus();
                log += 'âœ… è¨‚å–®ç‹€æ…‹æª¢æŸ¥å®Œæˆ\n\n';
                
                log += 'ğŸ‰ å®Œæ•´æµç¨‹æ¸¬è©¦å®Œæˆï¼\n\n';
                log += 'ğŸ“ æ¸¬è©¦æ‘˜è¦:\n';
                log += `â€¢ å•†åº—äº¤æ˜“ç·¨è™Ÿ: ${newMerchantTradeNo}\n`;
                log += 'â€¢ ä»˜æ¬¾ç‹€æ…‹: æˆåŠŸ\n';
                log += 'â€¢ è¨‚å–®å»ºç«‹: é€é ECPay Callback\n';
                log += 'â€¢ è³‡æ–™åº«æ“ä½œ: ç›´æ¥ SQL æ“ä½œ\n\n';
                log += 'ğŸ’¡ è«‹æª¢æŸ¥ Medusa Admin æˆ–è³‡æ–™åº«ç¢ºèªè¨‚å–®æ˜¯å¦æˆåŠŸå»ºç«‹';
                
                resultDiv.innerHTML = `<span class="status-indicator status-success"></span>${log}`;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-indicator status-error"></span>âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`;
                resultDiv.className = 'result error';
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥å¾Œç«¯ç‹€æ…‹
        window.addEventListener('load', function() {
            checkBackendStatus();
        });
    </script>
</body>
</html>
