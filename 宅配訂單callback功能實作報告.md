# å®…é…è¨‚å–® Callback åŠŸèƒ½å¯¦ä½œå ±å‘Š

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°
ç•¶å®¢æˆ¶å®Œæˆå®…é…è¨‚å–®æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼é€ä¸€å€‹ HTTP callback åˆ°æŒ‡å®šçš„ç«¯é» `http://localhost:9000/app/orders`ï¼Œé€šçŸ¥å¤–éƒ¨ç³»çµ±æœ‰æ–°çš„å®…é…è¨‚å–®éœ€è¦è™•ç†ã€‚

## ğŸ”§ æŠ€è¡“å¯¦ä½œ

### 1. ä¿®æ”¹è¨‚å–®å®Œæˆé‚è¼¯
**æª”æ¡ˆ**: `/backend/src/api/store/carts/[id]/complete/route.ts`

**æ–°å¢åŠŸèƒ½**:
- è‡ªå‹•åµæ¸¬å®…é…é…é€æ–¹å¼
- çµ„è£å®Œæ•´çš„è¨‚å–®è³‡æ–™
- ç™¼é€éåŒæ­¥ HTTP callback
- éŒ¯èª¤è™•ç†ä¸å½±éŸ¿ä¸»æµç¨‹

**è§¸ç™¼æ¢ä»¶**:
```typescript
const isHomeDelivery = shippingMethod?.name?.includes('å®…é…') || 
                      shippingMethod?.name?.toLowerCase().includes('home') ||
                      (cart.metadata && (cart.metadata as any).shipping_type === 'home_delivery')
```

### 2. å‰µå»º Callback æ¥æ”¶ç«¯é»
**æª”æ¡ˆ**: `/backend/src/api/app/orders/route.ts`

**åŠŸèƒ½**:
- æ¥æ”¶å®…é…è¨‚å–® callback è³‡æ–™
- é©—è­‰å¿…è¦æ¬„ä½
- è¨˜éŒ„è¨‚å–®è™•ç†æ—¥èªŒ
- æä¾› API æ–‡æª”

## ğŸ“‹ Callback è³‡æ–™çµæ§‹

```typescript
interface HomeDeliveryOrderCallback {
  order_id: string              // è¨‚å–®ç·¨è™Ÿ
  cart_id: string               // è³¼ç‰©è»Šç·¨è™Ÿ
  status: string                // è¨‚å–®ç‹€æ…‹
  payment_status: string        // ä»˜æ¬¾ç‹€æ…‹
  fulfillment_status: string    // å±¥è¡Œç‹€æ…‹
  total: number                 // ç¸½é‡‘é¡
  currency_code: string         // å¹£åˆ¥
  email: string                 // å®¢æˆ¶ Email
  customer_id?: string          // å®¢æˆ¶ç·¨è™Ÿ
  shipping_address: object      // é…é€åœ°å€
  billing_address?: object      // å¸³å–®åœ°å€
  items: array                  // è¨‚å–®å•†å“æ¸…å–®
  shipping_method: string       // é…é€æ–¹å¼
  created_at: string            // å»ºç«‹æ™‚é–“
  metadata?: object             // é¡å¤–è³‡æ–™
  callback_type: string         // Callback é¡å‹æ¨™è­˜
}
```

## ğŸš€ éƒ¨ç½²é…ç½®

### ç’°å¢ƒè®Šæ•¸
åœ¨ `.env` æª”æ¡ˆä¸­å¯è¨­å®š callback URLï¼š
```bash
# å®…é…è¨‚å–® callback URLï¼ˆå¯é¸ï¼Œé è¨­ç‚º http://localhost:9000/app/ordersï¼‰
HOME_DELIVERY_CALLBACK_URL=http://localhost:9000/app/orders
```

### CORS è¨­å®š
ç¢ºä¿ callback æ¥æ”¶ç«¯é»å…è¨±ä¾†è‡ª Medusa å¾Œç«¯çš„è«‹æ±‚ã€‚

## ğŸ“Š æ¸¬è©¦é©—è­‰

### 1. ä½¿ç”¨æ¸¬è©¦å·¥å…·
é–‹å•Ÿ `å®…é…è¨‚å–®callbackæ¸¬è©¦å·¥å…·.html` é€²è¡Œæ¸¬è©¦ï¼š
- æ¸¬è©¦ callback æ¥æ”¶ç«¯é»
- æ¨¡æ“¬å®…é…è¨‚å–®å®Œæˆ
- å®Œæ•´æµç¨‹æ¸¬è©¦

### 2. æ‰‹å‹•æ¸¬è©¦
1. åœ¨å‰ç«¯å®Œæˆä¸€å€‹å®…é…è¨‚å–®
2. æª¢æŸ¥å¾Œç«¯æ§åˆ¶å°æ—¥èªŒ
3. ç¢ºèª callback æ˜¯å¦æˆåŠŸç™¼é€

### 3. ç›£æ§ Callback
æŸ¥çœ‹å¾Œç«¯æ—¥èªŒé—œéµå­—ï¼š
```bash
ğŸšš Detected home delivery order, sending callback...
âœ… Home delivery callback sent successfully
âš ï¸ Home delivery callback failed
```

## ğŸ”„ å·¥ä½œæµç¨‹

```
1. å®¢æˆ¶å®Œæˆçµå¸³ (å®…é…)
   â†“
2. ç³»çµ±åµæ¸¬é…é€æ–¹å¼
   â†“  
3. å‰µå»ºè¨‚å–®æˆåŠŸ
   â†“
4. è‡ªå‹•ç™¼é€ callback
   â†“
5. å¤–éƒ¨ç³»çµ±æ¥æ”¶è™•ç†
```

## ğŸ’¼ æ¥­å‹™æ‡‰ç”¨å ´æ™¯

### å€‰åº«ç®¡ç†ç³»çµ±æ•´åˆ
- è‡ªå‹•é€šçŸ¥å€‰åº«æº–å‚™å‡ºè²¨
- æ›´æ–°åº«å­˜ç‹€æ…‹
- å®‰æ’æ€è²¨ä½œæ¥­

### å®¢æˆ¶æœå‹™ç³»çµ±
- ç™¼é€è¨‚å–®ç¢ºèªéƒµä»¶
- å»ºç«‹å®¢æœå·¥å–®
- æ›´æ–°å®¢æˆ¶è¨‚å–®ç‹€æ…‹

### ç‰©æµç³»çµ±æ•´åˆ
- è‡ªå‹•å»ºç«‹é…é€å–®
- å®‰æ’é…é€è·¯ç·š
- è¿½è¹¤é…é€ç‹€æ…‹

## âš ï¸ æ³¨æ„äº‹é …

1. **éé˜»å¡è¨­è¨ˆ**: Callback å¤±æ•—ä¸æœƒå½±éŸ¿è¨‚å–®å®Œæˆæµç¨‹
2. **éŒ¯èª¤è™•ç†**: å®Œæ•´çš„éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
3. **å®‰å…¨æ€§**: å»ºè­°åœ¨æ­£å¼ç’°å¢ƒä¸­åŠ å…¥èªè­‰æ©Ÿåˆ¶
4. **é‡è©¦æ©Ÿåˆ¶**: å¯è€ƒæ…®åœ¨æœªä¾†ç‰ˆæœ¬ä¸­åŠ å…¥é‡è©¦é‚è¼¯
5. **ç›£æ§å‘Šè­¦**: å»ºè­°è¨­å®š callback å¤±æ•—çš„ç›£æ§å‘Šè­¦

## ğŸ“ æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆè·¯å¾‘ | åŠŸèƒ½æè¿° | ç‹€æ…‹ |
|---------|---------|------|
| `/backend/src/api/store/carts/[id]/complete/route.ts` | ä¿®æ”¹è¨‚å–®å®Œæˆé‚è¼¯ï¼ŒåŠ å…¥ callback | âœ… å®Œæˆ |
| `/backend/src/api/app/orders/route.ts` | Callback æ¥æ”¶ç«¯é» | âœ… å®Œæˆ |
| `å®…é…è¨‚å–®callbackæ¸¬è©¦å·¥å…·.html` | æ¸¬è©¦å·¥å…· | âœ… å®Œæˆ |

## âœ… å®Œæˆç‹€æ…‹

- **åŠŸèƒ½å¯¦ä½œ**: âœ… å®Œæˆ
- **æ¸¬è©¦å·¥å…·**: âœ… å®Œæˆ
- **æ–‡æª”èªªæ˜**: âœ… å®Œæˆ
- **éƒ¨ç½²å°±ç·’**: âœ… å¯ç«‹å³ä½¿ç”¨

## ğŸš€ å¾ŒçºŒå»ºè­°

1. **ç›£æ§å„€è¡¨æ¿**: å»ºç«‹ callback æˆåŠŸç‡ç›£æ§
2. **é‡è©¦æ©Ÿåˆ¶**: åŠ å…¥å¤±æ•—é‡è©¦é‚è¼¯
3. **èªè­‰æ©Ÿåˆ¶**: åœ¨æ­£å¼ç’°å¢ƒåŠ å…¥ API èªè­‰
4. **æ‰¹æ¬¡è™•ç†**: è€ƒæ…®æ‰¹æ¬¡ç™¼é€ callback æ¸›å°‘è«‹æ±‚é »ç‡
5. **webhook ç®¡ç†**: å»ºç«‹ webhook ç®¡ç†ä»‹é¢

---

**å¯¦ä½œå®Œæˆæ™‚é–“**: 2025å¹´7æœˆ21æ—¥  
**ç‹€æ…‹**: âœ… å¯ç«‹å³ä½¿ç”¨  
**æ¸¬è©¦å»ºè­°**: ä½¿ç”¨æä¾›çš„æ¸¬è©¦å·¥å…·é€²è¡Œé©—è­‰
