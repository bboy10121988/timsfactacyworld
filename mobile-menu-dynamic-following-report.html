<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📱 手機選單動態跟隨 - 完成報告</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: #f8fafc;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .feature-box {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .feature-box h3 {
            color: #15803d;
            margin-bottom: 12px;
        }
        
        .feature-box p {
            color: #166534;
            margin-bottom: 8px;
        }
        
        .code-block {
            background: #f1f5f9;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 12px 0;
        }
        
        .highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .problem-solution {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .problem {
            background: #fef2f2;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 16px;
        }
        
        .problem h4 {
            color: #dc2626;
            margin-bottom: 8px;
        }
        
        .solution {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 16px;
        }
        
        .solution h4 {
            color: #15803d;
            margin-bottom: 8px;
        }
        
        .technical-details {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .technical-details h4 {
            color: #475569;
            margin-bottom: 12px;
        }
        
        ul {
            margin-left: 20px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .test-link {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            margin: 8px 8px 8px 0;
            transition: background 0.2s ease;
        }
        
        .test-link:hover {
            background: #2563eb;
        }
        
        @media (max-width: 768px) {
            .problem-solution {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📱 手機選單動態跟隨功能</h1>
            <p>智能響應跑馬燈變化，實現完美對齊的手機導覽體驗</p>
        </div>
        
        <div class="content">
            <div class="section">
                <h2>🎯 功能概述</h2>
                <div class="feature-box">
                    <h3>動態位置計算</h3>
                    <p>手機漢堡選單會自動檢測跑馬燈的顯示狀態，並動態調整選單的頂部位置，確保選單始終緊貼導覽列下邊界。</p>
                </div>
                
                <div class="feature-box">
                    <h3>實時響應變化</h3>
                    <p>當跑馬燈隱藏或顯示時，選單位置會即時更新，無需手動刷新或重新開啟選單。</p>
                </div>
                
                <div class="feature-box">
                    <h3>平滑過渡效果</h3>
                    <p>位置變化採用 CSS transition 動畫，提供流暢的視覺體驗。</p>
                </div>
            </div>
            
            <div class="section">
                <h2>🔍 問題分析與解決方案</h2>
                <div class="problem-solution">
                    <div class="problem">
                        <h4>❌ 原有問題</h4>
                        <ul>
                            <li>選單位置計算是固定的</li>
                            <li>不會響應跑馬燈狀態變化</li>
                            <li>當跑馬燈隱藏時出現間隙</li>
                            <li>用戶體驗不一致</li>
                        </ul>
                    </div>
                    
                    <div class="solution">
                        <h4>✅ 解決方案</h4>
                        <ul>
                            <li>動態檢測 DOM 元素狀態</li>
                            <li>實時計算導覽列位置</li>
                            <li>使用 MutationObserver 監聽變化</li>
                            <li>響應式位置調整</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>⚙️ 技術實現細節</h2>
                
                <div class="technical-details">
                    <h4>1. 動態位置計算邏輯</h4>
                    <div class="code-block">
const calculateMenuTopOffset = () => {
  // 檢查跑馬燈元素是否存在且可見
  const marqueeElement = document.querySelector('.bg-gray-900.text-white.overflow-hidden.h-9')
  const navElement = document.querySelector('.sticky.top-0')
  
  if (navElement) {
    // 獲取導覽列的實際位置
    const navRect = navElement.getBoundingClientRect()
    const navHeight = navRect.height
    
    // 檢查跑馬燈是否顯示
    const marqueeHeight = marqueeElement && (marqueeElement as HTMLElement).offsetHeight > 0 ? 36 : 0
    
    // 計算總偏移：從視窗頂部到導覽列底部的距離
    const totalOffset = marqueeHeight + navHeight
    
    setMenuTopOffset(totalOffset)
  }
}
                    </div>
                </div>
                
                <div class="technical-details">
                    <h4>2. 變化監聽機制</h4>
                    <ul>
                        <li><span class="highlight">MutationObserver</span>：監聽 DOM 結構和屬性變化</li>
                        <li><span class="highlight">Resize Event</span>：響應視窗大小變化</li>
                        <li><span class="highlight">開啟時重算</span>：選單開啟時立即重新計算位置</li>
                    </ul>
                    
                    <div class="code-block">
// 使用 MutationObserver 監聽跑馬燈狀態變化
const observer = new MutationObserver(calculateMenuTopOffset)
const targetNode = document.body
observer.observe(targetNode, {
  childList: true,
  subtree: true,
  attributes: true,
  attributeFilter: ['class', 'style']
})
                    </div>
                </div>
                
                <div class="technical-details">
                    <h4>3. 選單開啟時即時計算</h4>
                    <div class="code-block">
onClick={() => {
  setIsOpen(true)
  // 延遲一點重新計算，確保 DOM 更新完成
  setTimeout(() => {
    const calculateMenuTopOffset = () => {
      // 重新計算邏輯...
    }
    calculateMenuTopOffset()
  }, 50)
}}
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>🧪 測試驗證</h2>
                <p>我們提供了專門的測試頁面來驗證動態跟隨功能：</p>
                
                <a href="file:///Users/raychou/medusa_0525/test-dynamic-menu-following.html" class="test-link">
                    📱 動態跟隨測試頁面
                </a>
                
                <div class="technical-details">
                    <h4>測試場景</h4>
                    <ul>
                        <li><strong>跑馬燈切換</strong>：測試選單是否跟隨跑馬燈顯示/隱藏狀態</li>
                        <li><strong>響應式適應</strong>：測試視窗大小變化時的位置調整</li>
                        <li><strong>開啟時計算</strong>：測試選單開啟時的位置準確性</li>
                        <li><strong>平滑過渡</strong>：測試位置變化的動畫效果</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>📁 修改檔案</h2>
                <div class="technical-details">
                    <h4>主要修改</h4>
                    <div class="code-block">
/frontend/src/modules/layout/components/mobile-menu.tsx
                    </div>
                    
                    <h4>關鍵變更</h4>
                    <ul>
                        <li>將固定的 <code>useMemo</code> 計算改為動態的 <code>useState</code></li>
                        <li>新增 <code>useEffect</code> 監聽 DOM 變化</li>
                        <li>新增開啟選單時的即時位置計算</li>
                        <li>加入 <code>MutationObserver</code> 和 <code>resize</code> 事件監聽</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>🌟 功能特色</h2>
                
                <div class="feature-box">
                    <h3>🎯 精確對齊</h3>
                    <p>選單上邊界始終精確對齊導覽列下邊界，無論跑馬燈狀態如何變化。</p>
                </div>
                
                <div class="feature-box">
                    <h3>⚡ 即時響應</h3>
                    <p>不需要重新開啟選單，位置變化會立即生效。</p>
                </div>
                
                <div class="feature-box">
                    <h3>📱 響應式完整</h3>
                    <p>支援各種螢幕尺寸和設備旋轉的位置調整。</p>
                </div>
                
                <div class="feature-box">
                    <h3>🎨 流暢動畫</h3>
                    <p>位置變化採用平滑過渡，提供優雅的視覺效果。</p>
                </div>
            </div>
            
            <div class="section">
                <h2>✅ 完成狀態</h2>
                <div class="technical-details">
                    <h4>已實現功能</h4>
                    <ul>
                        <li>✅ 動態檢測跑馬燈顯示狀態</li>
                        <li>✅ 實時計算導覽列位置</li>
                        <li>✅ 選單位置自動調整</li>
                        <li>✅ DOM 變化監聽機制</li>
                        <li>✅ 響應式適應</li>
                        <li>✅ 平滑過渡動畫</li>
                        <li>✅ 開啟時即時重算</li>
                        <li>✅ 測試頁面驗證</li>
                    </ul>
                    
                    <h4 style="margin-top: 16px;">技術亮點</h4>
                    <ul>
                        <li>使用現代瀏覽器 API（<code>getBoundingClientRect</code>、<code>MutationObserver</code>）</li>
                        <li>TypeScript 型別安全</li>
                        <li>React Hooks 最佳實踐</li>
                        <li>性能優化（適當的延遲和清理）</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
