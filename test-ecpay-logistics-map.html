<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>綠界電子地圖測試工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #2196F3;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .form-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group label {
            font-weight: bold;
            min-width: 120px;
            color: #555;
        }
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        select {
            min-width: 200px;
        }
        input[type="text"] {
            width: 200px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .primary-btn {
            background: #2196F3;
            font-size: 16px;
            padding: 15px 30px;
        }
        .primary-btn:hover {
            background: #1976d2;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            background: #f1f8e9;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
            color: #d32f2f;
        }
        .info {
            border-left-color: #2196F3;
            background: #e3f2fd;
            color: #1976d2;
        }
        .warning {
            border-left-color: #ff9800;
            background: #fff3e0;
            color: #f57c00;
        }
        .success {
            border-left-color: #4CAF50;
            background: #f1f8e9;
            color: #388e3c;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #4CAF50; }
        .status-error { background-color: #f44336; }
        .status-warning { background-color: #ff9800; }
        .status-info { background-color: #2196F3; }
        .specs-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .specs-table th,
        .specs-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .specs-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .specs-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .selected-store {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .selected-store h4 {
            margin-top: 0;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗺️ 綠界電子地圖測試工具</h1>
        
        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>📋 API 規格說明</h3>
            <p><strong>測試環境 URL</strong>：<code>https://logistics-stage.ecpay.com.tw/Express/map</code></p>
            <p><strong>傳輸協定</strong>：HTTPS POST</p>
            <p><strong>Content Type</strong>：application/x-www-form-urlencoded</p>
            
            <table class="specs-table">
                <thead>
                    <tr>
                        <th>參數</th>
                        <th>類型</th>
                        <th>必填</th>
                        <th>說明</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>MerchantID</td>
                        <td>String(10)</td>
                        <td>✅</td>
                        <td>廠商編號（由綠界提供）</td>
                    </tr>
                    <tr>
                        <td>MerchantTradeNo</td>
                        <td>String(20)</td>
                        <td>✅</td>
                        <td>廠商交易編號（唯一值）</td>
                    </tr>
                    <tr>
                        <td>LogisticsType</td>
                        <td>String(20)</td>
                        <td>✅</td>
                        <td>物流類型（CVS:超商取貨）</td>
                    </tr>
                    <tr>
                        <td>LogisticsSubType</td>
                        <td>String(20)</td>
                        <td>✅</td>
                        <td>物流子類型（見下方選項）</td>
                    </tr>
                    <tr>
                        <td>IsCollection</td>
                        <td>String(1)</td>
                        <td>✅</td>
                        <td>是否代收貨款（Y/N）</td>
                    </tr>
                    <tr>
                        <td>ServerReplyURL</td>
                        <td>String(200)</td>
                        <td>✅</td>
                        <td>回傳網址</td>
                    </tr>
                    <tr>
                        <td>ExtraData</td>
                        <td>String(20)</td>
                        <td>❌</td>
                        <td>額外資訊</td>
                    </tr>
                    <tr>
                        <td>Device</td>
                        <td>Int</td>
                        <td>❌</td>
                        <td>使用設備（0:PC, 1:Mobile）</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-warning"></span>⚙️ 測試參數設定</h3>
            
            <div class="form-group">
                <label>物流子類型：</label>
                <select id="logisticsSubType">
                    <optgroup label="B2C（企業對消費者）">
                        <option value="FAMI">FAMI - 全家</option>
                        <option value="UNIMART">UNIMART - 7-ELEVEN超商</option>
                        <option value="UNIMARTFREEZE">UNIMARTFREEZE - 7-ELEVEN冷凍店取</option>
                        <option value="HILIFE">HILIFE - 萊爾富</option>
                    </optgroup>
                    <optgroup label="C2C（消費者對消費者）">
                        <option value="FAMIC2C">FAMIC2C - 全家店到店</option>
                        <option value="UNIMARTC2C">UNIMARTC2C - 7-ELEVEN超商交貨便</option>
                        <option value="HILIFEC2C">HILIFEC2C - 萊爾富店到店</option>
                        <option value="OKMARTC2C">OKMARTC2C - OK超商店到店</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label>是否代收貨款：</label>
                <select id="isCollection">
                    <option value="N">N - 不代收貨款</option>
                    <option value="Y">Y - 代收貨款</option>
                </select>
            </div>

            <div class="form-group">
                <label>使用設備：</label>
                <select id="device">
                    <option value="0">0 - PC（預設）</option>
                    <option value="1">1 - Mobile</option>
                </select>
            </div>

            <div class="form-group">
                <label>額外資訊：</label>
                <input type="text" id="extraData" placeholder="選填，最多20字元" maxlength="20">
            </div>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-success"></span>🚀 電子地圖測試</h3>
            <p>點擊下方按鈕將開啟綠界電子地圖，讓您選擇超商店鋪</p>
            
            <button class="primary-btn" onclick="openLogisticsMap()">🗺️ 開啟電子地圖選擇店鋪</button>
            <button onclick="checkMapAPI()">🔍 檢查地圖 API</button>
            
            <div id="mapResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>📍 選擇結果</h3>
            <p>當您在電子地圖中選擇店鋪後，結果將顯示在這裡</p>
            
            <div id="selectedStore" style="display: none;"></div>
            <div id="storeDetails" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let selectedStoreData = null;

        // 檢查地圖 API
        async function checkMapAPI() {
            const resultDiv = document.getElementById('mapResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔄 檢查電子地圖 API...';

            try {
                const response = await fetch('http://localhost:9000/store/ecpay/logistics-map', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 電子地圖 API 檢查成功

🔧 API 資訊：
- 地圖 URL：${data.mapUrl}
- 支援物流類型：${Object.values(data.supportedLogisticsTypes).join(', ')}

📱 支援的超商類型：
B2C（企業對消費者）：
${Object.entries(data.supportedSubTypes.B2C).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}

C2C（消費者對消費者）：
${Object.entries(data.supportedSubTypes.C2C).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}

📟 設備類型：
${Object.entries(data.deviceTypes).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}

💰 代收貨款選項：
${Object.entries(data.isCollectionOptions).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}`;

                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 電子地圖 API 檢查失敗

錯誤詳情：
${error.message}

請確認：
1. 後端服務是否在 Port 9000 運行
2. 電子地圖 API 端點是否正常
3. 網路連接是否正常`;
            }
        }

        // 開啟物流地圖
        async function openLogisticsMap() {
            const resultDiv = document.getElementById('mapResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔄 正在生成電子地圖表單...';

            try {
                // 收集表單參數
                const params = {
                    logisticsType: 'CVS',
                    logisticsSubType: document.getElementById('logisticsSubType').value,
                    isCollection: document.getElementById('isCollection').value,
                    device: parseInt(document.getElementById('device').value),
                    extraData: document.getElementById('extraData').value
                };

                console.log('📝 地圖參數:', params);

                const response = await fetch('http://localhost:9000/store/ecpay/logistics-map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 電子地圖表單生成成功

📊 地圖資訊：
- 交易編號：${data.params.MerchantTradeNo}
- 物流類型：${data.params.LogisticsType}
- 物流子類型：${data.params.LogisticsSubType}
- 代收貨款：${data.params.IsCollection === 'Y' ? '是' : '否'}
- 使用設備：${data.params.Device === 1 ? 'Mobile' : 'PC'}
- 回調網址：${data.params.ServerReplyURL}

🔄 正在開啟電子地圖視窗...
請在新開啟的視窗中選擇店鋪`;

                    // 在新視窗中開啟電子地圖
                    const mapWindow = window.open('', 'ecpay_map', 'width=800,height=600,scrollbars=yes,resizable=yes');
                    if (mapWindow) {
                        mapWindow.document.write(data.html);
                        mapWindow.document.close();
                        
                        // 監聽視窗關閉事件
                        const checkClosed = setInterval(() => {
                            if (mapWindow.closed) {
                                clearInterval(checkClosed);
                                console.log('🔄 電子地圖視窗已關閉');
                            }
                        }, 1000);
                        
                    } else {
                        throw new Error('無法開啟電子地圖視窗，請允許彈出視窗');
                    }

                } else {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 開啟電子地圖失敗

錯誤詳情：
${error.message}

可能原因：
1. 後端服務未啟動
2. 參數格式錯誤
3. 瀏覽器阻擋彈出視窗
4. 網路連接問題

建議：
1. 檢查後端服務狀態
2. 允許此網站的彈出視窗
3. 檢查參數設定`;
            }
        }

        // 當店鋪被選擇時的回調函數
        window.onStoreSelected = function(storeData) {
            console.log('📍 收到店鋪選擇結果:', storeData);
            selectedStoreData = storeData;
            
            const selectedDiv = document.getElementById('selectedStore');
            const detailsDiv = document.getElementById('storeDetails');
            
            selectedDiv.style.display = 'block';
            detailsDiv.style.display = 'block';
            
            // 顯示選擇的店鋪資訊
            const storeTypeMap = {
                'FAMI': '全家',
                'UNIMART': '7-ELEVEN超商',
                'UNIMARTFREEZE': '7-ELEVEN冷凍店取',
                'HILIFE': '萊爾富',
                'FAMIC2C': '全家店到店',
                'UNIMARTC2C': '7-ELEVEN超商交貨便',
                'HILIFEC2C': '萊爾富店到店',
                'OKMARTC2C': 'OK超商店到店'
            };

            selectedDiv.innerHTML = `
                <div class="selected-store">
                    <h4>✅ 已選擇店鋪</h4>
                    <p><strong>${storeTypeMap[storeData.logisticsSubType] || storeData.logisticsSubType}</strong></p>
                    ${storeData.storeName ? `<p>店鋪：${storeData.storeName}</p>` : ''}
                    ${storeData.address ? `<p>地址：${storeData.address}</p>` : ''}
                </div>
            `;

            detailsDiv.className = 'result success';
            detailsDiv.innerHTML = `📍 店鋪選擇完整資訊：

🏪 基本資訊：
- 交易編號：${storeData.merchantTradeNo}
- 物流類型：${storeData.logisticsSubType}
- 店鋪編號：${storeData.storeId || '未提供'}
- 店鋪名稱：${storeData.storeName || '未提供'}

📍 地址資訊：
- 店鋪地址：${storeData.address || '未提供'}
- 店鋪電話：${storeData.telephone || '未提供（7-ELEVEN不提供電話）'}
- 店鋪位置：${storeData.isOutside || '未知'}

⚙️ 其他資訊：
- 額外資訊：${storeData.extraData || '無'}
- 選擇時間：${new Date(storeData.selectedAt).toLocaleString('zh-TW')}

💡 注意事項：
${storeData.logisticsSubType.includes('UNIMART') ? '- 7-ELEVEN店鋪不會回傳電話資訊' : ''}
${storeData.logisticsSubType.includes('UNIMART') || storeData.logisticsSubType.includes('FAMI') ? '- 可能會提供離島資訊（CVSOutSide）' : ''}`;
        };

        // 頁面載入時檢查 API
        window.addEventListener('load', () => {
            console.log('🗺️ 綠界電子地圖測試工具已載入');
            checkMapAPI();
        });
    </script>
</body>
</html>
