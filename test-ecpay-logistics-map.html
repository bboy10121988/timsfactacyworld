<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶ ç•Œé›»å­åœ°åœ–æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #2196F3;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .form-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group label {
            font-weight: bold;
            min-width: 120px;
            color: #555;
        }
        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        select {
            min-width: 200px;
        }
        input[type="text"] {
            width: 200px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .primary-btn {
            background: #2196F3;
            font-size: 16px;
            padding: 15px 30px;
        }
        .primary-btn:hover {
            background: #1976d2;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            background: #f1f8e9;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
            color: #d32f2f;
        }
        .info {
            border-left-color: #2196F3;
            background: #e3f2fd;
            color: #1976d2;
        }
        .warning {
            border-left-color: #ff9800;
            background: #fff3e0;
            color: #f57c00;
        }
        .success {
            border-left-color: #4CAF50;
            background: #f1f8e9;
            color: #388e3c;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #4CAF50; }
        .status-error { background-color: #f44336; }
        .status-warning { background-color: #ff9800; }
        .status-info { background-color: #2196F3; }
        .specs-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .specs-table th,
        .specs-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .specs-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .specs-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .selected-store {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .selected-store h4 {
            margin-top: 0;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ ç¶ ç•Œé›»å­åœ°åœ–æ¸¬è©¦å·¥å…·</h1>
        
        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>ğŸ“‹ API è¦æ ¼èªªæ˜</h3>
            <p><strong>æ¸¬è©¦ç’°å¢ƒ URL</strong>ï¼š<code>https://logistics-stage.ecpay.com.tw/Express/map</code></p>
            <p><strong>å‚³è¼¸å”å®š</strong>ï¼šHTTPS POST</p>
            <p><strong>Content Type</strong>ï¼šapplication/x-www-form-urlencoded</p>
            
            <table class="specs-table">
                <thead>
                    <tr>
                        <th>åƒæ•¸</th>
                        <th>é¡å‹</th>
                        <th>å¿…å¡«</th>
                        <th>èªªæ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>MerchantID</td>
                        <td>String(10)</td>
                        <td>âœ…</td>
                        <td>å» å•†ç·¨è™Ÿï¼ˆç”±ç¶ ç•Œæä¾›ï¼‰</td>
                    </tr>
                    <tr>
                        <td>MerchantTradeNo</td>
                        <td>String(20)</td>
                        <td>âœ…</td>
                        <td>å» å•†äº¤æ˜“ç·¨è™Ÿï¼ˆå”¯ä¸€å€¼ï¼‰</td>
                    </tr>
                    <tr>
                        <td>LogisticsType</td>
                        <td>String(20)</td>
                        <td>âœ…</td>
                        <td>ç‰©æµé¡å‹ï¼ˆCVS:è¶…å•†å–è²¨ï¼‰</td>
                    </tr>
                    <tr>
                        <td>LogisticsSubType</td>
                        <td>String(20)</td>
                        <td>âœ…</td>
                        <td>ç‰©æµå­é¡å‹ï¼ˆè¦‹ä¸‹æ–¹é¸é …ï¼‰</td>
                    </tr>
                    <tr>
                        <td>IsCollection</td>
                        <td>String(1)</td>
                        <td>âœ…</td>
                        <td>æ˜¯å¦ä»£æ”¶è²¨æ¬¾ï¼ˆY/Nï¼‰</td>
                    </tr>
                    <tr>
                        <td>ServerReplyURL</td>
                        <td>String(200)</td>
                        <td>âœ…</td>
                        <td>å›å‚³ç¶²å€</td>
                    </tr>
                    <tr>
                        <td>ExtraData</td>
                        <td>String(20)</td>
                        <td>âŒ</td>
                        <td>é¡å¤–è³‡è¨Š</td>
                    </tr>
                    <tr>
                        <td>Device</td>
                        <td>Int</td>
                        <td>âŒ</td>
                        <td>ä½¿ç”¨è¨­å‚™ï¼ˆ0:PC, 1:Mobileï¼‰</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-warning"></span>âš™ï¸ æ¸¬è©¦åƒæ•¸è¨­å®š</h3>
            
            <div class="form-group">
                <label>ç‰©æµå­é¡å‹ï¼š</label>
                <select id="logisticsSubType">
                    <optgroup label="B2Cï¼ˆä¼æ¥­å°æ¶ˆè²»è€…ï¼‰">
                        <option value="FAMI">FAMI - å…¨å®¶</option>
                        <option value="UNIMART">UNIMART - 7-ELEVENè¶…å•†</option>
                        <option value="UNIMARTFREEZE">UNIMARTFREEZE - 7-ELEVENå†·å‡åº—å–</option>
                        <option value="HILIFE">HILIFE - èŠçˆ¾å¯Œ</option>
                    </optgroup>
                    <optgroup label="C2Cï¼ˆæ¶ˆè²»è€…å°æ¶ˆè²»è€…ï¼‰">
                        <option value="FAMIC2C">FAMIC2C - å…¨å®¶åº—åˆ°åº—</option>
                        <option value="UNIMARTC2C">UNIMARTC2C - 7-ELEVENè¶…å•†äº¤è²¨ä¾¿</option>
                        <option value="HILIFEC2C">HILIFEC2C - èŠçˆ¾å¯Œåº—åˆ°åº—</option>
                        <option value="OKMARTC2C">OKMARTC2C - OKè¶…å•†åº—åˆ°åº—</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label>æ˜¯å¦ä»£æ”¶è²¨æ¬¾ï¼š</label>
                <select id="isCollection">
                    <option value="N">N - ä¸ä»£æ”¶è²¨æ¬¾</option>
                    <option value="Y">Y - ä»£æ”¶è²¨æ¬¾</option>
                </select>
            </div>

            <div class="form-group">
                <label>ä½¿ç”¨è¨­å‚™ï¼š</label>
                <select id="device">
                    <option value="0">0 - PCï¼ˆé è¨­ï¼‰</option>
                    <option value="1">1 - Mobile</option>
                </select>
            </div>

            <div class="form-group">
                <label>é¡å¤–è³‡è¨Šï¼š</label>
                <input type="text" id="extraData" placeholder="é¸å¡«ï¼Œæœ€å¤š20å­—å…ƒ" maxlength="20">
            </div>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-success"></span>ğŸš€ é›»å­åœ°åœ–æ¸¬è©¦</h3>
            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å°‡é–‹å•Ÿç¶ ç•Œé›»å­åœ°åœ–ï¼Œè®“æ‚¨é¸æ“‡è¶…å•†åº—é‹ª</p>
            
            <button class="primary-btn" onclick="openLogisticsMap()">ğŸ—ºï¸ é–‹å•Ÿé›»å­åœ°åœ–é¸æ“‡åº—é‹ª</button>
            <button onclick="checkMapAPI()">ğŸ” æª¢æŸ¥åœ°åœ– API</button>
            
            <div id="mapResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>ğŸ“ é¸æ“‡çµæœ</h3>
            <p>ç•¶æ‚¨åœ¨é›»å­åœ°åœ–ä¸­é¸æ“‡åº—é‹ªå¾Œï¼Œçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡</p>
            
            <div id="selectedStore" style="display: none;"></div>
            <div id="storeDetails" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let selectedStoreData = null;

        // æª¢æŸ¥åœ°åœ– API
        async function checkMapAPI() {
            const resultDiv = document.getElementById('mapResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'ğŸ”„ æª¢æŸ¥é›»å­åœ°åœ– API...';

            try {
                const response = await fetch('http://localhost:9000/store/ecpay/logistics-map', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… é›»å­åœ°åœ– API æª¢æŸ¥æˆåŠŸ

ğŸ”§ API è³‡è¨Šï¼š
- åœ°åœ– URLï¼š${data.mapUrl}
- æ”¯æ´ç‰©æµé¡å‹ï¼š${Object.values(data.supportedLogisticsTypes).join(', ')}

ğŸ“± æ”¯æ´çš„è¶…å•†é¡å‹ï¼š
B2Cï¼ˆä¼æ¥­å°æ¶ˆè²»è€…ï¼‰ï¼š
${Object.entries(data.supportedSubTypes.B2C).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}

C2Cï¼ˆæ¶ˆè²»è€…å°æ¶ˆè²»è€…ï¼‰ï¼š
${Object.entries(data.supportedSubTypes.C2C).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}

ğŸ“Ÿ è¨­å‚™é¡å‹ï¼š
${Object.entries(data.deviceTypes).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}

ğŸ’° ä»£æ”¶è²¨æ¬¾é¸é …ï¼š
${Object.entries(data.isCollectionOptions).map(([key, value]) => `  - ${key}: ${value}`).join('\n')}`;

                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ é›»å­åœ°åœ– API æª¢æŸ¥å¤±æ•—

éŒ¯èª¤è©³æƒ…ï¼š
${error.message}

è«‹ç¢ºèªï¼š
1. å¾Œç«¯æœå‹™æ˜¯å¦åœ¨ Port 9000 é‹è¡Œ
2. é›»å­åœ°åœ– API ç«¯é»æ˜¯å¦æ­£å¸¸
3. ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸`;
            }
        }

        // é–‹å•Ÿç‰©æµåœ°åœ–
        async function openLogisticsMap() {
            const resultDiv = document.getElementById('mapResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'ğŸ”„ æ­£åœ¨ç”Ÿæˆé›»å­åœ°åœ–è¡¨å–®...';

            try {
                // æ”¶é›†è¡¨å–®åƒæ•¸
                const params = {
                    logisticsType: 'CVS',
                    logisticsSubType: document.getElementById('logisticsSubType').value,
                    isCollection: document.getElementById('isCollection').value,
                    device: parseInt(document.getElementById('device').value),
                    extraData: document.getElementById('extraData').value
                };

                console.log('ğŸ“ åœ°åœ–åƒæ•¸:', params);

                const response = await fetch('http://localhost:9000/store/ecpay/logistics-map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… é›»å­åœ°åœ–è¡¨å–®ç”ŸæˆæˆåŠŸ

ğŸ“Š åœ°åœ–è³‡è¨Šï¼š
- äº¤æ˜“ç·¨è™Ÿï¼š${data.params.MerchantTradeNo}
- ç‰©æµé¡å‹ï¼š${data.params.LogisticsType}
- ç‰©æµå­é¡å‹ï¼š${data.params.LogisticsSubType}
- ä»£æ”¶è²¨æ¬¾ï¼š${data.params.IsCollection === 'Y' ? 'æ˜¯' : 'å¦'}
- ä½¿ç”¨è¨­å‚™ï¼š${data.params.Device === 1 ? 'Mobile' : 'PC'}
- å›èª¿ç¶²å€ï¼š${data.params.ServerReplyURL}

ğŸ”„ æ­£åœ¨é–‹å•Ÿé›»å­åœ°åœ–è¦–çª—...
è«‹åœ¨æ–°é–‹å•Ÿçš„è¦–çª—ä¸­é¸æ“‡åº—é‹ª`;

                    // åœ¨æ–°è¦–çª—ä¸­é–‹å•Ÿé›»å­åœ°åœ–
                    const mapWindow = window.open('', 'ecpay_map', 'width=800,height=600,scrollbars=yes,resizable=yes');
                    if (mapWindow) {
                        mapWindow.document.write(data.html);
                        mapWindow.document.close();
                        
                        // ç›£è½è¦–çª—é—œé–‰äº‹ä»¶
                        const checkClosed = setInterval(() => {
                            if (mapWindow.closed) {
                                clearInterval(checkClosed);
                                console.log('ğŸ”„ é›»å­åœ°åœ–è¦–çª—å·²é—œé–‰');
                            }
                        }, 1000);
                        
                    } else {
                        throw new Error('ç„¡æ³•é–‹å•Ÿé›»å­åœ°åœ–è¦–çª—ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—');
                    }

                } else {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ é–‹å•Ÿé›»å­åœ°åœ–å¤±æ•—

éŒ¯èª¤è©³æƒ…ï¼š
${error.message}

å¯èƒ½åŸå› ï¼š
1. å¾Œç«¯æœå‹™æœªå•Ÿå‹•
2. åƒæ•¸æ ¼å¼éŒ¯èª¤
3. ç€è¦½å™¨é˜»æ“‹å½ˆå‡ºè¦–çª—
4. ç¶²è·¯é€£æ¥å•é¡Œ

å»ºè­°ï¼š
1. æª¢æŸ¥å¾Œç«¯æœå‹™ç‹€æ…‹
2. å…è¨±æ­¤ç¶²ç«™çš„å½ˆå‡ºè¦–çª—
3. æª¢æŸ¥åƒæ•¸è¨­å®š`;
            }
        }

        // ç•¶åº—é‹ªè¢«é¸æ“‡æ™‚çš„å›èª¿å‡½æ•¸
        window.onStoreSelected = function(storeData) {
            console.log('ğŸ“ æ”¶åˆ°åº—é‹ªé¸æ“‡çµæœ:', storeData);
            selectedStoreData = storeData;
            
            const selectedDiv = document.getElementById('selectedStore');
            const detailsDiv = document.getElementById('storeDetails');
            
            selectedDiv.style.display = 'block';
            detailsDiv.style.display = 'block';
            
            // é¡¯ç¤ºé¸æ“‡çš„åº—é‹ªè³‡è¨Š
            const storeTypeMap = {
                'FAMI': 'å…¨å®¶',
                'UNIMART': '7-ELEVENè¶…å•†',
                'UNIMARTFREEZE': '7-ELEVENå†·å‡åº—å–',
                'HILIFE': 'èŠçˆ¾å¯Œ',
                'FAMIC2C': 'å…¨å®¶åº—åˆ°åº—',
                'UNIMARTC2C': '7-ELEVENè¶…å•†äº¤è²¨ä¾¿',
                'HILIFEC2C': 'èŠçˆ¾å¯Œåº—åˆ°åº—',
                'OKMARTC2C': 'OKè¶…å•†åº—åˆ°åº—'
            };

            selectedDiv.innerHTML = `
                <div class="selected-store">
                    <h4>âœ… å·²é¸æ“‡åº—é‹ª</h4>
                    <p><strong>${storeTypeMap[storeData.logisticsSubType] || storeData.logisticsSubType}</strong></p>
                    ${storeData.storeName ? `<p>åº—é‹ªï¼š${storeData.storeName}</p>` : ''}
                    ${storeData.address ? `<p>åœ°å€ï¼š${storeData.address}</p>` : ''}
                </div>
            `;

            detailsDiv.className = 'result success';
            detailsDiv.innerHTML = `ğŸ“ åº—é‹ªé¸æ“‡å®Œæ•´è³‡è¨Šï¼š

ğŸª åŸºæœ¬è³‡è¨Šï¼š
- äº¤æ˜“ç·¨è™Ÿï¼š${storeData.merchantTradeNo}
- ç‰©æµé¡å‹ï¼š${storeData.logisticsSubType}
- åº—é‹ªç·¨è™Ÿï¼š${storeData.storeId || 'æœªæä¾›'}
- åº—é‹ªåç¨±ï¼š${storeData.storeName || 'æœªæä¾›'}

ğŸ“ åœ°å€è³‡è¨Šï¼š
- åº—é‹ªåœ°å€ï¼š${storeData.address || 'æœªæä¾›'}
- åº—é‹ªé›»è©±ï¼š${storeData.telephone || 'æœªæä¾›ï¼ˆ7-ELEVENä¸æä¾›é›»è©±ï¼‰'}
- åº—é‹ªä½ç½®ï¼š${storeData.isOutside || 'æœªçŸ¥'}

âš™ï¸ å…¶ä»–è³‡è¨Šï¼š
- é¡å¤–è³‡è¨Šï¼š${storeData.extraData || 'ç„¡'}
- é¸æ“‡æ™‚é–“ï¼š${new Date(storeData.selectedAt).toLocaleString('zh-TW')}

ğŸ’¡ æ³¨æ„äº‹é …ï¼š
${storeData.logisticsSubType.includes('UNIMART') ? '- 7-ELEVENåº—é‹ªä¸æœƒå›å‚³é›»è©±è³‡è¨Š' : ''}
${storeData.logisticsSubType.includes('UNIMART') || storeData.logisticsSubType.includes('FAMI') ? '- å¯èƒ½æœƒæä¾›é›¢å³¶è³‡è¨Šï¼ˆCVSOutSideï¼‰' : ''}`;
        };

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ API
        window.addEventListener('load', () => {
            console.log('ğŸ—ºï¸ ç¶ ç•Œé›»å­åœ°åœ–æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            checkMapAPI();
        });
    </script>
</body>
</html>
