<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®…é…è¨‚å–® Callback æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .flow-diagram {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸšš å®…é…è¨‚å–® Callback æ¸¬è©¦å·¥å…·</h1>
            <p>æ¸¬è©¦å®…é…è¨‚å–®å®Œæˆæ™‚çš„ callback åŠŸèƒ½</p>
        </div>

        <div class="flow-diagram">
            <h3>ğŸ“‹ Callback æµç¨‹èªªæ˜</h3>
            <div class="flow-step">
                <div class="step-number">1</div>
                <div>ç”¨æˆ¶å®Œæˆå®…é…è¨‚å–®çµå¸³</div>
            </div>
            <div class="flow-step">
                <div class="step-number">2</div>
                <div>ç³»çµ±åµæ¸¬åˆ°å®…é…é…é€æ–¹å¼</div>
            </div>
            <div class="flow-step">
                <div class="step-number">3</div>
                <div>è‡ªå‹•ç™¼é€ callback åˆ° http://localhost:9000/app/orders</div>
            </div>
            <div class="flow-step">
                <div class="step-number">4</div>
                <div>å¤–éƒ¨ç³»çµ±æ¥æ”¶è¨‚å–®è³‡è¨Šä¸¦è™•ç†</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æ¸¬è©¦ Callback æ¥æ”¶ç«¯é»</h3>
            <p>é¦–å…ˆæ¸¬è©¦ callback æ¥æ”¶ç«¯é»æ˜¯å¦æ­£å¸¸é‹ä½œ</p>
            <button class="button" onclick="testCallbackEndpoint()">æ¸¬è©¦æ¥æ”¶ç«¯é»</button>
            <div id="endpoint-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ›’ æ¨¡æ“¬å®…é…è¨‚å–®å®Œæˆ</h3>
            <p>æ¨¡æ“¬ä¸€å€‹å®…é…è¨‚å–®çš„å®Œæˆæµç¨‹ï¼Œè§¸ç™¼ callback</p>
            <button class="button success" onclick="simulateHomeDeliveryOrder()">æ¨¡æ“¬å®…é…è¨‚å–®</button>
            <div id="order-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ å®Œæ•´æµç¨‹æ¸¬è©¦</h3>
            <p>å¾å‰µå»ºè³¼ç‰©è»Šåˆ°å®Œæˆè¨‚å–®çš„å®Œæ•´æ¸¬è©¦</p>
            <button class="button warning" onclick="fullFlowTest()">å®Œæ•´æµç¨‹æ¸¬è©¦</button>
            <div id="flow-result" class="result" style="display: none;"></div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>ğŸ“¦ Callback è³‡æ–™å…§å®¹</h4>
                <ul>
                    <li>è¨‚å–®ç·¨è™Ÿ (order_id)</li>
                    <li>è³¼ç‰©è»Šç·¨è™Ÿ (cart_id)</li>
                    <li>è¨‚å–®ç‹€æ…‹è³‡è¨Š</li>
                    <li>å®¢æˆ¶è³‡è¨Š</li>
                    <li>é…é€åœ°å€</li>
                    <li>è¨‚å–®å•†å“æ¸…å–®</li>
                    <li>ä»˜æ¬¾è³‡è¨Š</li>
                </ul>
            </div>
            <div class="feature-card">
                <h4>ğŸ”§ æŠ€è¡“å¯¦ä½œ</h4>
                <ul>
                    <li>è‡ªå‹•åµæ¸¬å®…é…é…é€æ–¹å¼</li>
                    <li>éåŒæ­¥ HTTP POST è«‹æ±‚</li>
                    <li>å®Œæ•´éŒ¯èª¤è™•ç†æ©Ÿåˆ¶</li>
                    <li>ä¸å½±éŸ¿ä¸»è¦è¨‚å–®æµç¨‹</li>
                    <li>å¯é…ç½® callback URL</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦çµæœè¨˜éŒ„</h3>
            <div id="test-log" class="result info">
æ¸¬è©¦è¨˜éŒ„å°‡é¡¯ç¤ºåœ¨é€™è£¡...
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:9000'
        const CALLBACK_URL = 'http://localhost:9000/app/orders'

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('test-log')
            const logMessage = `[${timestamp}] ${message}\n`
            logElement.textContent += logMessage
            logElement.scrollTop = logElement.scrollHeight
            console.log(message)
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId)
            element.textContent = content
            element.className = `result ${type}`
            element.style.display = 'block'
        }

        async function testCallbackEndpoint() {
            log('ğŸ§ª æ¸¬è©¦ callback æ¥æ”¶ç«¯é»...')
            
            try {
                // æ¸¬è©¦ GET è«‹æ±‚ç²å–ç«¯é»è³‡è¨Š
                const response = await fetch(CALLBACK_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                if (response.ok) {
                    const data = await response.json()
                    showResult('endpoint-result', `âœ… Callback ç«¯é»æ¸¬è©¦æˆåŠŸï¼
ç«¯é»è³‡è¨Šï¼š
${JSON.stringify(data, null, 2)}`, 'success')
                    log('âœ… Callback ç«¯é»æ­£å¸¸é‹ä½œ')
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                }

            } catch (error) {
                showResult('endpoint-result', `âŒ Callback ç«¯é»æ¸¬è©¦å¤±æ•—ï¼š
${error.message}`, 'error')
                log(`âŒ Callback ç«¯é»æ¸¬è©¦å¤±æ•—: ${error.message}`)
            }
        }

        async function simulateHomeDeliveryOrder() {
            log('ğŸ›’ æ¨¡æ“¬å®…é…è¨‚å–®å®Œæˆ...')

            try {
                // æ¨¡æ“¬è¨‚å–®è³‡æ–™
                const mockOrderData = {
                    order_id: `order_${Date.now()}`,
                    cart_id: `cart_${Date.now()}`,
                    status: 'pending',
                    payment_status: 'captured',
                    fulfillment_status: 'not_fulfilled',
                    total: 1500,
                    currency_code: 'TWD',
                    email: 'test@example.com',
                    customer_id: 'customer_123',
                    shipping_address: {
                        first_name: 'ç‹',
                        last_name: 'å°æ˜',
                        address_1: 'å°åŒ—å¸‚ä¸­æ­£å€å¿ å­æ±è·¯ä¸€æ®µ1è™Ÿ',
                        city: 'å°åŒ—å¸‚',
                        postal_code: '100',
                        phone: '0912345678'
                    },
                    billing_address: {
                        first_name: 'ç‹',
                        last_name: 'å°æ˜',
                        address_1: 'å°åŒ—å¸‚ä¸­æ­£å€å¿ å­æ±è·¯ä¸€æ®µ1è™Ÿ',
                        city: 'å°åŒ—å¸‚',
                        postal_code: '100'
                    },
                    items: [
                        {
                            id: 'item_1',
                            title: 'æ¸¬è©¦å•†å“ A',
                            quantity: 2,
                            unit_price: 500,
                            total: 1000
                        },
                        {
                            id: 'item_2',
                            title: 'æ¸¬è©¦å•†å“ B',
                            quantity: 1,
                            unit_price: 500,
                            total: 500
                        }
                    ],
                    shipping_method: 'å®…é…åˆ°åºœ',
                    created_at: new Date().toISOString(),
                    callback_type: 'home_delivery_order_created'
                }

                // ç™¼é€ callback
                const response = await fetch(CALLBACK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mockOrderData)
                })

                if (response.ok) {
                    const result = await response.json()
                    showResult('order-result', `âœ… å®…é…è¨‚å–® callback æˆåŠŸï¼

å›æ‡‰è³‡æ–™ï¼š
${JSON.stringify(result, null, 2)}

æ¨¡æ“¬è¨‚å–®ï¼š
- è¨‚å–®ç·¨è™Ÿ: ${mockOrderData.order_id}
- å®¢æˆ¶: ${mockOrderData.email}
- åœ°å€: ${mockOrderData.shipping_address.address_1}
- ç¸½é‡‘é¡: TWD ${mockOrderData.total}
- å•†å“æ•¸é‡: ${mockOrderData.items.length} é …`, 'success')
                    log(`âœ… å®…é…è¨‚å–® callback æˆåŠŸç™¼é€`)
                } else {
                    const errorData = await response.json()
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`)
                }

            } catch (error) {
                showResult('order-result', `âŒ å®…é…è¨‚å–® callback å¤±æ•—ï¼š
${error.message}`, 'error')
                log(`âŒ å®…é…è¨‚å–® callback å¤±æ•—: ${error.message}`)
            }
        }

        async function fullFlowTest() {
            log('ğŸ”„ é–‹å§‹å®Œæ•´æµç¨‹æ¸¬è©¦...')
            showResult('flow-result', 'ğŸ”„ åŸ·è¡Œå®Œæ•´æµç¨‹æ¸¬è©¦ä¸­...', 'info')

            try {
                // æ­¥é©Ÿ 1: å‰µå»ºè³¼ç‰©è»Š
                log('ğŸ“ æ­¥é©Ÿ 1: å‰µå»ºè³¼ç‰©è»Š')
                const cartResponse = await fetch(`${BACKEND_URL}/store/carts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        region_id: 'reg_01JW1S1F7GB4ZP322G2DMETETH'
                    })
                })

                if (!cartResponse.ok) {
                    throw new Error(`å‰µå»ºè³¼ç‰©è»Šå¤±æ•—: ${cartResponse.status}`)
                }

                const cartData = await cartResponse.json()
                const cartId = cartData.cart.id
                log(`âœ… è³¼ç‰©è»Šå‰µå»ºæˆåŠŸ: ${cartId}`)

                // æ­¥é©Ÿ 2: è¨­å®šè³¼ç‰©è»Šè³‡æ–™ï¼ˆæ¨¡æ“¬å®…é…ï¼‰
                log('ğŸ“ æ­¥é©Ÿ 2: è¨­å®šè³¼ç‰©è»Šç‚ºå®…é…æ¨¡å¼')
                const updateResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        shipping_address: {
                            first_name: 'æ¸¬è©¦',
                            last_name: 'ç”¨æˆ¶',
                            address_1: 'å°åŒ—å¸‚ä¸­æ­£å€å¿ å­æ±è·¯ä¸€æ®µ1è™Ÿ',
                            city: 'å°åŒ—å¸‚',
                            postal_code: '100',
                            phone: '0912345678'
                        },
                        metadata: {
                            shipping_type: 'home_delivery'
                        }
                    })
                })

                log('âœ… è³¼ç‰©è»Šè¨­å®šå®Œæˆ')

                // æ­¥é©Ÿ 3: å®Œæˆè¨‚å–®ï¼ˆé€™æœƒè§¸ç™¼ callbackï¼‰
                log('ğŸ“ æ­¥é©Ÿ 3: å®Œæˆè¨‚å–®ï¼ˆè§¸ç™¼ callbackï¼‰')
                const completeResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        payment_captured: true
                    })
                })

                if (completeResponse.ok) {
                    const orderData = await completeResponse.json()
                    showResult('flow-result', `âœ… å®Œæ•´æµç¨‹æ¸¬è©¦æˆåŠŸï¼

æµç¨‹çµæœï¼š
1. âœ… è³¼ç‰©è»Šå‰µå»º: ${cartId}
2. âœ… å®…é…è¨­å®šå®Œæˆ
3. âœ… è¨‚å–®å®Œæˆ: ${orderData.order?.id || 'å·²ç”Ÿæˆ'}

å¦‚æœæ˜¯å®…é…è¨‚å–®ï¼Œcallback æ‡‰è©²å·²ç¶“ç™¼é€åˆ°ï¼š
${CALLBACK_URL}

è«‹æª¢æŸ¥å¾Œç«¯æ§åˆ¶å°æ—¥èªŒç¢ºèª callback æ˜¯å¦æˆåŠŸåŸ·è¡Œã€‚`, 'success')
                    log(`âœ… å®Œæ•´æµç¨‹æ¸¬è©¦å®Œæˆï¼Œè¨‚å–®: ${orderData.order?.id || 'å·²ç”Ÿæˆ'}`)
                } else {
                    const errorData = await completeResponse.text()
                    throw new Error(`å®Œæˆè¨‚å–®å¤±æ•—: ${completeResponse.status} - ${errorData}`)
                }

            } catch (error) {
                showResult('flow-result', `âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—ï¼š
${error.message}

è«‹æª¢æŸ¥ï¼š
1. å¾Œç«¯æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ
2. API Key æ˜¯å¦æ­£ç¢º
3. å€åŸŸè¨­å®šæ˜¯å¦å­˜åœ¨`, 'error')
                log(`âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`)
            }
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæ­¡è¿è¨Šæ¯
        window.addEventListener('load', () => {
            log('ğŸšš å®…é…è¨‚å–® Callback æ¸¬è©¦å·¥å…·å·²è¼‰å…¥')
            log('ğŸ“‹ Callback URL: ' + CALLBACK_URL)
            log('ğŸ”§ å¾Œç«¯ URL: ' + BACKEND_URL)
        })
    </script>
</body>
</html>
