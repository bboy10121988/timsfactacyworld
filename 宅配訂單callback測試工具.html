<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宅配訂單 Callback 測試工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .flow-diagram {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .step-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚚 宅配訂單 Callback 測試工具</h1>
            <p>測試宅配訂單完成時的 callback 功能</p>
        </div>

        <div class="flow-diagram">
            <h3>📋 Callback 流程說明</h3>
            <div class="flow-step">
                <div class="step-number">1</div>
                <div>用戶完成宅配訂單結帳</div>
            </div>
            <div class="flow-step">
                <div class="step-number">2</div>
                <div>系統偵測到宅配配送方式</div>
            </div>
            <div class="flow-step">
                <div class="step-number">3</div>
                <div>自動發送 callback 到 http://localhost:9000/app/orders</div>
            </div>
            <div class="flow-step">
                <div class="step-number">4</div>
                <div>外部系統接收訂單資訊並處理</div>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 測試 Callback 接收端點</h3>
            <p>首先測試 callback 接收端點是否正常運作</p>
            <button class="button" onclick="testCallbackEndpoint()">測試接收端點</button>
            <div id="endpoint-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🛒 模擬宅配訂單完成</h3>
            <p>模擬一個宅配訂單的完成流程，觸發 callback</p>
            <button class="button success" onclick="simulateHomeDeliveryOrder()">模擬宅配訂單</button>
            <div id="order-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🔄 完整流程測試</h3>
            <p>從創建購物車到完成訂單的完整測試</p>
            <button class="button warning" onclick="fullFlowTest()">完整流程測試</button>
            <div id="flow-result" class="result" style="display: none;"></div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>📦 Callback 資料內容</h4>
                <ul>
                    <li>訂單編號 (order_id)</li>
                    <li>購物車編號 (cart_id)</li>
                    <li>訂單狀態資訊</li>
                    <li>客戶資訊</li>
                    <li>配送地址</li>
                    <li>訂單商品清單</li>
                    <li>付款資訊</li>
                </ul>
            </div>
            <div class="feature-card">
                <h4>🔧 技術實作</h4>
                <ul>
                    <li>自動偵測宅配配送方式</li>
                    <li>非同步 HTTP POST 請求</li>
                    <li>完整錯誤處理機制</li>
                    <li>不影響主要訂單流程</li>
                    <li>可配置 callback URL</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 測試結果記錄</h3>
            <div id="test-log" class="result info">
測試記錄將顯示在這裡...
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:9000'
        const CALLBACK_URL = 'http://localhost:9000/app/orders'

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('test-log')
            const logMessage = `[${timestamp}] ${message}\n`
            logElement.textContent += logMessage
            logElement.scrollTop = logElement.scrollHeight
            console.log(message)
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId)
            element.textContent = content
            element.className = `result ${type}`
            element.style.display = 'block'
        }

        async function testCallbackEndpoint() {
            log('🧪 測試 callback 接收端點...')
            
            try {
                // 測試 GET 請求獲取端點資訊
                const response = await fetch(CALLBACK_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                if (response.ok) {
                    const data = await response.json()
                    showResult('endpoint-result', `✅ Callback 端點測試成功！
端點資訊：
${JSON.stringify(data, null, 2)}`, 'success')
                    log('✅ Callback 端點正常運作')
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                }

            } catch (error) {
                showResult('endpoint-result', `❌ Callback 端點測試失敗：
${error.message}`, 'error')
                log(`❌ Callback 端點測試失敗: ${error.message}`)
            }
        }

        async function simulateHomeDeliveryOrder() {
            log('🛒 模擬宅配訂單完成...')

            try {
                // 模擬訂單資料
                const mockOrderData = {
                    order_id: `order_${Date.now()}`,
                    cart_id: `cart_${Date.now()}`,
                    status: 'pending',
                    payment_status: 'captured',
                    fulfillment_status: 'not_fulfilled',
                    total: 1500,
                    currency_code: 'TWD',
                    email: 'test@example.com',
                    customer_id: 'customer_123',
                    shipping_address: {
                        first_name: '王',
                        last_name: '小明',
                        address_1: '台北市中正區忠孝東路一段1號',
                        city: '台北市',
                        postal_code: '100',
                        phone: '0912345678'
                    },
                    billing_address: {
                        first_name: '王',
                        last_name: '小明',
                        address_1: '台北市中正區忠孝東路一段1號',
                        city: '台北市',
                        postal_code: '100'
                    },
                    items: [
                        {
                            id: 'item_1',
                            title: '測試商品 A',
                            quantity: 2,
                            unit_price: 500,
                            total: 1000
                        },
                        {
                            id: 'item_2',
                            title: '測試商品 B',
                            quantity: 1,
                            unit_price: 500,
                            total: 500
                        }
                    ],
                    shipping_method: '宅配到府',
                    created_at: new Date().toISOString(),
                    callback_type: 'home_delivery_order_created'
                }

                // 發送 callback
                const response = await fetch(CALLBACK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mockOrderData)
                })

                if (response.ok) {
                    const result = await response.json()
                    showResult('order-result', `✅ 宅配訂單 callback 成功！

回應資料：
${JSON.stringify(result, null, 2)}

模擬訂單：
- 訂單編號: ${mockOrderData.order_id}
- 客戶: ${mockOrderData.email}
- 地址: ${mockOrderData.shipping_address.address_1}
- 總金額: TWD ${mockOrderData.total}
- 商品數量: ${mockOrderData.items.length} 項`, 'success')
                    log(`✅ 宅配訂單 callback 成功發送`)
                } else {
                    const errorData = await response.json()
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`)
                }

            } catch (error) {
                showResult('order-result', `❌ 宅配訂單 callback 失敗：
${error.message}`, 'error')
                log(`❌ 宅配訂單 callback 失敗: ${error.message}`)
            }
        }

        async function fullFlowTest() {
            log('🔄 開始完整流程測試...')
            showResult('flow-result', '🔄 執行完整流程測試中...', 'info')

            try {
                // 步驟 1: 創建購物車
                log('📝 步驟 1: 創建購物車')
                const cartResponse = await fetch(`${BACKEND_URL}/store/carts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        region_id: 'reg_01JW1S1F7GB4ZP322G2DMETETH'
                    })
                })

                if (!cartResponse.ok) {
                    throw new Error(`創建購物車失敗: ${cartResponse.status}`)
                }

                const cartData = await cartResponse.json()
                const cartId = cartData.cart.id
                log(`✅ 購物車創建成功: ${cartId}`)

                // 步驟 2: 設定購物車資料（模擬宅配）
                log('📝 步驟 2: 設定購物車為宅配模式')
                const updateResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        shipping_address: {
                            first_name: '測試',
                            last_name: '用戶',
                            address_1: '台北市中正區忠孝東路一段1號',
                            city: '台北市',
                            postal_code: '100',
                            phone: '0912345678'
                        },
                        metadata: {
                            shipping_type: 'home_delivery'
                        }
                    })
                })

                log('✅ 購物車設定完成')

                // 步驟 3: 完成訂單（這會觸發 callback）
                log('📝 步驟 3: 完成訂單（觸發 callback）')
                const completeResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        payment_captured: true
                    })
                })

                if (completeResponse.ok) {
                    const orderData = await completeResponse.json()
                    showResult('flow-result', `✅ 完整流程測試成功！

流程結果：
1. ✅ 購物車創建: ${cartId}
2. ✅ 宅配設定完成
3. ✅ 訂單完成: ${orderData.order?.id || '已生成'}

如果是宅配訂單，callback 應該已經發送到：
${CALLBACK_URL}

請檢查後端控制台日誌確認 callback 是否成功執行。`, 'success')
                    log(`✅ 完整流程測試完成，訂單: ${orderData.order?.id || '已生成'}`)
                } else {
                    const errorData = await completeResponse.text()
                    throw new Error(`完成訂單失敗: ${completeResponse.status} - ${errorData}`)
                }

            } catch (error) {
                showResult('flow-result', `❌ 完整流程測試失敗：
${error.message}

請檢查：
1. 後端服務是否正在運行
2. API Key 是否正確
3. 區域設定是否存在`, 'error')
                log(`❌ 完整流程測試失敗: ${error.message}`)
            }
        }

        // 頁面載入時顯示歡迎訊息
        window.addEventListener('load', () => {
            log('🚚 宅配訂單 Callback 測試工具已載入')
            log('📋 Callback URL: ' + CALLBACK_URL)
            log('🔧 後端 URL: ' + BACKEND_URL)
        })
    </script>
</body>
</html>
