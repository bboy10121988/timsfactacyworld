# è¯ç›Ÿè¡ŒéŠ·ç³»çµ± - å¾Œç«¯ API æ–‡ä»¶

## æ¦‚è¿°

é€™æ˜¯ä¸€å€‹å®Œæ•´çš„è¯ç›Ÿè¡ŒéŠ·ç³»çµ±ï¼ŒåŒ…å«å‰ç«¯è¨»å†Šç™»å…¥åŠŸèƒ½å’Œå¾Œç«¯ç®¡ç†å¯©æ ¸ç³»çµ±ã€‚ç³»çµ±å…è¨±è¯ç›Ÿå¤¥ä¼´è¨»å†Šã€ç®¡ç†å“¡å¯©æ ¸ã€é»æ“Šè¿½è¹¤ã€è½‰æ›è¨˜éŒ„å’Œä½£é‡‘ç®¡ç†ã€‚

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### è³‡æ–™åº«æ¨¡å‹
- **AffiliatePartner**: è¯ç›Ÿå¤¥ä¼´è³‡æ–™
- **AffiliateClick**: é»æ“Šè¿½è¹¤è¨˜éŒ„
- **AffiliateConversion**: è½‰æ›å’Œä½£é‡‘è¨˜éŒ„

### æœå‹™å±¤
- **AffiliateService**: è¯ç›Ÿè¡ŒéŠ·æ¥­å‹™é‚è¼¯è™•ç†

### API è·¯ç”±
- **å‰ç«¯ API** (`/store/affiliate/*`): ä¾›å‰ç«¯ç¶²ç«™ä½¿ç”¨
- **ç®¡ç† API** (`/admin/affiliate/*`): ä¾› Medusa å¾Œå°ä½¿ç”¨

### ç®¡ç†ä»‹é¢
- **è¯ç›Ÿå„€è¡¨æ¿**: çµ±è¨ˆè³‡æ–™ç¸½è¦½
- **å¤¥ä¼´ç®¡ç†**: å¯©æ ¸è¨»å†Šç”³è«‹
- **ä½£é‡‘ç®¡ç†**: ç®¡ç†ä½£é‡‘æ”¯ä»˜

## ğŸ“¡ API ç«¯é»

### å‰ç«¯ API (Store)

#### å¤¥ä¼´è¨»å†Š
```http
POST /store/affiliate/partners
```
```json
{
  "name": "å¤¥ä¼´å§“å",
  "email": "partner@example.com",
  "phone": "0912345678",
  "website": "https://partner-website.com",
  "password": "password123"
}
```

#### å¤¥ä¼´ç™»å…¥
```http
POST /store/affiliate/login
```
```json
{
  "email": "partner@example.com",
  "password": "password123"
}
```

#### æª¢æŸ¥ Email æ˜¯å¦å­˜åœ¨
```http
GET /store/affiliate/partners?email=partner@example.com
```

#### å–å¾—å¤¥ä¼´çµ±è¨ˆè³‡æ–™
```http
GET /store/affiliate/partners/{id}/stats
Authorization: Bearer {token}
```

#### è¨˜éŒ„é»æ“Šè¿½è¹¤
```http
POST /store/affiliate/track
```
```json
{
  "partnerId": "partner_123",
  "productId": "product_456",
  "url": "https://website.com/product/456",
  "userAgent": "Mozilla/5.0...",
  "referrer": "https://google.com"
}
```

#### è¨˜éŒ„è½‰æ›
```http
POST /store/affiliate/conversion
```
```json
{
  "partnerId": "partner_123",
  "orderId": "order_789",
  "productId": "product_456",
  "orderValue": 1000,
  "commissionRate": 0.05
}
```

### ç®¡ç† API (Admin)

#### å–å¾—å¤¥ä¼´åˆ—è¡¨
```http
GET /admin/affiliate/partners?status=pending&page=1&limit=20
```

#### å¯©æ ¸å¤¥ä¼´
```http
POST /admin/affiliate/partners/{id}/approve
```
```json
{
  "status": "approved",
  "reason": "å¯©æ ¸é€šéåŸå› "
}
```

#### å–å¾—ä½£é‡‘åˆ—è¡¨
```http
GET /admin/affiliate/commissions?status=pending
```

#### æ›´æ–°ä½£é‡‘ç‹€æ…‹
```http
POST /admin/affiliate/commissions/{id}/status
```
```json
{
  "status": "paid",
  "reason": "å·²æ”¯ä»˜å‚™è¨»"
}
```

#### å–å¾—çµ±è¨ˆè³‡æ–™
```http
GET /admin/affiliate/stats
```

## ğŸ–¥ï¸ Medusa å¾Œå°ç®¡ç†ä»‹é¢

### 1. è¯ç›Ÿå„€è¡¨æ¿
- **è·¯å¾‘**: `/admin/affiliate/dashboard`
- **åŠŸèƒ½**: é¡¯ç¤ºç¸½é«”çµ±è¨ˆè³‡æ–™
- **åŒ…å«**: å¤¥ä¼´æ•¸é‡ã€é»æ“Šæ•¸ã€è½‰æ›ç‡ã€ä½£é‡‘çµ±è¨ˆ

### 2. å¤¥ä¼´ç®¡ç†
- **è·¯å¾‘**: `/admin/affiliate`  
- **åŠŸèƒ½**: ç®¡ç†è¯ç›Ÿå¤¥ä¼´ç”³è«‹
- **æ“ä½œ**: 
  - æŸ¥çœ‹å¾…å¯©æ ¸çš„è¨»å†Šç”³è«‹
  - æ ¸å‡†æˆ–æ‹’çµ•å¤¥ä¼´ç”³è«‹
  - æŸ¥çœ‹å¤¥ä¼´è©³ç´°è³‡æ–™

### 3. ä½£é‡‘ç®¡ç†
- **è·¯å¾‘**: `/admin/affiliate/commissions`
- **åŠŸèƒ½**: ç®¡ç†ä½£é‡‘æ”¯ä»˜
- **æ“ä½œ**:
  - æŸ¥çœ‹å¾…æ ¸å‡†çš„ä½£é‡‘
  - æ ¸å‡†ä½£é‡‘ç™¼æ”¾
  - æ¨™è¨˜ä½£é‡‘ç‚ºå·²æ”¯ä»˜
  - æ‹’çµ•ç„¡æ•ˆä½£é‡‘

## ğŸ”§ å®‰è£å’Œè¨­å®š

### 1. è³‡æ–™åº«è¨­å®š
ç³»çµ±æœƒè‡ªå‹•å‰µå»ºä»¥ä¸‹è³‡æ–™è¡¨ï¼š
- `affiliate_partner`
- `affiliate_click`  
- `affiliate_conversion`

### 2. ç’°å¢ƒè®Šæ•¸
```bash
# JWT å¯†é‘° (ç”¨æ–¼å¤¥ä¼´ç™»å…¥é©—è­‰)
AFFILIATE_JWT_SECRET=your-jwt-secret-here

# ä½£é‡‘è¨­å®š
DEFAULT_COMMISSION_RATE=0.05
```

### 3. å•Ÿå‹•æœå‹™
```bash
cd backend
npm run build
npm run start
```

### 4. æ¸¬è©¦ API
```bash
node test-affiliate-api.js
```

## ğŸš€ é–‹ç™¼ç‹€æ…‹

### âœ… å·²å®Œæˆ
- è³‡æ–™åº«æ¨¡å‹å®šç¾©
- API è·¯ç”±çµæ§‹
- Medusa å¾Œå°ç®¡ç†ä»‹é¢
- åŸºæœ¬çš„æ¨¡æ“¬éŸ¿æ‡‰

### ğŸ”„ é€²è¡Œä¸­
- è³‡æ–™åº«å¯¦éš›æ“ä½œå¯¦ä½œ
- JWT èº«ä»½é©—è­‰
- å¯¦éš›çš„æœå‹™å±¤é‚è¼¯

### ğŸ“‹ å¾…è¾¦äº‹é …
- ECPay é‡‘æµæ•´åˆ
- Email é€šçŸ¥ç³»çµ±
- è©³ç´°çš„æ•¸æ“šåˆ†æå ±è¡¨
- è‡ªå‹•åŒ–æ¸¬è©¦
- API æ–‡æª”ç”Ÿæˆ

## ğŸ” å®‰å…¨è€ƒé‡

1. **èº«ä»½é©—è­‰**: JWT token é©—è­‰å¤¥ä¼´èº«ä»½
2. **æ¬Šé™æ§åˆ¶**: ç®¡ç†å“¡æ¬Šé™é©—è­‰
3. **è³‡æ–™é©—è­‰**: è¼¸å…¥åƒæ•¸é©—è­‰å’Œæ¸…ç†
4. **é˜²é‡è¤‡**: é˜²æ­¢é‡è¤‡é»æ“Šå’Œè½‰æ›è¨˜éŒ„

## ğŸ“ˆ æ“´å±•åŠŸèƒ½

1. **å¤šå±¤ç´šä½£é‡‘**: æ”¯æ´å¤šå±¤æ¬¡è¯ç›Ÿè¡ŒéŠ·
2. **è‡ªå®šç¾©ä½£é‡‘ç‡**: ä¸åŒç”¢å“ä¸åŒä½£é‡‘ç‡
3. **æ¨å»£ç´ æç®¡ç†**: æä¾›æ¨å»£æ©«å¹…å’Œé€£çµ
4. **å³æ™‚é€šçŸ¥**: è½‰æ›å³æ™‚é€šçŸ¥å¤¥ä¼´
5. **åˆ†æå ±è¡¨**: è©³ç´°çš„æ€§èƒ½åˆ†æ

## ğŸ¯ ä½¿ç”¨æµç¨‹

### å¤¥ä¼´è¨»å†Šæµç¨‹
1. å¤¥ä¼´åœ¨å‰ç«¯å¡«å¯«è¨»å†Šè¡¨å–®
2. ç³»çµ±å‰µå»ºå¾…å¯©æ ¸çš„å¤¥ä¼´è¨˜éŒ„
3. ç®¡ç†å“¡åœ¨å¾Œå°å¯©æ ¸ç”³è«‹
4. å¯©æ ¸é€šéå¾Œå¤¥ä¼´å¯ä»¥ç™»å…¥ä½¿ç”¨

### ä½£é‡‘è¨ˆç®—æµç¨‹
1. ç”¨æˆ¶é€éå¤¥ä¼´é€£çµè¨ªå•ç¶²ç«™ï¼ˆè¨˜éŒ„é»æ“Šï¼‰
2. ç”¨æˆ¶å®Œæˆè³¼è²·ï¼ˆè¨˜éŒ„è½‰æ›ï¼‰
3. ç³»çµ±è‡ªå‹•è¨ˆç®—ä½£é‡‘
4. ç®¡ç†å“¡å¯©æ ¸ä¸¦æ ¸å‡†ä½£é‡‘
5. å®šæœŸæ”¯ä»˜ä½£é‡‘çµ¦å¤¥ä¼´

---

**æ³¨æ„**: é€™æ˜¯ä¸€å€‹åŸºç¤æ¡†æ¶ï¼Œå¯¦éš›éƒ¨ç½²å‰éœ€è¦å®Œæˆæœå‹™å±¤çš„å¯¦ä½œå’Œå®‰å…¨æ€§åŠ å¼·ã€‚
