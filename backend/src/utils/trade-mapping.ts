// ECPay Trade Mapping System
// ç”¨æ–¼ MerchantTradeNo èˆ‡ Cart ID ä¹‹é–“çš„æ˜ å°„
import * as fs from 'fs'
import * as path from 'path'

interface TradeMapping {
  cartId: string
  createdAt: Date
  amount: number
}

// å®šç¾©æŒä¹…åŒ–æ–‡ä»¶è·¯å¾‘
const STORAGE_DIR = path.join(__dirname, '../../.ecpay-cache')
const MAPPING_FILE = path.join(STORAGE_DIR, 'trade-mappings.json')

// ä½¿ç”¨ Map å­˜å„²æ˜ å°„é—œä¿‚
const tradeMappings = new Map<string, TradeMapping>()

// ç¢ºä¿å­˜å„²ç›®éŒ„å­˜åœ¨
try {
  if (!fs.existsSync(STORAGE_DIR)) {
    fs.mkdirSync(STORAGE_DIR, { recursive: true })
    console.log(`ğŸ“ Created storage directory: ${STORAGE_DIR}`)
  }
} catch (error) {
  console.warn(`âš ï¸ Failed to create storage directory: ${error}`)
}

// å¾æ–‡ä»¶åŠ è¼‰æ˜ å°„ï¼ˆåˆå§‹åŒ–æ™‚ï¼‰
try {
  if (fs.existsSync(MAPPING_FILE)) {
    const fileContent = fs.readFileSync(MAPPING_FILE, 'utf-8')
    const storedData = JSON.parse(fileContent)
    
    for (const [key, value] of Object.entries(storedData)) {
      const mapping = value as any
      tradeMappings.set(key, {
        ...mapping,
        createdAt: new Date(mapping.createdAt)
      })
    }
    
    console.log(`ğŸ“¥ Loaded ${tradeMappings.size} trade mappings from file`)
  }
} catch (error) {
  console.warn(`âš ï¸ Failed to load trade mappings: ${error}`)
}

// æŒä¹…åŒ–å„²å­˜æ˜ å°„
function persistMappings(): void {
  try {
    const data: Record<string, any> = {}
    tradeMappings.forEach((value, key) => {
      data[key] = value
    })
    
    fs.writeFileSync(MAPPING_FILE, JSON.stringify(data, null, 2), 'utf-8')
    console.log(`ğŸ“¤ Persisted ${tradeMappings.size} trade mappings to file`)
  } catch (error) {
    console.warn(`âš ï¸ Failed to persist trade mappings: ${error}`)
  }
}

/**
 * æ·»åŠ  trade mapping
 */
export function addTradeMapping(merchantTradeNo: string, cartId: string, amount: number): void {
  tradeMappings.set(merchantTradeNo, {
    cartId,
    createdAt: new Date(),
    amount
  })
  
  console.log(`âœ… Trade mapping stored - MerchantTradeNo: ${merchantTradeNo} -> CartID: ${cartId}`)
  console.log(`ğŸ“Š Current mappings count: ${tradeMappings.size}`)
  
  // æŒä¹…åŒ–åˆ°æ–‡ä»¶
  persistMappings()
}

/**
 * ç²å– trade mapping
 */
export function getTradeMapping(merchantTradeNo: string): string | null {
  const mapping = tradeMappings.get(merchantTradeNo)
  
  if (mapping) {
    console.log(`ğŸ” Trade mapping found - MerchantTradeNo: ${merchantTradeNo} -> CartID: ${mapping.cartId}`)
    return mapping.cartId
  }
  
  console.log(`âŒ Trade mapping not found for MerchantTradeNo: ${merchantTradeNo}`)
  
  if (tradeMappings.size > 0) {
    console.log(`ğŸ“Š Available mappings:`, Array.from(tradeMappings.keys()))
  } else {
    console.log(`ğŸ“Š No mappings available in memory`)
  }
  
  return null
}

/**
 * ç§»é™¤ trade mapping
 */
export function removeTradeMapping(merchantTradeNo: string): boolean {
  const deleted = tradeMappings.delete(merchantTradeNo)
  
  if (deleted) {
    console.log(`ğŸ—‘ï¸ Trade mapping removed - MerchantTradeNo: ${merchantTradeNo}`)
    // æŒä¹…åŒ–æ›´æ–°
    persistMappings()
  } else {
    console.log(`âš ï¸ Trade mapping not found for removal - MerchantTradeNo: ${merchantTradeNo}`)
  }
  
  console.log(`ğŸ“Š Remaining mappings count: ${tradeMappings.size}`)
  return deleted
}

/**
 * ç²å–æ‰€æœ‰ trade mappingsï¼ˆèª¿è©¦ç”¨ï¼‰
 */
export function getAllTradeMappings(): Record<string, TradeMapping> {
  const result: Record<string, TradeMapping> = {}
  tradeMappings.forEach((value, key) => {
    result[key] = value
  })
  return result
}

/**
 * æ¸…ç†éæœŸçš„ trade mappingsï¼ˆè¶…é24å°æ™‚ï¼‰
 */
export function cleanupExpiredMappings(): number {
  const now = new Date()
  const expiredKeys: string[] = []
  
  tradeMappings.forEach((mapping, merchantTradeNo) => {
    const hoursDiff = (now.getTime() - mapping.createdAt.getTime()) / (1000 * 60 * 60)
    if (hoursDiff > 24) {
      expiredKeys.push(merchantTradeNo)
    }
  })
  
  expiredKeys.forEach(key => {
    tradeMappings.delete(key)
  })
  
  if (expiredKeys.length > 0) {
    console.log(`ğŸ§¹ Cleaned up ${expiredKeys.length} expired trade mappings`)
  }
  
  return expiredKeys.length
}
