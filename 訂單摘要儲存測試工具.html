<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單摘要儲存測試工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .button {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #218838;
        }
        .button.primary {
            background: #007bff;
        }
        .button.primary:hover {
            background: #0056b3;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .button.warning:hover {
            background: #e0a800;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .data-preview {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        .step-number {
            background: #28a745;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💾 訂單摘要儲存測試工具</h1>
            <p>測試訂單摘要傳送到 http://localhost:9000/app/orders 進行儲存</p>
        </div>

        <div class="test-section">
            <h3>📋 訂單儲存流程</h3>
            <div class="flow-step">
                <div class="step-number">1</div>
                <div><strong>客戶完成宅配訂單</strong> - 在 Medusa 系統中完成結帳</div>
            </div>
            <div class="flow-step">
                <div class="step-number">2</div>
                <div><strong>系統產生訂單摘要</strong> - 整理關鍵訂單資訊</div>
            </div>
            <div class="flow-step">
                <div class="step-number">3</div>
                <div><strong>傳送到儲存端點</strong> - POST 到 /app/orders 進行儲存</div>
            </div>
            <div class="flow-step">
                <div class="step-number">4</div>
                <div><strong>外部系統處理</strong> - 儲存訂單並觸發後續流程</div>
            </div>
        </div>

        <div class="test-section">
            <h3>🔍 測試儲存端點狀態</h3>
            <p>檢查訂單儲存端點是否正常運作</p>
            <button class="button primary" onclick="testStorageEndpoint()">檢測儲存端點</button>
            <div id="endpoint-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>📦 模擬訂單摘要儲存</h3>
            <p>模擬一個完整的訂單摘要並測試儲存功能</p>
            <button class="button" onclick="simulateOrderStorage()">模擬訂單儲存</button>
            <div id="storage-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🛒 完整購物流程測試</h3>
            <p>從創建購物車到完成訂單的完整測試流程</p>
            <button class="button warning" onclick="fullOrderFlowTest()">完整流程測試</button>
            <div id="flow-result" class="result" style="display: none;"></div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>📊 訂單摘要內容</h4>
                <ul>
                    <li><strong>基本資訊</strong>：訂單編號、狀態</li>
                    <li><strong>金額資訊</strong>：小計、運費、稅額、總額</li>
                    <li><strong>客戶資訊</strong>：Email、姓名、電話</li>
                    <li><strong>配送資訊</strong>：方式、地址</li>
                    <li><strong>商品清單</strong>：產品、數量、價格</li>
                    <li><strong>系統資訊</strong>：來源、類型、時間</li>
                </ul>
            </div>
            <div class="feature-card">
                <h4>🔧 技術特點</h4>
                <ul>
                    <li><strong>結構化資料</strong>：標準化的訂單摘要格式</li>
                    <li><strong>非同步處理</strong>：不影響主要訂單流程</li>
                    <li><strong>錯誤處理</strong>：完整的異常處理機制</li>
                    <li><strong>日誌記錄</strong>：詳細的處理日誌</li>
                    <li><strong>可擴展性</strong>：支援外部系統整合</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>📋 訂單摘要資料格式預覽</h3>
            <p>以下是傳送到儲存端點的訂單摘要資料結構：</p>
            <div class="data-preview" id="data-preview">
{
  "order_id": "order_xxxxx",
  "cart_id": "cart_xxxxx", 
  "order_number": "order_xxxxx",
  "status": "pending",
  "payment_status": "captured",
  "fulfillment_status": "not_fulfilled",
  "subtotal": 1000,
  "shipping_total": 60,
  "tax_total": 50,
  "total": 1110,
  "currency_code": "TWD",
  "customer": {
    "email": "customer@example.com",
    "name": "王小明",
    "phone": "0912345678"
  },
  "shipping": {
    "method": "宅配到府",
    "address": {
      "recipient_name": "王小明",
      "address_line_1": "台北市中正區忠孝東路一段1號",
      "city": "台北市", 
      "postal_code": "100",
      "country_code": "TW",
      "phone": "0912345678"
    }
  },
  "items": [
    {
      "title": "商品名稱",
      "quantity": 2,
      "unit_price": 500,
      "total_price": 1000
    }
  ],
  "created_at": "2025-07-21T...",
  "updated_at": "2025-07-21T...",
  "source": "medusa",
  "order_type": "home_delivery"
}
            </div>
        </div>

        <div class="test-section">
            <h3>📊 測試結果記錄</h3>
            <div id="test-log" class="result info">
測試記錄將顯示在這裡...
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:9000'
        const STORAGE_URL = 'http://localhost:9000/app/orders'

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('test-log')
            const logMessage = `[${timestamp}] ${message}\n`
            logElement.textContent += logMessage
            logElement.scrollTop = logElement.scrollHeight
            console.log(message)
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId)
            element.textContent = content
            element.className = `result ${type}`
            element.style.display = 'block'
        }

        async function testStorageEndpoint() {
            log('🔍 測試訂單儲存端點...')
            
            try {
                const response = await fetch(STORAGE_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                if (response.ok) {
                    const data = await response.json()
                    showResult('endpoint-result', `✅ 訂單儲存端點測試成功！

端點資訊：
${JSON.stringify(data, null, 2)}`, 'success')
                    log('✅ 訂單儲存端點正常運作')
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                }

            } catch (error) {
                showResult('endpoint-result', `❌ 訂單儲存端點測試失敗：
${error.message}

請確認：
1. 後端服務正在運行 (port 9000)
2. /app/orders 路由已正確設定
3. CORS 設定允許請求`, 'error')
                log(`❌ 儲存端點測試失敗: ${error.message}`)
            }
        }

        async function simulateOrderStorage() {
            log('📦 模擬訂單摘要儲存...')

            try {
                // 創建模擬訂單摘要
                const orderSummary = {
                    order_id: `order_${Date.now()}`,
                    cart_id: `cart_${Date.now()}`,
                    order_number: `ORD-${Date.now()}`,
                    status: 'pending',
                    payment_status: 'captured',
                    fulfillment_status: 'not_fulfilled',
                    subtotal: 1500,
                    shipping_total: 100,
                    tax_total: 75,
                    total: 1675,
                    currency_code: 'TWD',
                    customer: {
                        email: 'test@example.com',
                        name: '測試客戶',
                        phone: '0912345678'
                    },
                    shipping: {
                        method: '宅配到府',
                        address: {
                            recipient_name: '測試客戶',
                            address_line_1: '台北市中正區忠孝東路一段1號',
                            address_line_2: '3樓',
                            city: '台北市',
                            province: '台北市',
                            postal_code: '100',
                            country_code: 'TW',
                            phone: '0912345678'
                        }
                    },
                    items: [
                        {
                            product_id: 'prod_1',
                            variant_id: 'var_1',
                            title: '測試商品 A',
                            quantity: 2,
                            unit_price: 500,
                            total_price: 1000,
                            thumbnail: 'https://example.com/image1.jpg'
                        },
                        {
                            product_id: 'prod_2',
                            variant_id: 'var_2',
                            title: '測試商品 B',
                            quantity: 1,
                            unit_price: 500,
                            total_price: 500,
                            thumbnail: 'https://example.com/image2.jpg'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    source: 'medusa',
                    order_type: 'home_delivery',
                    metadata: {
                        test_order: true,
                        simulation: true
                    }
                }

                // 發送到儲存端點
                const response = await fetch(STORAGE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Order-Source': 'medusa-test'
                    },
                    body: JSON.stringify(orderSummary)
                })

                if (response.ok) {
                    const result = await response.json()
                    showResult('storage-result', `✅ 訂單摘要儲存成功！

儲存結果：
${JSON.stringify(result, null, 2)}

訂單摘要：
- 訂單編號: ${orderSummary.order_number}
- 客戶: ${orderSummary.customer.email}
- 地址: ${orderSummary.shipping.address.address_line_1}
- 總金額: ${orderSummary.currency_code} ${orderSummary.total}
- 商品數量: ${orderSummary.items.length} 項
- 配送方式: ${orderSummary.shipping.method}`, 'success')
                    log(`✅ 訂單摘要儲存成功: ${orderSummary.order_id}`)
                } else {
                    const errorData = await response.json()
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`)
                }

            } catch (error) {
                showResult('storage-result', `❌ 訂單摘要儲存失敗：
${error.message}`, 'error')
                log(`❌ 訂單摘要儲存失敗: ${error.message}`)
            }
        }

        async function fullOrderFlowTest() {
            log('🔄 開始完整訂單流程測試...')
            showResult('flow-result', '🔄 執行完整流程測試中...', 'info')

            try {
                // 步驟 1: 創建購物車
                log('📝 步驟 1: 創建購物車')
                const cartResponse = await fetch(`${BACKEND_URL}/store/carts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        region_id: 'reg_01JW1S1F7GB4ZP322G2DMETETH'
                    })
                })

                if (!cartResponse.ok) {
                    throw new Error(`創建購物車失敗: ${cartResponse.status}`)
                }

                const cartData = await cartResponse.json()
                const cartId = cartData.cart.id
                log(`✅ 購物車創建成功: ${cartId}`)

                // 步驟 2: 設定購物車為宅配
                log('📝 步驟 2: 設定購物車為宅配配送')
                const updateResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        shipping_address: {
                            first_name: '測試',
                            last_name: '用戶',
                            address_1: '台北市中正區忠孝東路一段1號',
                            city: '台北市',
                            postal_code: '100',
                            phone: '0912345678'
                        },
                        metadata: {
                            shipping_type: 'home_delivery',
                            test_order: true
                        }
                    })
                })

                log('✅ 購物車設定完成')

                // 步驟 3: 完成訂單（觸發儲存）
                log('📝 步驟 3: 完成訂單（觸發訂單摘要儲存）')
                const completeResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        payment_captured: true
                    })
                })

                if (completeResponse.ok) {
                    const orderData = await completeResponse.json()
                    showResult('flow-result', `✅ 完整流程測試成功！

流程結果：
1. ✅ 購物車創建: ${cartId}
2. ✅ 宅配設定完成
3. ✅ 訂單完成: ${orderData.order?.id || '已生成'}

📋 訂單摘要已自動傳送到儲存端點：
${STORAGE_URL}

請檢查後端控制台日誌確認：
- 🚚 偵測到宅配訂單
- 💾 訂單摘要傳送成功
- ✅ 儲存端點處理完成`, 'success')
                    log(`✅ 完整流程測試完成，訂單: ${orderData.order?.id || '已生成'}`)
                } else {
                    const errorData = await completeResponse.text()
                    throw new Error(`完成訂單失敗: ${completeResponse.status} - ${errorData}`)
                }

            } catch (error) {
                showResult('flow-result', `❌ 完整流程測試失敗：
${error.message}

請檢查：
1. 後端服務是否正在運行 (port 9000)
2. API Key 是否正確
3. 區域設定是否存在
4. 儲存端點是否正常運作`, 'error')
                log(`❌ 完整流程測試失敗: ${error.message}`)
            }
        }

        // 頁面載入時顯示歡迎訊息
        window.addEventListener('load', () => {
            log('💾 訂單摘要儲存測試工具已載入')
            log('📋 儲存端點: ' + STORAGE_URL)
            log('🔧 後端服務: ' + BACKEND_URL)
        })
    </script>
</body>
</html>
