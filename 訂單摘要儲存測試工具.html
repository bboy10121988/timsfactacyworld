<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®æ‘˜è¦å„²å­˜æ¸¬è©¦å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .button {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #218838;
        }
        .button.primary {
            background: #007bff;
        }
        .button.primary:hover {
            background: #0056b3;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .button.warning:hover {
            background: #e0a800;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .data-preview {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .flow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }
        .step-number {
            background: #28a745;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’¾ è¨‚å–®æ‘˜è¦å„²å­˜æ¸¬è©¦å·¥å…·</h1>
            <p>æ¸¬è©¦è¨‚å–®æ‘˜è¦å‚³é€åˆ° http://localhost:9000/app/orders é€²è¡Œå„²å­˜</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ è¨‚å–®å„²å­˜æµç¨‹</h3>
            <div class="flow-step">
                <div class="step-number">1</div>
                <div><strong>å®¢æˆ¶å®Œæˆå®…é…è¨‚å–®</strong> - åœ¨ Medusa ç³»çµ±ä¸­å®Œæˆçµå¸³</div>
            </div>
            <div class="flow-step">
                <div class="step-number">2</div>
                <div><strong>ç³»çµ±ç”¢ç”Ÿè¨‚å–®æ‘˜è¦</strong> - æ•´ç†é—œéµè¨‚å–®è³‡è¨Š</div>
            </div>
            <div class="flow-step">
                <div class="step-number">3</div>
                <div><strong>å‚³é€åˆ°å„²å­˜ç«¯é»</strong> - POST åˆ° /app/orders é€²è¡Œå„²å­˜</div>
            </div>
            <div class="flow-step">
                <div class="step-number">4</div>
                <div><strong>å¤–éƒ¨ç³»çµ±è™•ç†</strong> - å„²å­˜è¨‚å–®ä¸¦è§¸ç™¼å¾ŒçºŒæµç¨‹</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ” æ¸¬è©¦å„²å­˜ç«¯é»ç‹€æ…‹</h3>
            <p>æª¢æŸ¥è¨‚å–®å„²å­˜ç«¯é»æ˜¯å¦æ­£å¸¸é‹ä½œ</p>
            <button class="button primary" onclick="testStorageEndpoint()">æª¢æ¸¬å„²å­˜ç«¯é»</button>
            <div id="endpoint-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“¦ æ¨¡æ“¬è¨‚å–®æ‘˜è¦å„²å­˜</h3>
            <p>æ¨¡æ“¬ä¸€å€‹å®Œæ•´çš„è¨‚å–®æ‘˜è¦ä¸¦æ¸¬è©¦å„²å­˜åŠŸèƒ½</p>
            <button class="button" onclick="simulateOrderStorage()">æ¨¡æ“¬è¨‚å–®å„²å­˜</button>
            <div id="storage-result" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ›’ å®Œæ•´è³¼ç‰©æµç¨‹æ¸¬è©¦</h3>
            <p>å¾å‰µå»ºè³¼ç‰©è»Šåˆ°å®Œæˆè¨‚å–®çš„å®Œæ•´æ¸¬è©¦æµç¨‹</p>
            <button class="button warning" onclick="fullOrderFlowTest()">å®Œæ•´æµç¨‹æ¸¬è©¦</button>
            <div id="flow-result" class="result" style="display: none;"></div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>ğŸ“Š è¨‚å–®æ‘˜è¦å…§å®¹</h4>
                <ul>
                    <li><strong>åŸºæœ¬è³‡è¨Š</strong>ï¼šè¨‚å–®ç·¨è™Ÿã€ç‹€æ…‹</li>
                    <li><strong>é‡‘é¡è³‡è¨Š</strong>ï¼šå°è¨ˆã€é‹è²»ã€ç¨…é¡ã€ç¸½é¡</li>
                    <li><strong>å®¢æˆ¶è³‡è¨Š</strong>ï¼šEmailã€å§“åã€é›»è©±</li>
                    <li><strong>é…é€è³‡è¨Š</strong>ï¼šæ–¹å¼ã€åœ°å€</li>
                    <li><strong>å•†å“æ¸…å–®</strong>ï¼šç”¢å“ã€æ•¸é‡ã€åƒ¹æ ¼</li>
                    <li><strong>ç³»çµ±è³‡è¨Š</strong>ï¼šä¾†æºã€é¡å‹ã€æ™‚é–“</li>
                </ul>
            </div>
            <div class="feature-card">
                <h4>ğŸ”§ æŠ€è¡“ç‰¹é»</h4>
                <ul>
                    <li><strong>çµæ§‹åŒ–è³‡æ–™</strong>ï¼šæ¨™æº–åŒ–çš„è¨‚å–®æ‘˜è¦æ ¼å¼</li>
                    <li><strong>éåŒæ­¥è™•ç†</strong>ï¼šä¸å½±éŸ¿ä¸»è¦è¨‚å–®æµç¨‹</li>
                    <li><strong>éŒ¯èª¤è™•ç†</strong>ï¼šå®Œæ•´çš„ç•°å¸¸è™•ç†æ©Ÿåˆ¶</li>
                    <li><strong>æ—¥èªŒè¨˜éŒ„</strong>ï¼šè©³ç´°çš„è™•ç†æ—¥èªŒ</li>
                    <li><strong>å¯æ“´å±•æ€§</strong>ï¼šæ”¯æ´å¤–éƒ¨ç³»çµ±æ•´åˆ</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ è¨‚å–®æ‘˜è¦è³‡æ–™æ ¼å¼é è¦½</h3>
            <p>ä»¥ä¸‹æ˜¯å‚³é€åˆ°å„²å­˜ç«¯é»çš„è¨‚å–®æ‘˜è¦è³‡æ–™çµæ§‹ï¼š</p>
            <div class="data-preview" id="data-preview">
{
  "order_id": "order_xxxxx",
  "cart_id": "cart_xxxxx", 
  "order_number": "order_xxxxx",
  "status": "pending",
  "payment_status": "captured",
  "fulfillment_status": "not_fulfilled",
  "subtotal": 1000,
  "shipping_total": 60,
  "tax_total": 50,
  "total": 1110,
  "currency_code": "TWD",
  "customer": {
    "email": "customer@example.com",
    "name": "ç‹å°æ˜",
    "phone": "0912345678"
  },
  "shipping": {
    "method": "å®…é…åˆ°åºœ",
    "address": {
      "recipient_name": "ç‹å°æ˜",
      "address_line_1": "å°åŒ—å¸‚ä¸­æ­£å€å¿ å­æ±è·¯ä¸€æ®µ1è™Ÿ",
      "city": "å°åŒ—å¸‚", 
      "postal_code": "100",
      "country_code": "TW",
      "phone": "0912345678"
    }
  },
  "items": [
    {
      "title": "å•†å“åç¨±",
      "quantity": 2,
      "unit_price": 500,
      "total_price": 1000
    }
  ],
  "created_at": "2025-07-21T...",
  "updated_at": "2025-07-21T...",
  "source": "medusa",
  "order_type": "home_delivery"
}
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ¸¬è©¦çµæœè¨˜éŒ„</h3>
            <div id="test-log" class="result info">
æ¸¬è©¦è¨˜éŒ„å°‡é¡¯ç¤ºåœ¨é€™è£¡...
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://localhost:9000'
        const STORAGE_URL = 'http://localhost:9000/app/orders'

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('test-log')
            const logMessage = `[${timestamp}] ${message}\n`
            logElement.textContent += logMessage
            logElement.scrollTop = logElement.scrollHeight
            console.log(message)
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId)
            element.textContent = content
            element.className = `result ${type}`
            element.style.display = 'block'
        }

        async function testStorageEndpoint() {
            log('ğŸ” æ¸¬è©¦è¨‚å–®å„²å­˜ç«¯é»...')
            
            try {
                const response = await fetch(STORAGE_URL, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                if (response.ok) {
                    const data = await response.json()
                    showResult('endpoint-result', `âœ… è¨‚å–®å„²å­˜ç«¯é»æ¸¬è©¦æˆåŠŸï¼

ç«¯é»è³‡è¨Šï¼š
${JSON.stringify(data, null, 2)}`, 'success')
                    log('âœ… è¨‚å–®å„²å­˜ç«¯é»æ­£å¸¸é‹ä½œ')
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                }

            } catch (error) {
                showResult('endpoint-result', `âŒ è¨‚å–®å„²å­˜ç«¯é»æ¸¬è©¦å¤±æ•—ï¼š
${error.message}

è«‹ç¢ºèªï¼š
1. å¾Œç«¯æœå‹™æ­£åœ¨é‹è¡Œ (port 9000)
2. /app/orders è·¯ç”±å·²æ­£ç¢ºè¨­å®š
3. CORS è¨­å®šå…è¨±è«‹æ±‚`, 'error')
                log(`âŒ å„²å­˜ç«¯é»æ¸¬è©¦å¤±æ•—: ${error.message}`)
            }
        }

        async function simulateOrderStorage() {
            log('ğŸ“¦ æ¨¡æ“¬è¨‚å–®æ‘˜è¦å„²å­˜...')

            try {
                // å‰µå»ºæ¨¡æ“¬è¨‚å–®æ‘˜è¦
                const orderSummary = {
                    order_id: `order_${Date.now()}`,
                    cart_id: `cart_${Date.now()}`,
                    order_number: `ORD-${Date.now()}`,
                    status: 'pending',
                    payment_status: 'captured',
                    fulfillment_status: 'not_fulfilled',
                    subtotal: 1500,
                    shipping_total: 100,
                    tax_total: 75,
                    total: 1675,
                    currency_code: 'TWD',
                    customer: {
                        email: 'test@example.com',
                        name: 'æ¸¬è©¦å®¢æˆ¶',
                        phone: '0912345678'
                    },
                    shipping: {
                        method: 'å®…é…åˆ°åºœ',
                        address: {
                            recipient_name: 'æ¸¬è©¦å®¢æˆ¶',
                            address_line_1: 'å°åŒ—å¸‚ä¸­æ­£å€å¿ å­æ±è·¯ä¸€æ®µ1è™Ÿ',
                            address_line_2: '3æ¨“',
                            city: 'å°åŒ—å¸‚',
                            province: 'å°åŒ—å¸‚',
                            postal_code: '100',
                            country_code: 'TW',
                            phone: '0912345678'
                        }
                    },
                    items: [
                        {
                            product_id: 'prod_1',
                            variant_id: 'var_1',
                            title: 'æ¸¬è©¦å•†å“ A',
                            quantity: 2,
                            unit_price: 500,
                            total_price: 1000,
                            thumbnail: 'https://example.com/image1.jpg'
                        },
                        {
                            product_id: 'prod_2',
                            variant_id: 'var_2',
                            title: 'æ¸¬è©¦å•†å“ B',
                            quantity: 1,
                            unit_price: 500,
                            total_price: 500,
                            thumbnail: 'https://example.com/image2.jpg'
                        }
                    ],
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString(),
                    source: 'medusa',
                    order_type: 'home_delivery',
                    metadata: {
                        test_order: true,
                        simulation: true
                    }
                }

                // ç™¼é€åˆ°å„²å­˜ç«¯é»
                const response = await fetch(STORAGE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Order-Source': 'medusa-test'
                    },
                    body: JSON.stringify(orderSummary)
                })

                if (response.ok) {
                    const result = await response.json()
                    showResult('storage-result', `âœ… è¨‚å–®æ‘˜è¦å„²å­˜æˆåŠŸï¼

å„²å­˜çµæœï¼š
${JSON.stringify(result, null, 2)}

è¨‚å–®æ‘˜è¦ï¼š
- è¨‚å–®ç·¨è™Ÿ: ${orderSummary.order_number}
- å®¢æˆ¶: ${orderSummary.customer.email}
- åœ°å€: ${orderSummary.shipping.address.address_line_1}
- ç¸½é‡‘é¡: ${orderSummary.currency_code} ${orderSummary.total}
- å•†å“æ•¸é‡: ${orderSummary.items.length} é …
- é…é€æ–¹å¼: ${orderSummary.shipping.method}`, 'success')
                    log(`âœ… è¨‚å–®æ‘˜è¦å„²å­˜æˆåŠŸ: ${orderSummary.order_id}`)
                } else {
                    const errorData = await response.json()
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(errorData)}`)
                }

            } catch (error) {
                showResult('storage-result', `âŒ è¨‚å–®æ‘˜è¦å„²å­˜å¤±æ•—ï¼š
${error.message}`, 'error')
                log(`âŒ è¨‚å–®æ‘˜è¦å„²å­˜å¤±æ•—: ${error.message}`)
            }
        }

        async function fullOrderFlowTest() {
            log('ğŸ”„ é–‹å§‹å®Œæ•´è¨‚å–®æµç¨‹æ¸¬è©¦...')
            showResult('flow-result', 'ğŸ”„ åŸ·è¡Œå®Œæ•´æµç¨‹æ¸¬è©¦ä¸­...', 'info')

            try {
                // æ­¥é©Ÿ 1: å‰µå»ºè³¼ç‰©è»Š
                log('ğŸ“ æ­¥é©Ÿ 1: å‰µå»ºè³¼ç‰©è»Š')
                const cartResponse = await fetch(`${BACKEND_URL}/store/carts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        region_id: 'reg_01JW1S1F7GB4ZP322G2DMETETH'
                    })
                })

                if (!cartResponse.ok) {
                    throw new Error(`å‰µå»ºè³¼ç‰©è»Šå¤±æ•—: ${cartResponse.status}`)
                }

                const cartData = await cartResponse.json()
                const cartId = cartData.cart.id
                log(`âœ… è³¼ç‰©è»Šå‰µå»ºæˆåŠŸ: ${cartId}`)

                // æ­¥é©Ÿ 2: è¨­å®šè³¼ç‰©è»Šç‚ºå®…é…
                log('ğŸ“ æ­¥é©Ÿ 2: è¨­å®šè³¼ç‰©è»Šç‚ºå®…é…é…é€')
                const updateResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        shipping_address: {
                            first_name: 'æ¸¬è©¦',
                            last_name: 'ç”¨æˆ¶',
                            address_1: 'å°åŒ—å¸‚ä¸­æ­£å€å¿ å­æ±è·¯ä¸€æ®µ1è™Ÿ',
                            city: 'å°åŒ—å¸‚',
                            postal_code: '100',
                            phone: '0912345678'
                        },
                        metadata: {
                            shipping_type: 'home_delivery',
                            test_order: true
                        }
                    })
                })

                log('âœ… è³¼ç‰©è»Šè¨­å®šå®Œæˆ')

                // æ­¥é©Ÿ 3: å®Œæˆè¨‚å–®ï¼ˆè§¸ç™¼å„²å­˜ï¼‰
                log('ğŸ“ æ­¥é©Ÿ 3: å®Œæˆè¨‚å–®ï¼ˆè§¸ç™¼è¨‚å–®æ‘˜è¦å„²å­˜ï¼‰')
                const completeResponse = await fetch(`${BACKEND_URL}/store/carts/${cartId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': 'pk_01JZ9GCZ3EYS15P07M93RXCMMZ'
                    },
                    body: JSON.stringify({
                        payment_captured: true
                    })
                })

                if (completeResponse.ok) {
                    const orderData = await completeResponse.json()
                    showResult('flow-result', `âœ… å®Œæ•´æµç¨‹æ¸¬è©¦æˆåŠŸï¼

æµç¨‹çµæœï¼š
1. âœ… è³¼ç‰©è»Šå‰µå»º: ${cartId}
2. âœ… å®…é…è¨­å®šå®Œæˆ
3. âœ… è¨‚å–®å®Œæˆ: ${orderData.order?.id || 'å·²ç”Ÿæˆ'}

ğŸ“‹ è¨‚å–®æ‘˜è¦å·²è‡ªå‹•å‚³é€åˆ°å„²å­˜ç«¯é»ï¼š
${STORAGE_URL}

è«‹æª¢æŸ¥å¾Œç«¯æ§åˆ¶å°æ—¥èªŒç¢ºèªï¼š
- ğŸšš åµæ¸¬åˆ°å®…é…è¨‚å–®
- ğŸ’¾ è¨‚å–®æ‘˜è¦å‚³é€æˆåŠŸ
- âœ… å„²å­˜ç«¯é»è™•ç†å®Œæˆ`, 'success')
                    log(`âœ… å®Œæ•´æµç¨‹æ¸¬è©¦å®Œæˆï¼Œè¨‚å–®: ${orderData.order?.id || 'å·²ç”Ÿæˆ'}`)
                } else {
                    const errorData = await completeResponse.text()
                    throw new Error(`å®Œæˆè¨‚å–®å¤±æ•—: ${completeResponse.status} - ${errorData}`)
                }

            } catch (error) {
                showResult('flow-result', `âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—ï¼š
${error.message}

è«‹æª¢æŸ¥ï¼š
1. å¾Œç«¯æœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ (port 9000)
2. API Key æ˜¯å¦æ­£ç¢º
3. å€åŸŸè¨­å®šæ˜¯å¦å­˜åœ¨
4. å„²å­˜ç«¯é»æ˜¯å¦æ­£å¸¸é‹ä½œ`, 'error')
                log(`âŒ å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`)
            }
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæ­¡è¿è¨Šæ¯
        window.addEventListener('load', () => {
            log('ğŸ’¾ è¨‚å–®æ‘˜è¦å„²å­˜æ¸¬è©¦å·¥å…·å·²è¼‰å…¥')
            log('ğŸ“‹ å„²å­˜ç«¯é»: ' + STORAGE_URL)
            log('ğŸ”§ å¾Œç«¯æœå‹™: ' + BACKEND_URL)
        })
    </script>
</body>
</html>
