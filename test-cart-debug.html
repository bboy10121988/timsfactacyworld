<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>購物車功能測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .button { padding: 10px 15px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-left: 4px solid #28a745; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        #log { font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>購物車功能測試</h1>
    
    <div class="test-section">
        <h2>1. 測試後端 API 連接</h2>
        <button class="button" onclick="testBackendConnection()">測試後端連接</button>
        <div id="backend-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. 測試產品列表</h2>
        <button class="button" onclick="testProducts()">獲取產品列表</button>
        <div id="products-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. 測試區域設定</h2>
        <button class="button" onclick="testRegions()">獲取區域列表</button>
        <div id="regions-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 測試購物車創建</h2>
        <button class="button" onclick="testCreateCart()">創建購物車</button>
        <div id="cart-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. 測試加入購物車</h2>
        <button class="button" onclick="testAddToCart()">加入商品到購物車</button>
        <div id="addtocart-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>6. 測試前端 API 路由</h2>
        <button class="button" onclick="testFrontendAPI()">測試前端購物車 API</button>
        <div id="frontend-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>日誌</h2>
        <div id="log" class="result"></div>
        <h2>6. 測試購物車狀態</h2>
        <button class="button" onclick="testCartStatus()">檢查購物車狀態</button>
        <div id="cart-status-result" class="result"></div>

        <h2>7. 測試 Cookie</h2>
        <button class="button" onclick="testCookies()">檢查 Cookie 狀態</button>
        <div id="cookies-result" class="result"></div>

    </div>

    <script>
        const BACKEND_URL = 'http://localhost:9000';
        const FRONTEND_URL = 'http://localhost:8000';
        const API_KEY = 'pk_6a5b6f62e29baea8089628c7713ce56a388c5944011f43fcf15b8837b00464b7';
        const TAIWAN_REGION_ID = 'reg_01JW1S1F7GB4ZP322G2DMETETH';
        const TEST_VARIANT_ID = 'variant_01JXWCAMPWST2KWW17GZD5MVSF';
        
        let createdCartId = null;
        
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = isError ? 'result error' : 'result';
        }
        
        async function testBackendConnection() {
            log('測試後端連接...');
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                if (response.ok) {
                    showResult('backend-result', '✅ 後端連接成功');
                    log('後端連接成功');
                } else {
                    showResult('backend-result', `❌ 後端連接失敗: ${response.status}`, true);
                    log(`後端連接失敗: ${response.status}`);
                }
            } catch (error) {
                showResult('backend-result', `❌ 後端連接錯誤: ${error.message}`, true);
                log(`後端連接錯誤: ${error.message}`);
            }
        }
        
        async function testProducts() {
            log('測試產品列表...');
            try {
                const response = await fetch(`${BACKEND_URL}/store/products?limit=1`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': API_KEY
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('products-result', `✅ 獲取到 ${data.products.length} 個產品`);
                    log(`產品列表: ${JSON.stringify(data.products[0], null, 2)}`);
                } else {
                    const error = await response.text();
                    showResult('products-result', `❌ 產品獲取失敗: ${error}`, true);
                    log(`產品獲取失敗: ${error}`);
                }
            } catch (error) {
                showResult('products-result', `❌ 產品獲取錯誤: ${error.message}`, true);
                log(`產品獲取錯誤: ${error.message}`);
            }
        }
        
        async function testRegions() {
            log('測試區域列表...');
            try {
                const response = await fetch(`${BACKEND_URL}/store/regions`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': API_KEY
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('regions-result', `✅ 獲取到 ${data.regions.length} 個區域`);
                    log(`區域列表: ${JSON.stringify(data.regions, null, 2)}`);
                } else {
                    const error = await response.text();
                    showResult('regions-result', `❌ 區域獲取失敗: ${error}`, true);
                    log(`區域獲取失敗: ${error}`);
                }
            } catch (error) {
                showResult('regions-result', `❌ 區域獲取錯誤: ${error.message}`, true);
                log(`區域獲取錯誤: ${error.message}`);
            }
        }
        
        async function testCreateCart() {
            log('測試購物車創建...');
            try {
                const response = await fetch(`${BACKEND_URL}/store/carts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': API_KEY
                    },
                    body: JSON.stringify({ region_id: TAIWAN_REGION_ID })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    createdCartId = data.cart.id;
                    showResult('cart-result', `✅ 購物車創建成功: ${createdCartId}`);
                    log(`購物車創建成功: ${JSON.stringify(data.cart, null, 2)}`);
                } else {
                    const error = await response.text();
                    showResult('cart-result', `❌ 購物車創建失敗: ${error}`, true);
                    log(`購物車創建失敗: ${error}`);
                }
            } catch (error) {
                showResult('cart-result', `❌ 購物車創建錯誤: ${error.message}`, true);
                log(`購物車創建錯誤: ${error.message}`);
            }
        }
        
        async function testAddToCart() {
            if (!createdCartId) {
                showResult('addtocart-result', '❌ 請先創建購物車', true);
                return;
            }
            
            log('測試加入購物車...');
            try {
                const response = await fetch(`${BACKEND_URL}/store/carts/${createdCartId}/line-items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-publishable-api-key': API_KEY
                    },
                    body: JSON.stringify({ 
                        variant_id: TEST_VARIANT_ID, 
                        quantity: 1 
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('addtocart-result', `✅ 商品加入購物車成功: ${data.cart.items.length} 個商品`);
                    log(`加入購物車成功: ${JSON.stringify(data.cart.items, null, 2)}`);
                } else {
                    const error = await response.text();
                    showResult('addtocart-result', `❌ 加入購物車失敗: ${error}`, true);
                    log(`加入購物車失敗: ${error}`);
                }
            } catch (error) {
                showResult('addtocart-result', `❌ 加入購物車錯誤: ${error.message}`, true);
                log(`加入購物車錯誤: ${error.message}`);
            }
        }
        
        async function testFrontendAPI() {
            log('測試前端 API...');
            try {
                const response = await fetch(`${FRONTEND_URL}/api/cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        variantId: TEST_VARIANT_ID, 
                        quantity: 1,
                        countryCode: 'tw'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('frontend-result', `✅ 前端 API 測試成功`);
                    log(`前端 API 回應: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const error = await response.text();
                    showResult('frontend-result', `❌ 前端 API 測試失敗: ${error}`, true);
                    log(`前端 API 測試失敗: ${error}`);
                }
            } catch (error) {
                showResult('frontend-result', `❌ 前端 API 測試錯誤: ${error.message}`, true);
                log(`前端 API 測試錯誤: ${error.message}`);
            }
        }

        async function testCartStatus() {
            try {
                log('測試購物車狀態...');
                const response = await fetch('/api/cart/get');
                const data = await response.json();
                
                if (data.cart) {
                    const itemCount = data.cart.items ? data.cart.items.length : 0;
                    showResult('cart-status-result', `✅ 購物車狀態: ${itemCount} 個商品`);
                    log(`購物車資料: ${JSON.stringify(data.cart, null, 2)}`);
                } else {
                    showResult('cart-status-result', '❌ 沒有購物車或購物車為空');
                }
            } catch (error) {
                showResult('cart-status-result', `❌ 購物車狀態檢查錯誤: ${error.message}`, true);
                log(`購物車狀態檢查錯誤: ${error.message}`);
            }
        }

        async function testCookies() {
            try {
                log('檢查 Cookie 狀態...');
                const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                    const [key, value] = cookie.trim().split('=');
                    acc[key] = value;
                    return acc;
                }, {});
                
                const cartCookie = cookies['_medusa_cart_id'];
                if (cartCookie) {
                    showResult('cookies-result', `✅ 找到購物車 Cookie: ${cartCookie}`);
                } else {
                    showResult('cookies-result', '❌ 沒有找到購物車 Cookie');
                }
                
                log(`所有 Cookie: ${JSON.stringify(cookies, null, 2)}`);
            } catch (error) {
                showResult('cookies-result', `❌ Cookie 檢查錯誤: ${error.message}`, true);
                log(`Cookie 檢查錯誤: ${error.message}`);
            }
        }
        
        // 頁面載入時自動測試連接
        window.onload = function() {
            log('頁面載入完成，開始自動測試...');
            testBackendConnection();
        };
    </script>
</body>
</html>
