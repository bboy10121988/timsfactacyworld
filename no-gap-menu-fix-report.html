<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✅ 手機選單無間隙對齊 - 修正完成</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: #f8fafc;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #1f2937;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .problem-solution {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .problem {
            background: #fef2f2;
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 20px;
        }
        
        .problem h3 {
            color: #dc2626;
            margin-bottom: 12px;
        }
        
        .solution {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 20px;
        }
        
        .solution h3 {
            color: #15803d;
            margin-bottom: 12px;
        }
        
        .code-block {
            background: #f1f5f9;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 12px 0;
            border-left: 4px solid #3b82f6;
        }
        
        .highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .highlight.red {
            background: #fecaca;
            color: #dc2626;
        }
        
        .highlight.green {
            background: #bbf7d0;
            color: #15803d;
        }
        
        .feature-box {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
        }
        
        .feature-box h4 {
            color: #475569;
            margin-bottom: 12px;
        }
        
        .test-link {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            margin: 8px 8px 8px 0;
            transition: background 0.2s ease;
        }
        
        .test-link:hover {
            background: #dc2626;
        }
        
        ul {
            margin-left: 20px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .problem-solution {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>✅ 手機選單無間隙對齊修正</h1>
            <p>徹底解決跑馬燈隱藏時選單與導覽列間的空隙問題</p>
        </div>
        
        <div class="content">
            <div class="section">
                <h2>🎯 問題分析</h2>
                <div class="problem-solution">
                    <div class="problem">
                        <h3>❌ 原始問題</h3>
                        <ul>
                            <li>當跑馬燈隱藏時，選單和導覽列之間出現空隙</li>
                            <li>計算方式基於跑馬燈高度推算，不夠精確</li>
                            <li>沒有直接測量 sticky 導覽列的實際位置</li>
                            <li>用戶體驗不連貫，視覺上有斷層</li>
                        </ul>
                        
                        <div class="code-block">
// ❌ 原本的計算方式
const marqueeHeight = marqueeElement ? 36 : 0
const totalOffset = marqueeHeight + navHeight
                        </div>
                    </div>
                    
                    <div class="solution">
                        <h3>✅ 修正方案</h3>
                        <ul>
                            <li>直接測量 sticky 導覽列的實際位置</li>
                            <li>使用 <span class="highlight green">getBoundingClientRect()</span> 獲取精確位置</li>
                            <li>選單位置 = sticky 頂部 + sticky 高度</li>
                            <li>確保完全無間隙的視覺連接</li>
                        </ul>
                        
                        <div class="code-block">
// ✅ 修正後的精確計算
const stickyNavRect = stickyNav.getBoundingClientRect()
const totalOffset = stickyNavRect.top + stickyNavRect.height
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>🔧 技術實現細節</h2>
                
                <div class="feature-box">
                    <h4>1. 精確位置計算邏輯</h4>
                    <div class="code-block">
const calculateMenuTopOffset = () => {
  // 直接使用 sticky 導覽列的位置計算
  const stickyNav = document.querySelector('.sticky.top-0')
  
  if (stickyNav) {
    const stickyNavRect = stickyNav.getBoundingClientRect()
    // 選單頂部位置 = sticky 導覽列頂部 + sticky 導覽列高度
    const totalOffset = stickyNavRect.top + stickyNavRect.height
    
    setMenuTopOffset(totalOffset)
  }
}
                    </div>
                </div>
                
                <div class="feature-box">
                    <h4>2. 即時響應機制</h4>
                    <ul>
                        <li><span class="highlight">MutationObserver</span>：監聽 DOM 變化，延遲 100ms 計算</li>
                        <li><span class="highlight">開啟時重算</span>：選單開啟時立即重新計算位置</li>
                        <li><span class="highlight">事件監聽</span>：resize 和 scroll 事件響應</li>
                    </ul>
                    
                    <div class="code-block">
// 開啟選單時的即時計算
onClick={() => {
  setIsOpen(true)
  setTimeout(() => {
    const stickyNav = document.querySelector('.sticky.top-0')
    if (stickyNav) {
      const stickyNavRect = stickyNav.getBoundingClientRect()
      const totalOffset = stickyNavRect.top + stickyNavRect.height
      setMenuTopOffset(totalOffset)
    }
  }, 10)
}}
                    </div>
                </div>
                
                <div class="feature-box">
                    <h4>3. 關鍵改進點</h4>
                    <ul>
                        <li><span class="highlight red">移除跑馬燈高度依賴</span>：不再根據跑馬燈狀態推算位置</li>
                        <li><span class="highlight green">直接測量 Sticky 元素</span>：使用瀏覽器提供的精確位置 API</li>
                        <li><span class="highlight">更快的響應時間</span>：減少延遲時間從 50ms 到 10ms</li>
                        <li><span class="highlight">更穩定的監聽</span>：增加 100ms 延遲確保 DOM 更新完成</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>🧪 測試驗證</h2>
                <p>提供專門的測試頁面來驗證無間隙對齊效果：</p>
                
                <a href="file:///Users/raychou/medusa_0525/test-no-gap-menu-alignment.html" class="test-link">
                    🎯 無間隙對齊測試頁面
                </a>
                
                <div class="feature-box">
                    <h4>測試特色</h4>
                    <ul>
                        <li><strong>視覺指示：</strong>選單頂部有紅色邊框，便於檢查對齊效果</li>
                        <li><strong>實時狀態：</strong>顯示 sticky 位置、高度、選單位置等詳細數據</li>
                        <li><strong>多場景測試：</strong>跑馬燈切換、滾動、開關選單等</li>
                        <li><strong>模擬真實環境：</strong>使用與實際專案相同的結構</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>📁 修改檔案</h2>
                <div class="feature-box">
                    <h4>主要修改</h4>
                    <div class="code-block">
/frontend/src/modules/layout/components/mobile-menu.tsx
                    </div>
                    
                    <h4>具體變更</h4>
                    <ul>
                        <li>✅ 修改 <code>calculateMenuTopOffset</code> 函數邏輯</li>
                        <li>✅ 移除跑馬燈高度的手動計算</li>
                        <li>✅ 直接使用 <code>getBoundingClientRect()</code> 測量 sticky 位置</li>
                        <li>✅ 優化 MutationObserver 的延遲處理</li>
                        <li>✅ 改進選單開啟時的位置計算邏輯</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>🌟 修正效果</h2>
                
                <div class="problem-solution">
                    <div class="problem">
                        <h3>修正前</h3>
                        <ul>
                            <li>跑馬燈隱藏時有明顯空隙</li>
                            <li>位置計算不準確</li>
                            <li>依賴推算而非實測</li>
                            <li>視覺體驗不連貫</li>
                        </ul>
                    </div>
                    
                    <div class="solution">
                        <h3>修正後</h3>
                        <ul>
                            <li>✅ 完全無間隙對齊</li>
                            <li>✅ 像素級精確定位</li>
                            <li>✅ 實時測量 sticky 位置</li>
                            <li>✅ 完美的視覺連接</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>🚀 技術亮點</h2>
                <div class="feature-box">
                    <h4>創新之處</h4>
                    <ul>
                        <li><strong>🎯 直接測量法：</strong>摒棄計算推測，直接測量元素實際位置</li>
                        <li><strong>⚡ 即時響應：</strong>DOM 變化、視窗變化、滾動等都能即時適應</li>
                        <li><strong>🔄 智能延遲：</strong>適當的延遲確保計算準確性</li>
                        <li><strong>📱 完美適配：</strong>適用於各種螢幕尺寸和設備</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>✅ 完成確認</h2>
                <div class="feature-box">
                    <h4>已解決問題</h4>
                    <ul>
                        <li>✅ 跑馬燈隱藏時的間隙問題完全解決</li>
                        <li>✅ 選單位置計算更加精確穩定</li>
                        <li>✅ 用戶體驗更加流暢連貫</li>
                        <li>✅ 響應式適應性更強</li>
                        <li>✅ 代碼邏輯更加清晰可維護</li>
                    </ul>
                    
                    <p style="margin-top: 16px; color: #15803d; font-weight: 600;">
                        🎉 手機選單現在能夠完美貼合導覽列底部，無論跑馬燈狀態如何變化！
                    </p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
