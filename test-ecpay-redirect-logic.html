<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>綠界 ECPay 跳轉邏輯測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #2196F3;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            background: #f1f8e9;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
            color: #d32f2f;
        }
        .info {
            border-left-color: #2196F3;
            background: #e3f2fd;
            color: #1976d2;
        }
        .warning {
            border-left-color: #ff9800;
            background: #fff3e0;
            color: #f57c00;
        }
        .success {
            border-left-color: #4CAF50;
            background: #f1f8e9;
            color: #388e3c;
        }
        .payment-form-container {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #2196F3;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .payment-form-container h4 {
            color: #2196F3;
            margin-top: 0;
        }
        .form-preview {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        code {
            background: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 13px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #4CAF50; }
        .status-error { background-color: #f44336; }
        .status-warning { background-color: #ff9800; }
        .status-info { background-color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 綠界 ECPay 跳轉邏輯測試工具</h1>
        
        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>📋 測試概述</h3>
            <p>基於綠界官方文件的研究結果，ECPay 的跳轉邏輯使用以下機制：</p>
            <ul>
                <li><strong>HTML 表單生成</strong>：SDK 生成包含所有參數的 HTML &lt;form&gt;</li>
                <li><strong>自動提交</strong>：使用 JavaScript <code>document.getElementById("form_id").submit()</code></li>
                <li><strong>POST 跳轉</strong>：表單自動 POST 到綠界付款頁面</li>
                <li><strong>測試參數</strong>：MerchantID: 3002607, HashKey: pwFHCqoQZGmho4w6, HashIV: EkRm7iFT261dpevs</li>
            </ul>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>🌐 環境檢查</h3>
            <button onclick="checkEnvironment()">檢查後端環境</button>
            <div id="environmentResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-warning"></span>💳 付款表單 HTML 生成測試</h3>
            <p>測試 ECPay SDK 是否能正確生成包含自動提交 JavaScript 的 HTML 表單</p>
            <button onclick="testPaymentFormGeneration()">生成付款表單 HTML</button>
            <div id="paymentFormResult" class="result" style="display: none;"></div>
            <div id="paymentFormContainer" class="payment-form-container" style="display: none;">
                <h4>📄 生成的付款表單預覽</h4>
                <div id="formPreview" class="form-preview"></div>
            </div>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-success"></span>🔍 表單結構分析</h3>
            <p>分析生成的 HTML 表單是否包含必要的跳轉元素</p>
            <button onclick="analyzeFormStructure()" disabled id="analyzeBtn">分析表單結構</button>
            <div id="analysisResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-warning"></span>🚀 模擬跳轉測試</h3>
            <p>⚠️ <strong>注意</strong>：此測試將實際跳轉到綠界測試頁面</p>
            <button onclick="simulatePaymentRedirect()" disabled id="redirectBtn">模擬付款跳轉</button>
            <div id="redirectResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let generatedHtml = '';
        let formData = {};

        // 檢查後端環境
        async function checkEnvironment() {
            const resultDiv = document.getElementById('environmentResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔄 檢查後端環境中...';

            try {
                // 檢查後端服務是否運行
                const response = await fetch('http://localhost:9000/store/ecpay/test-env', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 後端環境檢查成功

🔧 環境配置：
- 後端服務：運行正常 (Port 9000)
- 操作模式：${data.operationMode || '未知'}
- Merchant ID：${data.merchantId || '未設定'}
- Hash Key：${data.hashKey ? '已設定 (***' + data.hashKey.slice(-4) + ')' : '未設定'}
- Hash IV：${data.hashIv ? '已設定 (***' + data.hashIv.slice(-4) + ')' : '未設定'}

📊 API 端點狀態：
- ECPay 創建付款：可用
- 環境變數：${data.envStatus || '檢查中...'}`;

                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 後端環境檢查失敗

錯誤詳情：
${error.message}

請確認：
1. 後端服務是否在 Port 9000 運行
2. ECPay 環境變數是否正確設定
3. API 端點是否正常工作

建議執行：npm run dev 或 yarn dev 啟動後端服務`;
            }
        }

        // 測試付款表單生成
        async function testPaymentFormGeneration() {
            const resultDiv = document.getElementById('paymentFormResult');
            const containerDiv = document.getElementById('paymentFormContainer');
            const previewDiv = document.getElementById('formPreview');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔄 生成付款表單中...';

            try {
                const testPayment = {
                    amount: 100,
                    description: '跳轉邏輯測試訂單',
                    customerInfo: {
                        name: '測試客戶',
                        email: 'test@example.com'
                    }
                };

                const response = await fetch('http://localhost:9000/store/ecpay/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testPayment)
                });

                if (response.ok) {
                    const data = await response.json();
                    generatedHtml = data.html;
                    formData = data.paymentData || {};

                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `✅ 付款表單生成成功

📊 表單資訊：
- HTML 長度：${generatedHtml.length} 字元
- 包含 <form> 標籤：${generatedHtml.includes('<form') ? '✅ 是' : '❌ 否'}
- 包含 JavaScript：${generatedHtml.includes('<script') ? '✅ 是' : '❌ 否'}
- 包含 submit()：${generatedHtml.includes('submit()') ? '✅ 是' : '❌ 否'}
- 包含 hidden inputs：${generatedHtml.includes('type="hidden"') ? '✅ 是' : '❌ 否'}

💰 付款參數：
- 訂單編號：${formData.MerchantTradeNo || '未知'}
- 付款金額：${formData.TotalAmount || '未知'}
- 商品名稱：${formData.ItemName || '未知'}
- 付款方式：${formData.ChoosePayment || '未知'}`;

                    // 顯示表單預覽
                    containerDiv.style.display = 'block';
                    previewDiv.innerHTML = `<pre><code>${escapeHtml(generatedHtml)}</code></pre>`;

                    // 啟用分析按鈕
                    document.getElementById('analyzeBtn').disabled = false;
                    
                } else {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 付款表單生成失敗

錯誤詳情：
${error.message}

可能原因：
1. 後端 ECPay 服務配置錯誤
2. SDK 參數格式問題
3. 環境變數未正確設定
4. 網路連接問題

建議檢查後端 console 輸出以獲取詳細錯誤信息`;
                
                containerDiv.style.display = 'none';
            }
        }

        // 分析表單結構
        function analyzeFormStructure() {
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.style.display = 'block';

            if (!generatedHtml) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ 沒有可分析的表單，請先生成付款表單';
                return;
            }

            try {
                // 解析 HTML 結構
                const parser = new DOMParser();
                const doc = parser.parseFromString(generatedHtml, 'text/html');
                const form = doc.querySelector('form');
                const script = doc.querySelector('script');
                const hiddenInputs = doc.querySelectorAll('input[type="hidden"]');

                let analysis = '🔍 表單結構分析結果：\n\n';

                // 檢查表單標籤
                if (form) {
                    analysis += `✅ <form> 標籤：找到\n`;
                    analysis += `   - Action URL：${form.action || '未設定'}\n`;
                    analysis += `   - Method：${form.method || '未設定'}\n`;
                    analysis += `   - ID：${form.id || '未設定'}\n\n`;
                } else {
                    analysis += `❌ <form> 標籤：未找到\n\n`;
                }

                // 檢查隱藏輸入欄位
                analysis += `📝 隱藏輸入欄位：${hiddenInputs.length} 個\n`;
                if (hiddenInputs.length > 0) {
                    analysis += '   主要參數：\n';
                    const importantFields = ['MerchantID', 'MerchantTradeNo', 'TotalAmount', 'TradeDesc', 'ItemName', 'ChoosePayment'];
                    importantFields.forEach(field => {
                        const input = doc.querySelector(`input[name="${field}"]`);
                        if (input) {
                            analysis += `   - ${field}：${input.value}\n`;
                        } else {
                            analysis += `   - ${field}：❌ 缺失\n`;
                        }
                    });
                }
                analysis += '\n';

                // 檢查自動提交 JavaScript
                if (script) {
                    analysis += `✅ JavaScript 腳本：找到\n`;
                    const scriptContent = script.textContent || script.innerHTML;
                    if (scriptContent.includes('submit()')) {
                        analysis += `   - 包含 submit()：✅ 是\n`;
                        if (form && form.id && scriptContent.includes(form.id)) {
                            analysis += `   - 正確引用表單 ID：✅ 是 (${form.id})\n`;
                        } else {
                            analysis += `   - 正確引用表單 ID：❌ 否\n`;
                        }
                    } else {
                        analysis += `   - 包含 submit()：❌ 否\n`;
                    }
                    analysis += `   - 腳本內容：${scriptContent.trim()}\n\n`;
                } else {
                    analysis += `❌ JavaScript 腳本：未找到\n\n`;
                }

                // 跳轉邏輯評估
                analysis += `🚦 跳轉邏輯評估：\n`;
                const hasForm = !!form;
                const hasAction = form && form.action;
                const hasScript = !!script;
                const hasSubmit = script && (script.textContent || script.innerHTML).includes('submit()');
                const hasCorrectId = form && script && (script.textContent || script.innerHTML).includes(form.id);

                if (hasForm && hasAction && hasScript && hasSubmit && hasCorrectId) {
                    analysis += `✅ 跳轉邏輯完整，應該可以正常工作\n`;
                    analysis += `   建議：可以進行模擬跳轉測試\n`;
                    
                    // 啟用跳轉測試按鈕
                    document.getElementById('redirectBtn').disabled = false;
                } else {
                    analysis += `⚠️ 跳轉邏輯可能有問題：\n`;
                    if (!hasForm) analysis += `   - 缺少 <form> 標籤\n`;
                    if (!hasAction) analysis += `   - 缺少 action URL\n`;
                    if (!hasScript) analysis += `   - 缺少 JavaScript 腳本\n`;
                    if (!hasSubmit) analysis += `   - JavaScript 中缺少 submit() 調用\n`;
                    if (!hasCorrectId) analysis += `   - JavaScript 未正確引用表單 ID\n`;
                }

                resultDiv.className = hasForm && hasAction && hasScript && hasSubmit && hasCorrectId ? 'result success' : 'result warning';
                resultDiv.textContent = analysis;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 分析表單結構時發生錯誤：${error.message}`;
            }
        }

        // 模擬付款跳轉
        function simulatePaymentRedirect() {
            const resultDiv = document.getElementById('redirectResult');
            resultDiv.style.display = 'block';

            if (!generatedHtml) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ 沒有可用的表單，請先生成付款表單';
                return;
            }

            resultDiv.className = 'result warning';
            resultDiv.textContent = `⚠️ 準備跳轉到綠界測試頁面...

🔄 跳轉流程：
1. 在新視窗中插入生成的 HTML 表單
2. 自動執行 JavaScript submit()
3. 跳轉到綠界付款頁面

⏰ 3 秒後開始跳轉...`;

            setTimeout(() => {
                try {
                    // 在新視窗中插入並執行表單
                    const newWindow = window.open('', '_blank', 'width=800,height=600');
                    if (newWindow) {
                        newWindow.document.write(generatedHtml);
                        newWindow.document.close();
                        
                        resultDiv.className = 'result success';
                        resultDiv.textContent = `✅ 跳轉已執行

📱 請檢查新開啟的視窗：
- 如果成功跳轉到綠界頁面，表示跳轉邏輯正常
- 如果停留在空白頁面，可能是 JavaScript 自動提交失敗
- 如果出現錯誤頁面，可能是參數或配置問題

💡 測試提示：
- 綠界測試環境信用卡號：4311-9522-2222-2222
- 安全碼：222
- 有效期限：任何未來日期`;
                    } else {
                        throw new Error('無法開啟新視窗，可能被瀏覽器攔截');
                    }
                } catch (error) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 跳轉失敗：${error.message}

可能原因：
1. 瀏覽器阻擋彈出視窗
2. JavaScript 執行錯誤
3. 表單 HTML 格式問題

建議：
1. 允許此網站的彈出視窗
2. 檢查瀏覽器 console 是否有錯誤
3. 重新生成付款表單`;
                }
            }, 3000);
        }

        // HTML 轉義函數
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // 頁面載入時自動檢查環境
        window.addEventListener('load', () => {
            console.log('🔧 ECPay 跳轉邏輯測試工具已載入');
            console.log('📋 根據綠界官方文件，跳轉邏輯核心是：');
            console.log('   1. 生成包含所有參數的 HTML <form>');
            console.log('   2. 使用 JavaScript 自動提交：document.getElementById("form_id").submit()');
            console.log('   3. POST 方式跳轉到綠界付款頁面');
        });
    </script>
</body>
</html>
