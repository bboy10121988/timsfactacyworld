# è¨‚å–®æ‘˜è¦å„²å­˜åŠŸèƒ½å¯¦ä½œå ±å‘Š

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°
ç•¶å®¢æˆ¶å®Œæˆå®…é…è¨‚å–®æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•æ•´ç†è¨‚å–®æ‘˜è¦ä¸¦å‚³é€åˆ° `http://localhost:9000/app/orders` é€²è¡Œè¨‚å–®å„²å­˜ï¼Œæä¾›çµ¦å¤–éƒ¨ç³»çµ±é€²è¡Œå¾ŒçºŒè™•ç†ã€‚

## ğŸ“Š è¨‚å–®æ‘˜è¦è³‡æ–™çµæ§‹

### æ ¸å¿ƒè³‡æ–™æ¬„ä½
```typescript
interface OrderSummaryForStorage {
  // åŸºæœ¬è¨‚å–®è³‡è¨Š
  order_id: string              // å”¯ä¸€è¨‚å–®ç·¨è™Ÿ
  cart_id: string               // åŸå§‹è³¼ç‰©è»Šç·¨è™Ÿ  
  order_number: string          // äººé¡å¯è®€çš„è¨‚å–®ç·¨è™Ÿ
  
  // è¨‚å–®ç‹€æ…‹
  status: string                // è¨‚å–®ç‹€æ…‹ (pending, completed ç­‰)
  payment_status: string        // ä»˜æ¬¾ç‹€æ…‹ (captured, pending ç­‰)
  fulfillment_status: string    // å±¥è¡Œç‹€æ…‹ (not_fulfilled, fulfilled ç­‰)
  
  // é‡‘é¡è³‡è¨Š
  subtotal: number              // å•†å“å°è¨ˆ
  shipping_total: number        // é‹è²»
  tax_total: number             // ç¨…é¡
  total: number                 // ç¸½é‡‘é¡
  currency_code: string         // å¹£åˆ¥ä»£ç¢¼
  
  // å®¢æˆ¶è³‡è¨Š
  customer: {
    email: string               // å®¢æˆ¶ Email (å¿…å¡«)
    name?: string               // å®¢æˆ¶å§“å
    phone?: string              // å®¢æˆ¶é›»è©±
  }
  
  // é…é€è³‡è¨Š
  shipping: {
    method: string              // é…é€æ–¹å¼
    address: {                  // é…é€åœ°å€ (å¿…å¡«)
      recipient_name?: string   // æ”¶ä»¶äººå§“å
      address_line_1: string    // åœ°å€ç¬¬ä¸€è¡Œ
      address_line_2?: string   // åœ°å€ç¬¬äºŒè¡Œ
      city: string              // åŸå¸‚
      province?: string         // çœä»½/å·
      postal_code: string       // éƒµéå€è™Ÿ
      country_code: string      // åœ‹å®¶ä»£ç¢¼
      phone: string             // è¯çµ¡é›»è©±
    }
  }
  
  // å•†å“æ¸…å–®
  items: Array<{
    product_id?: string         // ç”¢å“ç·¨è™Ÿ
    variant_id?: string         // è®Šé«”ç·¨è™Ÿ
    title: string               // å•†å“åç¨±
    quantity: number            // æ•¸é‡
    unit_price: number          // å–®åƒ¹
    total_price: number         // å°è¨ˆ
    thumbnail?: string          // å•†å“åœ–ç‰‡
  }>
  
  // æ™‚é–“è³‡è¨Š
  created_at: string            // å»ºç«‹æ™‚é–“ (ISO æ ¼å¼)
  updated_at: string            // æ›´æ–°æ™‚é–“ (ISO æ ¼å¼)
  
  // ç³»çµ±è³‡è¨Š
  source: string                // ä¾†æºç³»çµ± ("medusa")
  order_type: string            // è¨‚å–®é¡å‹ ("home_delivery")
  metadata?: any                // é¡å¤–çš„å…ƒè³‡æ–™
}
```

## ğŸ”§ æŠ€è¡“å¯¦ä½œ

### 1. è¨‚å–®å®Œæˆè§¸ç™¼æ©Ÿåˆ¶
**æª”æ¡ˆ**: `/backend/src/api/store/carts/[id]/complete/route.ts`

**è§¸ç™¼æ¢ä»¶**:
```typescript
const isHomeDelivery = shippingMethod?.name?.includes('å®…é…') || 
                      shippingMethod?.name?.toLowerCase().includes('home') ||
                      (cart.metadata && (cart.metadata as any).shipping_type === 'home_delivery')
```

**è™•ç†æµç¨‹**:
1. åµæ¸¬å®…é…é…é€æ–¹å¼
2. æ•´ç†å®Œæ•´çš„è¨‚å–®æ‘˜è¦è³‡æ–™
3. ç™¼é€ HTTP POST è«‹æ±‚åˆ°å„²å­˜ç«¯é»
4. è¨˜éŒ„è™•ç†çµæœï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
5. ä¸å½±éŸ¿ä¸»è¦è¨‚å–®å®Œæˆæµç¨‹

### 2. è¨‚å–®å„²å­˜ç«¯é»
**æª”æ¡ˆ**: `/backend/src/api/app/orders/route.ts`

**åŠŸèƒ½ç‰¹é»**:
- æ¥æ”¶ä¸¦é©—è­‰è¨‚å–®æ‘˜è¦è³‡æ–™
- è¨˜éŒ„è©³ç´°çš„è™•ç†æ—¥èªŒ
- æä¾›çµæ§‹åŒ–çš„å›æ‡‰æ ¼å¼
- æ”¯æ´ GET è«‹æ±‚æŸ¥çœ‹ API æ–‡æª”

**é©—è­‰æ©Ÿåˆ¶**:
- å¿…å¡«æ¬„ä½æª¢æŸ¥ï¼š`order_id`, `customer.email`, `shipping.address`
- è³‡æ–™æ ¼å¼é©—è­‰
- éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

## ğŸš€ éƒ¨ç½²èˆ‡é…ç½®

### ç’°å¢ƒè®Šæ•¸è¨­å®š
```bash
# åœ¨ .env æª”æ¡ˆä¸­è¨­å®š (å¯é¸)
ORDER_STORAGE_URL=http://localhost:9000/app/orders
```

### HTTP Headers
ç³»çµ±æœƒè‡ªå‹•è¨­å®šä»¥ä¸‹ Headersï¼š
```
Content-Type: application/json
User-Agent: Medusa-Order-Storage/1.0
X-Order-Source: medusa-homedelivery
```

## ğŸ“‹ API è¦æ ¼

### è«‹æ±‚æ ¼å¼
```http
POST /app/orders
Content-Type: application/json

{
  "order_id": "order_xxxxx",
  "order_number": "ORD-12345",
  "total": 1675,
  "currency_code": "TWD",
  "customer": {
    "email": "customer@example.com",
    "name": "ç‹å°æ˜"
  },
  "shipping": {
    "method": "å®…é…åˆ°åºœ",
    "address": { ... }
  },
  "items": [ ... ],
  "source": "medusa",
  "order_type": "home_delivery"
}
```

### å›æ‡‰æ ¼å¼
```json
{
  "success": true,
  "message": "Order summary stored successfully",
  "data": {
    "stored_order_id": "order_xxxxx",
    "storage_id": "storage_1234567890",
    "stored_at": "2025-07-21T10:30:00.000Z",
    "status": "stored_successfully"
  },
  "processed_at": "2025-07-21T10:30:00.000Z"
}
```

## ğŸ§ª æ¸¬è©¦é©—è­‰

### 1. ä½¿ç”¨æ¸¬è©¦å·¥å…·
é–‹å•Ÿ `è¨‚å–®æ‘˜è¦å„²å­˜æ¸¬è©¦å·¥å…·.html` é€²è¡Œï¼š
- **ç«¯é»ç‹€æ…‹æª¢æ¸¬**ï¼šç¢ºèªå„²å­˜ç«¯é»é‹ä½œæ­£å¸¸
- **æ¨¡æ“¬è¨‚å–®å„²å­˜**ï¼šæ¸¬è©¦å®Œæ•´çš„è³‡æ–™å‚³é€
- **å®Œæ•´æµç¨‹æ¸¬è©¦**ï¼šå¾è³¼ç‰©è»Šåˆ°è¨‚å–®å®Œæˆçš„ç«¯åˆ°ç«¯æ¸¬è©¦

### 2. æ‰‹å‹•æ¸¬è©¦æ­¥é©Ÿ
1. åœ¨å‰ç«¯å®Œæˆä¸€å€‹å®…é…è¨‚å–®
2. æª¢æŸ¥å¾Œç«¯æ§åˆ¶å°æ—¥èªŒ
3. ç¢ºèªè¨‚å–®æ‘˜è¦å‚³é€æˆåŠŸ
4. é©—è­‰å„²å­˜ç«¯é»æ¥æ”¶åˆ°æ­£ç¢ºè³‡æ–™

### 3. æ—¥èªŒç›£æ§
**ç™¼é€ç«¯æ—¥èªŒé—œéµå­—**:
```bash
ğŸšš Detected home delivery order, sending order summary for storage...
âœ… Order summary sent successfully to storage endpoint
âš ï¸ Order storage failed
```

**æ¥æ”¶ç«¯æ—¥èªŒé—œéµå­—**:
```bash
ğŸ’¾ Order Storage Endpoint - Received order summary
ğŸ“¦ Order Summary for Storage
ğŸ’¾ Storing order summary...
âœ… Order summary stored successfully
```

## ğŸ’¼ æ¥­å‹™æ‡‰ç”¨å ´æ™¯

### 1. å€‰åº«ç®¡ç†ç³»çµ±
- è‡ªå‹•æ¥æ”¶æ–°è¨‚å–®è³‡è¨Š
- è§¸ç™¼æ€è²¨å’ŒåŒ…è£æµç¨‹
- æ›´æ–°åº«å­˜ç‹€æ…‹

### 2. å®¢æˆ¶æœå‹™ç³»çµ±
- å»ºç«‹å®¢æœæ¡ˆä¾‹
- ç™¼é€è¨‚å–®ç¢ºèªé€šçŸ¥
- è¿½è¹¤è¨‚å–®è™•ç†é€²åº¦

### 3. è²¡å‹™ç³»çµ±
- è¨˜éŒ„éŠ·å”®æ”¶å…¥
- è™•ç†ç¨…å‹™è¨ˆç®—
- ç”Ÿæˆè²¡å‹™å ±è¡¨

### 4. ç‰©æµç³»çµ±
- å®‰æ’é…é€è·¯ç·š
- é ä¼°é€é”æ™‚é–“
- è¿½è¹¤é…é€ç‹€æ…‹

## âš ï¸ æ³¨æ„äº‹é …èˆ‡æœ€ä½³å¯¦è¸

### å®‰å…¨æ€§
1. **è³‡æ–™é©—è­‰**ï¼šç¢ºä¿æ¥æ”¶çš„è³‡æ–™æ ¼å¼æ­£ç¢º
2. **èªè­‰æ©Ÿåˆ¶**ï¼šåœ¨æ­£å¼ç’°å¢ƒå»ºè­°åŠ å…¥ API èªè­‰
3. **HTTPS**ï¼šä½¿ç”¨åŠ å¯†é€£ç·šå‚³è¼¸æ•æ„Ÿè³‡æ–™

### å¯é æ€§
1. **éé˜»å¡è¨­è¨ˆ**ï¼šå„²å­˜å¤±æ•—ä¸å½±éŸ¿è¨‚å–®å®Œæˆ
2. **éŒ¯èª¤è™•ç†**ï¼šå®Œæ•´çš„ç•°å¸¸æ•ç²å’Œæ—¥èªŒè¨˜éŒ„
3. **é‡è©¦æ©Ÿåˆ¶**ï¼šå¯è€ƒæ…®åŠ å…¥å¤±æ•—é‡è©¦é‚è¼¯

### ç›£æ§
1. **æˆåŠŸç‡ç›£æ§**ï¼šè¿½è¹¤å„²å­˜æˆåŠŸç‡
2. **æ•ˆèƒ½ç›£æ§**ï¼šç›£æ§å›æ‡‰æ™‚é–“
3. **éŒ¯èª¤å‘Šè­¦**ï¼šè¨­å®šå¤±æ•—æ™‚çš„å‘Šè­¦æ©Ÿåˆ¶

## ğŸ“ æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆè·¯å¾‘ | åŠŸèƒ½æè¿° | ç‹€æ…‹ |
|---------|---------|------|
| `/backend/src/api/store/carts/[id]/complete/route.ts` | è¨‚å–®å®Œæˆé‚è¼¯ï¼Œè§¸ç™¼æ‘˜è¦å‚³é€ | âœ… å®Œæˆ |
| `/backend/src/api/app/orders/route.ts` | è¨‚å–®æ‘˜è¦æ¥æ”¶å’Œå„²å­˜ç«¯é» | âœ… å®Œæˆ |
| `è¨‚å–®æ‘˜è¦å„²å­˜æ¸¬è©¦å·¥å…·.html` | å®Œæ•´çš„æ¸¬è©¦å·¥å…· | âœ… å®Œæˆ |

## âœ… å¯¦ä½œç‹€æ…‹

- **æ ¸å¿ƒåŠŸèƒ½**: âœ… å®Œæˆ - è‡ªå‹•åµæ¸¬å®…é…è¨‚å–®ä¸¦å‚³é€æ‘˜è¦
- **è³‡æ–™çµæ§‹**: âœ… å®Œæˆ - çµæ§‹åŒ–çš„è¨‚å–®æ‘˜è¦æ ¼å¼
- **å„²å­˜ç«¯é»**: âœ… å®Œæˆ - å®Œæ•´çš„æ¥æ”¶å’Œè™•ç†é‚è¼¯
- **æ¸¬è©¦å·¥å…·**: âœ… å®Œæˆ - å…¨é¢çš„æ¸¬è©¦é©—è­‰åŠŸèƒ½
- **æ–‡æª”èªªæ˜**: âœ… å®Œæˆ - è©³ç´°çš„æŠ€è¡“å’Œä½¿ç”¨æ–‡æª”

## ğŸ”® æœªä¾†æ“´å±•å»ºè­°

1. **æ‰¹æ¬¡è™•ç†**ï¼šæ”¯æ´æ‰¹æ¬¡å‚³é€å¤šå€‹è¨‚å–®æ‘˜è¦
2. **webhook ç®¡ç†**ï¼šå»ºç«‹ webhook è¨­å®šå’Œç®¡ç†ä»‹é¢
3. **è³‡æ–™å‚™ä»½**ï¼šåŠ å…¥è¨‚å–®æ‘˜è¦çš„æœ¬åœ°å‚™ä»½æ©Ÿåˆ¶
4. **æ•ˆèƒ½å„ªåŒ–**ï¼šä½¿ç”¨è¨Šæ¯ä½‡åˆ—è™•ç†å¤§é‡è¨‚å–®
5. **å„€è¡¨æ¿**ï¼šå»ºç«‹è¨‚å–®è™•ç†ç‹€æ…‹çš„ç›£æ§å„€è¡¨æ¿

---

**å¯¦ä½œå®Œæˆæ™‚é–“**: 2025å¹´7æœˆ21æ—¥  
**åŠŸèƒ½ç‹€æ…‹**: âœ… å¯ç«‹å³æŠ•å…¥ä½¿ç”¨  
**æ¸¬è©¦å»ºè­°**: ä½¿ç”¨æä¾›çš„æ¸¬è©¦å·¥å…·é€²è¡Œå®Œæ•´é©—è­‰
